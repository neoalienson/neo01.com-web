<!DOCTYPE html><html lang="zh-TW"><head><!-- hexo injector head_begin start --><!-- Google tag (gtag.js) begins-->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3DZR3TQYCY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-3DZR3TQYCY');
    </script>
    <!-- Google tag (gtag.js) ends-->
    <!-- hexo injector head_begin end -->
    <meta charset="utf-8">
    <!-- security headers starts -->
    <!-- meta http-equiv="content-security-policy" content="script-src 'sha256-B5nfCL2Dym3Ba4YJFI7wB3f4vtClbrYJZ32A5erBEdg=' 'sha256-lJjk3/dvd+wXqRFjV7T5L/nXJXr5NjUjmsKSPEe+ass=';" -->
    <!-- security headers ends -->
    <!-- favicon starts -->    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <!-- favicon ends -->
    

    <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="alternate" href="/atom.xml" title="Decoding Digital Anomalies" type="application/atom+xml">
    

    

    

    

    

    

    

    
    
        


    
    
        


    



    
    <title>行動應用程式代碼安全：真正有效的實作模式 | Decoding Digital Anomalies</title>
    
    <meta name="keywords" content="Android,iOS,Security">
    
    
    <meta name="description" content="實作行動安全需要的不僅僅是理論。學習可以立即部署的安全儲存、混淆、執行時保護和身份驗證的實用代碼模式。">
<meta property="og:type" content="article">
<meta property="og:title" content="行動應用程式代碼安全：真正有效的實作模式">
<meta property="og:url" content="https://neo01.com/zh-TW/2021/06/Mobile-App-Code-Security-Implementation/index.html">
<meta property="og:site_name" content="Decoding Digital Anomalies">
<meta property="og:description" content="實作行動安全需要的不僅僅是理論。學習可以立即部署的安全儲存、混淆、執行時保護和身份驗證的實用代碼模式。">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2021-06-02T16:00:00.000Z">
<meta property="article:modified_time" content="2025-10-30T03:02:43.961Z">
<meta property="article:author" content="Neo Alienson">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Security">
<meta property="article:tag" content="iOS">
<meta name="twitter:card" content="summary">
    
    <!-- hexo injector head_end start --><link rel="stylesheet" type="text/css" href="/css/bundle.css"><script type="text/javascript" src="/js/bundle_first.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 8.1.0">  <link rel="canonical" href="https://neo01.com/zh-TW/2021/06/Mobile-App-Code-Security-Implementation/">
  <link rel="alternate" hreflang="en" data-canonical="true" href="https://neo01.com/2021/06/Mobile-App-Code-Security-Implementation/">
  <link rel="alternate" hreflang="zh-TW" href="https://neo01.com/zh-TW/2021/06/Mobile-App-Code-Security-Implementation/">
  <link rel="alternate" hreflang="zh-CN" href="https://neo01.com/zh-CN/2021/06/Mobile-App-Code-Security-Implementation/">
  <link rel="alternate" hreflang="ja" href="https://neo01.com/ja/2021/06/Mobile-App-Code-Security-Implementation/">
<style id="admonition-styles">.admonition {
  margin: 1em 0;
  padding: 0rem;
  border-left: 0.3rem solid;
  border-radius: 0.4rem;
  background-color: #f9f9f9;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  overflow: hidden;
  page-break-inside: avoid;
}

.admonition-title {
  display: flex;
  align-items: center;
  font-weight: 600;
  padding: 0rem 1rem 0.1rem 0.75rem;
  font-size: 1.05em;
  background-color: rgba(0, 0, 0, 0.03);
  border-top-left-radius: 0.4rem;
  border-top-right-radius: 0.4rem;
  margin: 0 !important;
}

.admonition-icon {
  font-size: 1.2em;
  margin-right: 0.6rem;
  opacity: 0.85;
  margin-top: 0.1rem;
}

/* 内容区域 margin */
.admonition > *:not(.admonition-title) {
  margin: 0.6rem 1rem 0.6rem 1rem;
}

/* NOTE 类型 */
.admonition.anote {
  border-color: #448aff;
}
.admonition.anote > .admonition-title {
  background-color: #448aff1a;
  color: #2962ff;
}

/* INFO / TODO 类型 */
.admonition.info,
.admonition.todo {
  border-color: #00b8d4;
}
.admonition.info > .admonition-title,
.admonition.todo > .admonition-title {
  background-color: rgba(0, 184, 212, 0.1);
  color: #007c91;
}

/* 警告类 */
.admonition.warning,
.admonition.attention,
.admonition.caution {
  border-color: #ff9100;
}
.admonition.warning > .admonition-title,
.admonition.attention > .admonition-title,
.admonition.caution > .admonition-title {
  background-color: rgba(255, 145, 0, 0.1);
  color: #c66900;
}

/* 错误类 */
.admonition.failure,
.admonition.missing,
.admonition.fail,
.admonition.error,
.admonition.danger,
.admonition.bug {
  border-color: #ff5252;
}
.admonition.failure > .admonition-title,
.admonition.missing > .admonition-title,
.admonition.fail > .admonition-title,
.admonition.error > .admonition-title,
.admonition.danger > .admonition-title,
.admonition.bug > .admonition-title {
  background-color: rgba(255, 82, 82, 0.1);
  color: #b71c1c;
}

/* TIP 类型 */
.admonition.tip {
  border-color: #00bfa5;
}
.admonition.tip > .admonition-title {
  background-color: #00bfa51a;
  color: #00796b;
}

/* SUCCESS 类型 */
.admonition.success {
  border-color: #00c853;
}
.admonition.success > .admonition-title {
  background-color: #00c8531a;
  color: #2e7d32;
}

/* QUESTION 类型 */
.admonition.question {
  border-color: #64dd17;
}
.admonition.question > .admonition-title {
  background-color: #64dd171a;
  color: #558b2f;
}

/* EXAMPLE 类型 */
.admonition.example {
  border-color: #7c4dff;
}
.admonition.example > .admonition-title {
  background-color: #7c4dff1a;
  color: #512da8;
}

/* QUOTE 类型 */
.admonition.quote {
  border-color: #9e9e9e;
}
.admonition.quote > .admonition-title {
  background-color: #9e9e9e1a;
  color: #424242;
}

/*黑暗模式*/
/* 夜间模式基础样式 */
[data-theme="dark"] .admonition {
  background-color: #1e1e1e;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
}

[data-theme="dark"] .admonition-title {
  background-color: rgba(255, 255, 255, 0.05);
}

/* anote */
[data-theme="dark"] .admonition.anote {
  border-color: #82b1ff;
}
[data-theme="dark"] .admonition.anote > .admonition-title {
  background-color: #82b1ff1a;
  color: #bbdefb;
}

/* tip */
[data-theme="dark"] .admonition.tip {
  border-color: #64ffda;
}
[data-theme="dark"] .admonition.tip > .admonition-title {
  background-color: #64ffda1a;
  color: #1de9b6;
}

/* success */
[data-theme="dark"] .admonition.success {
  border-color: #69f0ae;
}
[data-theme="dark"] .admonition.success > .admonition-title {
  background-color: #69f0ae1a;
  color: #00e676;
}

/* question */
[data-theme="dark"] .admonition.question {
  border-color: #b2ff59;
}
[data-theme="dark"] .admonition.question > .admonition-title {
  background-color: #b2ff591a;
  color: #aeea00;
}

/* example */
[data-theme="dark"] .admonition.example {
  border-color: #b388ff;
}
[data-theme="dark"] .admonition.example > .admonition-title {
  background-color: #b388ff1a;
  color: #b39ddb;
}

/* quote */
[data-theme="dark"] .admonition.quote {
  border-color: #bdbdbd;
}
[data-theme="dark"] .admonition.quote > .admonition-title {
  background-color: #bdbdbd1a;
  color: #eeeeee;
}

/* warning / attention / caution */
[data-theme="dark"] .admonition.warning,
[data-theme="dark"] .admonition.attention,
[data-theme="dark"] .admonition.caution {
  border-color: #ffb300;
}
[data-theme="dark"] .admonition.warning > .admonition-title,
[data-theme="dark"] .admonition.attention > .admonition-title,
[data-theme="dark"] .admonition.caution > .admonition-title {
  background-color: #ffb3001a;
  color: #ffe082;
}

/* error / fail / failure / bug / danger / missing */
[data-theme="dark"] .admonition.error,
[data-theme="dark"] .admonition.fail,
[data-theme="dark"] .admonition.failure,
[data-theme="dark"] .admonition.bug,
[data-theme="dark"] .admonition.missing,
[data-theme="dark"] .admonition.danger {
  border-color: #ef5350;
}
[data-theme="dark"] .admonition.error > .admonition-title,
[data-theme="dark"] .admonition.fail > .admonition-title,
[data-theme="dark"] .admonition.failure > .admonition-title,
[data-theme="dark"] .admonition.bug > .admonition-title,
[data-theme="dark"] .admonition.missing > .admonition-title,
[data-theme="dark"] .admonition.danger > .admonition-title {
  background-color: #ef53501a;
  color: #ff8a80;
}</style></head>

<body>
    <div id="wrap">
        
        
<header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <div class="logo"></div>
                    </h1>

                        <h2 class="subtitle-wrap">
                            <p class="title">解碼數位異象</p>
                          <p class="subtitle">有時功能就是數位兔子洞中的錯誤，反之亦然</p>
                        </h2>




                    <div id="lang-selector">
                        <span class="lang-icon">🌐</span>
                        
                            <a href="#" class="lang-link" data-lang="en">English</a>
<span class="lang-sep">|</span>                            <a href="#" class="lang-link" data-lang="zh-CN">简体中文</a>
<span class="lang-sep">|</span>                            <a href="#" class="lang-link" data-lang="ja">日本語</a>
                        <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            var currentLang = 'zh-TW';
                            var currentPath = window.location.pathname;
                            var basePath;
                            
                            if (currentLang === 'en') {
                                basePath = currentPath;
                            } else {
                                basePath = currentPath.replace(new RegExp('^/' + currentLang + '/'), '/');
                            }
                            
                            document.querySelectorAll('.lang-link').forEach(function(link) {
                                var targetLang = link.getAttribute('data-lang');
                                var targetPath;
                                if (targetLang === 'en') {
                                    targetPath = basePath;
                                } else {
                                    targetPath = '/' + targetLang + basePath;
                                }
                                link.href = targetPath;
                            });
                        });
                        </script>
                    </div>


                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/zh-TW/">首頁</a>
                                </li>
                                                                    <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/AI/">人工智慧</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/AI/Art-Gallery/">藝術畫廊</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Architecture/">架構</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Cybersecurity/">資訊安全</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Development/">開發</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Misc/">雜項</a></li></ul>
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/zh-TW/about-me">關於</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" id="search-form-input" placeholder="搜尋">
        <button type="submit" title="搜尋" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" id="ins-search-input" placeholder="輸入關鍵字...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script integrity="sha256-B5nfCL2Dym3Ba4YJFI7wB3f4vtClbrYJZ32A5erBEdg=">
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '頁面',
            CATEGORIES: '分類',
            TAGS: '標籤',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
        LANG: 'zh-TW',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>




</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

        
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Cybersecurity/">Cybersecurity</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-2021/06/Mobile-App-Code-Security-Implementation-zh-TW" class="article article-single article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner responsive-content">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        行動應用程式代碼安全：真正有效的實作模式
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
      <i class="fa fa-calendar"></i>
        
          Created <time datetime="2021-06-02T16:00:00.000Z" itemprop="datePublished">2021-06-03</time>
          &nbsp;<i class="fa fa-calendar"></i>
          Updated <time datetime="2025-10-30T03:02:43.961Z" itemprop="datePublished">2025-10-30</time>
        
    </div>


                

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/zh-TW/tags/iOS/">iOS</a> <a class="tag-link" href="/zh-TW/tags/Android/">Android</a> <a class="tag-link" href="/zh-TW/tags/Security/">Security</a>
    </div>

            </div>
        
        
        
        <div class="article-entry" itemprop="articleBody">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A4%8E%EF%BC%9A%E4%BB%A3%E7%A2%BC%E4%B8%AD%E6%B0%B8%E9%81%A0%E4%B8%8D%E6%87%89%E8%A9%B2%E5%87%BA%E7%8F%BE%E7%9A%84%E5%85%A7%E5%AE%B9"><span class="toc-text">安全基礎：代碼中永遠不應該出現的內容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%84%B2%E5%AD%98%E5%AF%A6%E4%BD%9C"><span class="toc-text">安全儲存實作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B6%B2%E8%B7%AF%E5%AE%89%E5%85%A8%E5%AF%A6%E4%BD%9C"><span class="toc-text">網路安全實作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A2%BC%E6%B7%B7%E6%B7%86%E5%AF%A6%E4%BD%9C"><span class="toc-text">代碼混淆實作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UI-%E5%AE%89%E5%85%A8%E5%AF%A6%E4%BD%9C"><span class="toc-text">UI 安全實作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%B7%E8%A1%8C%E6%99%82%E4%BF%9D%E8%AD%B7%E5%AF%A6%E4%BD%9C"><span class="toc-text">執行時保護實作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E7%89%A9%E8%AD%98%E5%88%A5%E8%BA%AB%E4%BB%BD%E9%A9%97%E8%AD%89%E5%AF%A6%E4%BD%9C"><span class="toc-text">生物識別身份驗證實作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%80%8B%E7%9C%9F%E5%AF%A6%E7%9A%84%E5%AF%A6%E4%BD%9C%E6%95%85%E4%BA%8B%EF%BC%9A%E6%B8%AC%E8%A9%A6%E6%8B%AF%E6%95%91%E7%94%9F%E7%94%A2%E7%92%B0%E5%A2%83"><span class="toc-text">一個真實的實作故事：測試拯救生產環境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%A6%E4%BD%9C%E6%AA%A2%E6%9F%A5%E6%B8%85%E5%96%AE"><span class="toc-text">實作檢查清單</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B5%90%E8%AB%96"><span class="toc-text">結論</span></a></li></ol>
            <p>安全架構提供了藍圖，但實作決定了你的行動應用程式是否真正保護使用者資料。如果代碼包含漏洞、使用弱加密或錯誤處理敏感資料，即使是完美設計的安全模型也會失敗。安全理論與安全代碼之間的差距正是大多數資料外洩發生的地方。</p>
<p>行動平台提供了強大的安全 API，但正確使用它們需要理解其細微差別。iOS Keychain 和 Android Keystore 提供硬體支援的加密，但配置錯誤的可存取性設定可能會暴露資料。憑證固定加強了網路安全，但不當的實作會在憑證輪換期間破壞應用程式。Root 檢測可以識別受損裝置，但簡單的檢查很容易被繞過。</p>
<p>本文重點關注實作——保護行動應用程式的實際代碼。我們將研究安全儲存模式、網路安全實作、代碼混淆技術、執行時保護機制和身份驗證流程。每個部分都提供了可以調整的工作代碼，以及將安全功能變成漏洞的陷阱。</p>
<h2 id="安全基礎：代碼中永遠不應該出現的內容">安全基礎：代碼中永遠不應該出現的內容</h2>
<p>在實作安全功能之前，要了解什麼永遠不應該出現在你的代碼庫中。這些錯誤很常見、容易被利用，而且完全可以避免。</p>
<h3 id="硬編碼密鑰：最大的罪過">硬編碼密鑰：最大的罪過</h3>
<p>在原始碼中硬編碼敏感資料是最常見也是最危險的安全錯誤。一旦提交到版本控制，密鑰就會永遠保留在儲存庫歷史中——即使在刪除之後。</p>
<div class="admonition error"><p class="admonition-title"><span class="mdi mdi-alert-circle-outline admonition-icon"></span>🚫 永遠不要在代碼中硬編碼這些內容</p><div class="admonition-content"><p><strong>憑證和密鑰</strong></p>
<ul>
<li>密碼和口令</li>
<li>API 金鑰和密鑰</li>
<li>私鑰和憑證</li>
<li>資料庫憑證</li>
<li>OAuth 用戶端密鑰</li>
<li>加密金鑰</li>
</ul>
<p><strong>敏感配置</strong></p>
<ul>
<li>嵌入憑證的生產伺服器 URL</li>
<li>第三方服務權杖</li>
<li>簽章金鑰</li>
<li>Webhook 密鑰</li>
<li>服務帳戶憑證</li>
</ul>
<p><strong>個人資訊</strong></p>
<ul>
<li>測試代碼中的使用者資料</li>
<li>電子郵件地址</li>
<li>電話號碼</li>
<li>任何用於測試的 PII</li>
</ul>
</div></div>
<h3 id="為什麼硬編碼密鑰很危險">為什麼硬編碼密鑰很危險</h3>
<p>原始碼不是安全儲存。開發人員共享儲存庫，CI/CD 系統存取代碼，反編譯器從二進位檔案中提取字串，版本控制無限期地保留歷史記錄。</p>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">// ❌ 永遠不要這樣做</span>
<span class="token keyword">class</span> ApiClient <span class="token punctuation">{</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> API_KEY <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"sk_live_51H7xK2eZvKYlo2C..."</span></span> <span class="token comment">// 暴露了！</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> SECRET <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"whsec_abc123..."</span></span> <span class="token comment">// 在版本控制中！</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> DB_PASSWORD <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"MyP@ssw0rd123"</span></span> <span class="token comment">// 所有開發人員都能看到！</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-swift" data-language="swift"><code class="language-swift"><span class="token comment">// ❌ 永遠不要這樣做</span>
<span class="token keyword">class</span> <span class="token class-name">Configuration</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">let</span> apiKey <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"AIzaSyD-9tSrke72PouQMnMX-a7eZSW0jkFMBWY"</span></span> <span class="token comment">// 暴露了！</span>
    <span class="token keyword">static</span> <span class="token keyword">let</span> privateKey <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"-----BEGIN PRIVATE KEY-----\nMIIE..."</span></span> <span class="token comment">// 災難！</span>
<span class="token punctuation">}</span></code></pre>
<p>任何有儲存庫存取權限的人都能看到這些密鑰。反編譯應用程式會暴露它們。攻擊者在 GitHub 上搜尋暴露的金鑰。一旦洩露，必須立即輪換密鑰——假設你發現了洩露。</p>
<h3 id="正確的方法：基於環境的配置">正確的方法：基於環境的配置</h3>
<p>密鑰屬於安全儲存，在執行時載入，永遠不要提交到版本控制。</p>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">// ✅ 從安全儲存載入</span>
<span class="token keyword">class</span> <span class="token function">ApiClient</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> secureStorage <span class="token operator">=</span> <span class="token function">SecureStorage</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    
    <span class="token keyword">fun</span> <span class="token function">getApiKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token comment">// 從加密儲存載入，而不是硬編碼</span>
        <span class="token keyword">return</span> secureStorage<span class="token punctuation">.</span><span class="token function">loadToken</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"api_key"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-swift" data-language="swift"><code class="language-swift"><span class="token comment">// ✅ 從 Keychain 載入</span>
<span class="token keyword">class</span> <span class="token class-name">Configuration</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">getApiKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">SecureStorage</span><span class="token punctuation">.</span><span class="token function">loadToken</span><span class="token punctuation">(</span>forKey<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"api_key"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="配置管理策略">配置管理策略</h3>
<p>不同類型的配置需要不同的方法：</p>
<div class="admonition tip"><p class="admonition-title"><span class="mdi mdi-lightbulb-on-outline admonition-icon"></span>🔧 配置最佳實踐</p><div class="admonition-content"><p><strong>公共配置（可以安全提交）</strong></p>
<ul>
<li>功能標誌</li>
<li>UI 配置</li>
<li>非敏感 URL</li>
<li>逾時值</li>
<li>快取大小</li>
</ul>
<p><strong>特定環境（建置時注入）</strong></p>
<ul>
<li>伺服器端點（不含憑證）</li>
<li>環境識別碼</li>
<li>除錯標誌</li>
<li>分析 ID（非敏感）</li>
</ul>
<p><strong>密鑰（僅執行時載入）</strong></p>
<ul>
<li>API 金鑰和權杖</li>
<li>加密金鑰</li>
<li>憑證</li>
<li>私鑰</li>
<li>服務密鑰</li>
</ul>
</div></div>
<h3 id="建置時密鑰注入">建置時密鑰注入</h3>
<p>對於建置時需要的密鑰，從環境變數或安全建置系統注入它們——永遠不要提交它們。</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy"><span class="token comment">// Android: build.gradle</span>
android <span class="token punctuation">{</span>
    defaultConfig <span class="token punctuation">{</span>
        <span class="token comment">// 從環境載入，而不是硬編碼</span>
        buildConfigField <span class="token interpolation-string"><span class="token string">"String"</span></span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">"API_KEY"</span></span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">"\"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">'API_KEY'</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string">''</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\""</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># iOS: 使用 xcconfig 檔案（不提交）</span>
<span class="token comment"># Config.xcconfig</span>
<span class="token constant">API_KEY</span> <span class="token operator">=</span> $<span class="token punctuation">{</span><span class="token constant">API_KEY</span><span class="token punctuation">}</span>

<span class="token comment"># .gitignore</span>
Config<span class="token punctuation">.</span>xcconfig</code></pre>
<p>提供顯示結構但不包含實際密鑰的範本檔案：</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy"><span class="token comment">// Config.template.xcconfig（已提交）</span>
<span class="token comment">// 複製到 Config.xcconfig 並填寫實際值</span>
API_KEY <span class="token operator">=</span> YOUR_API_KEY_HERE</code></pre>
<h3 id="記錄敏感資料：無聲的暴露">記錄敏感資料：無聲的暴露</h3>
<p>記錄敏感資料會將其暴露給任何有日誌存取權限的人——開發人員、支援人員、當機報告服務以及獲得裝置存取權限的攻擊者。</p>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">// ❌ 永遠不要這樣做</span>
<span class="token keyword">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>username<span class="token operator">:</span> String<span class="token punctuation">,</span> password<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Auth"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Login attempt: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">username</span></span><span class="token string"> / </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">password</span></span><span class="token string">"</span></span><span class="token punctuation">)</span> <span class="token comment">// 在日誌中暴露！</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">processPayment</span><span class="token punctuation">(</span>cardNumber<span class="token operator">:</span> String<span class="token punctuation">,</span> cvv<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Payment"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Processing card: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">cardNumber</span></span><span class="token string">, CVV: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">cvv</span></span><span class="token string">"</span></span><span class="token punctuation">)</span> <span class="token comment">// 違反 PCI！</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-swift" data-language="swift"><code class="language-swift"><span class="token comment">// ❌ 永遠不要這樣做</span>
<span class="token keyword">func</span> <span class="token function-definition function">authenticate</span><span class="token punctuation">(</span>token<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Auth token: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">token</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span> <span class="token comment">// 在主控台中可見！</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre>
<p>日誌保留在系統日誌、當機報告和分析平台中。從生產建置中刪除敏感日誌記錄：</p>
<pre class="language-proguard" data-language="proguard"><code class="language-proguard"># ProGuard: 在發布版本中刪除日誌記錄
-assumenosideeffects class android.util.Log {
    public static *** d(...);
    public static *** v(...);
    public static *** i(...);
}</code></pre>
<h3 id="版本控制衛生">版本控制衛生</h3>
<p>一旦提交，密鑰就會保留在儲存庫歷史中。預防至關重要：</p>
<div class="admonition warning"><p class="admonition-title"><span class="mdi mdi-alert-outline admonition-icon"></span>⚠️ 版本控制安全</p><div class="admonition-content"><p><strong>提交前</strong></p>
<ul>
<li>檢查差異中的密鑰</li>
<li>使用預提交鉤子掃描密鑰</li>
<li>維護配置檔案的 .gitignore</li>
<li>使用密鑰掃描工具</li>
</ul>
<p><strong>如果密鑰已提交</strong></p>
<ul>
<li>立即輪換受損密鑰</li>
<li>不要只是刪除——歷史記錄會保留它們</li>
<li>使用 BFG Repo-Cleaner 等工具清除歷史記錄</li>
<li>通知安全團隊</li>
</ul>
<p><strong>預防工具</strong></p>
<ul>
<li>git-secrets (AWS)</li>
<li>detect-secrets (Yelp)</li>
<li>GitHub 密鑰掃描</li>
<li>GitGuardian</li>
</ul>
</div></div>
<h3 id="行動應用程式中的-API-金鑰：特殊考慮">行動應用程式中的 API 金鑰：特殊考慮</h3>
<p>行動應用程式分發給可以提取任何嵌入資料的使用者。即使是混淆或加密的金鑰也可以被有決心的攻擊者提取。</p>
<div class="admonition anote"><p class="admonition-title"><span class="mdi mdi-note-outline admonition-icon"></span>🔑 行動端 API 金鑰策略</p><div class="admonition-content"><p><strong>用戶端 API 金鑰</strong></p>
<ul>
<li>假設它們會被提取</li>
<li>使用權限最小的金鑰</li>
<li>在伺服器端實作速率限制</li>
<li>監控濫用</li>
<li>定期輪換</li>
</ul>
<p><strong>伺服器端代理模式</strong></p>
<ul>
<li>將敏感金鑰保留在伺服器上</li>
<li>行動應用程式呼叫你的 API</li>
<li>你的伺服器呼叫第三方 API</li>
<li>驗證行動請求</li>
<li>在伺服器端控制存取</li>
</ul>
<p><strong>當用戶端金鑰必要時</strong></p>
<ul>
<li>使用平台特定的限制（iOS bundle ID、Android 套件名稱）</li>
<li>實作憑證固定</li>
<li>新增請求簽章</li>
<li>監控使用模式</li>
<li>準備好輪換程序</li>
</ul>
</div></div>
<p>伺服器端代理模式總是比在行動應用程式中嵌入金鑰更安全，即使使用混淆也是如此。</p>
<h2 id="安全儲存實作">安全儲存實作</h2>
<p>平台提供的安全儲存機制是你的第一道防線。當 iOS Keychain 或 Android Keystore 可用時，永遠不要實作自訂加密。</p>
<h3 id="何時使用安全儲存">何時使用安全儲存</h3>
<p>安全儲存用於執行時密鑰——通過身份驗證或 API 呼叫在應用程式安裝後獲得的資料。永遠不要使用它來隱藏不應該在應用程式中的硬編碼密鑰。</p>
<div class="admonition tip"><p class="admonition-title"><span class="mdi mdi-lightbulb-on-outline admonition-icon"></span>✅ 安全儲存的適當用途</p><div class="admonition-content"><p><strong>執行時密鑰</strong></p>
<ul>
<li>登入後收到的身份驗證權杖</li>
<li>來自伺服器的工作階段金鑰</li>
<li>使用者憑證（如果絕對必要）</li>
<li>臨時加密金鑰</li>
<li>OAuth 權杖</li>
</ul>
<p><strong>不用於建置時密鑰</strong></p>
<ul>
<li>不要在 Keychain 中儲存硬編碼的 API 金鑰</li>
<li>不要加密硬編碼的密鑰並儲存它們</li>
<li>不要使用安全儲存來隱藏不應該存在的內容</li>
<li>伺服器端密鑰永遠不應該到達用戶端</li>
</ul>
</div></div>
<h3 id="iOS-Keychain：完整實作">iOS Keychain：完整實作</h3>
<pre class="language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">Security</span>

<span class="token keyword">class</span> <span class="token class-name">SecureStorage</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">saveToken</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> token<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> forKey key<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> data <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>using<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        
        <span class="token keyword">let</span> query<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token keyword">Any</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token constant">kSecClass</span> <span class="token keyword">as</span> <span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token constant">kSecClassGenericPassword</span><span class="token punctuation">,</span>
            <span class="token constant">kSecAttrAccount</span> <span class="token keyword">as</span> <span class="token class-name">String</span><span class="token punctuation">:</span> key<span class="token punctuation">,</span>
            <span class="token constant">kSecValueData</span> <span class="token keyword">as</span> <span class="token class-name">String</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span>
            <span class="token constant">kSecAttrAccessible</span> <span class="token keyword">as</span> <span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token constant">kSecAttrAccessibleWhenUnlockedThisDeviceOnly</span>
        <span class="token punctuation">]</span>
        
        <span class="token class-name">SecItemDelete</span><span class="token punctuation">(</span>query <span class="token keyword">as</span> <span class="token class-name">CFDictionary</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token class-name">SecItemAdd</span><span class="token punctuation">(</span>query <span class="token keyword">as</span> <span class="token class-name">CFDictionary</span><span class="token punctuation">,</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> status <span class="token operator">==</span> errSecSuccess
    <span class="token punctuation">}</span>
    
    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">loadToken</span><span class="token punctuation">(</span>forKey key<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> query<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token keyword">Any</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token constant">kSecClass</span> <span class="token keyword">as</span> <span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token constant">kSecClassGenericPassword</span><span class="token punctuation">,</span>
            <span class="token constant">kSecAttrAccount</span> <span class="token keyword">as</span> <span class="token class-name">String</span><span class="token punctuation">:</span> key<span class="token punctuation">,</span>
            <span class="token constant">kSecReturnData</span> <span class="token keyword">as</span> <span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token constant">kSecMatchLimit</span> <span class="token keyword">as</span> <span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token constant">kSecMatchLimitOne</span>
        <span class="token punctuation">]</span>
        
        <span class="token keyword">var</span> result<span class="token punctuation">:</span> <span class="token class-name">AnyObject</span><span class="token operator">?</span>
        <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token class-name">SecItemCopyMatching</span><span class="token punctuation">(</span>query <span class="token keyword">as</span> <span class="token class-name">CFDictionary</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span>
        
        <span class="token keyword">guard</span> status <span class="token operator">==</span> errSecSuccess<span class="token punctuation">,</span>
              <span class="token keyword">let</span> data <span class="token operator">=</span> result <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">Data</span><span class="token punctuation">,</span>
              <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> data<span class="token punctuation">,</span> encoding<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token nil constant">nil</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> token
    <span class="token punctuation">}</span>
    
    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">deleteToken</span><span class="token punctuation">(</span>forKey key<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> query<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token keyword">Any</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token constant">kSecClass</span> <span class="token keyword">as</span> <span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token constant">kSecClassGenericPassword</span><span class="token punctuation">,</span>
            <span class="token constant">kSecAttrAccount</span> <span class="token keyword">as</span> <span class="token class-name">String</span><span class="token punctuation">:</span> key
        <span class="token punctuation">]</span>
        <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token class-name">SecItemDelete</span><span class="token punctuation">(</span>query <span class="token keyword">as</span> <span class="token class-name">CFDictionary</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> status <span class="token operator">==</span> errSecSuccess
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<div class="admonition tip"><p class="admonition-title"><span class="mdi mdi-lightbulb-on-outline admonition-icon"></span>🔑 Keychain 可存取性層級</p><div class="admonition-content"><p><strong>kSecAttrAccessibleWhenUnlockedThisDeviceOnly</strong></p>
<ul>
<li>對敏感資料最安全</li>
<li>不備份到 iCloud</li>
<li>僅在裝置解鎖時可存取</li>
</ul>
<p><strong>kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly</strong></p>
<ul>
<li>用於背景工作</li>
<li>首次解鎖後可用</li>
<li>不備份</li>
</ul>
<p><strong>kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly</strong></p>
<ul>
<li>需要裝置密碼</li>
<li>如果刪除密碼則刪除</li>
<li>最高安全性</li>
</ul>
</div></div>
<h3 id="Android-安全儲存：EncryptedSharedPreferences">Android 安全儲存：EncryptedSharedPreferences</h3>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>EncryptedSharedPreferences
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>MasterKey

<span class="token keyword">class</span> <span class="token function">SecureStorage</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> context<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">val</span> masterKey <span class="token operator">=</span> MasterKey<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setKeyScheme</span><span class="token punctuation">(</span>MasterKey<span class="token punctuation">.</span>KeyScheme<span class="token punctuation">.</span>AES256_GCM<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">private</span> <span class="token keyword">val</span> encryptedPrefs <span class="token operator">=</span> EncryptedSharedPreferences<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        <span class="token string-literal singleline"><span class="token string">"secure_prefs"</span></span><span class="token punctuation">,</span>
        masterKey<span class="token punctuation">,</span>
        EncryptedSharedPreferences<span class="token punctuation">.</span>PrefKeyEncryptionScheme<span class="token punctuation">.</span>AES256_SIV<span class="token punctuation">,</span>
        EncryptedSharedPreferences<span class="token punctuation">.</span>PrefValueEncryptionScheme<span class="token punctuation">.</span>AES256_GCM
    <span class="token punctuation">)</span>
    
    <span class="token keyword">fun</span> <span class="token function">saveToken</span><span class="token punctuation">(</span>token<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        encryptedPrefs<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"auth_token"</span></span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">fun</span> <span class="token function">loadToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> encryptedPrefs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"auth_token"</span></span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">fun</span> <span class="token function">deleteToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        encryptedPrefs<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"auth_token"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="Android-Keystore-用於加密金鑰">Android Keystore 用於加密金鑰</h3>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">import</span> android<span class="token punctuation">.</span>security<span class="token punctuation">.</span>keystore<span class="token punctuation">.</span>KeyGenParameterSpec
<span class="token keyword">import</span> android<span class="token punctuation">.</span>security<span class="token punctuation">.</span>keystore<span class="token punctuation">.</span>KeyProperties
<span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>KeyStore
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>KeyGenerator
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>SecretKey

<span class="token keyword">class</span> KeystoreManager <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">val</span> keyStore <span class="token operator">=</span> KeyStore<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"AndroidKeyStore"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span>
        <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">fun</span> <span class="token function">generateKey</span><span class="token punctuation">(</span>alias<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> SecretKey <span class="token punctuation">{</span>
        <span class="token keyword">val</span> keyGenerator <span class="token operator">=</span> KeyGenerator<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>
            KeyProperties<span class="token punctuation">.</span>KEY_ALGORITHM_AES<span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"AndroidKeyStore"</span></span>
        <span class="token punctuation">)</span>
        
        <span class="token keyword">val</span> keySpec <span class="token operator">=</span> KeyGenParameterSpec<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>
            alias<span class="token punctuation">,</span>
            KeyProperties<span class="token punctuation">.</span>PURPOSE_ENCRYPT <span class="token operator">or</span> KeyProperties<span class="token punctuation">.</span>PURPOSE_DECRYPT
        <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setBlockModes</span><span class="token punctuation">(</span>KeyProperties<span class="token punctuation">.</span>BLOCK_MODE_GCM<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setEncryptionPaddings</span><span class="token punctuation">(</span>KeyProperties<span class="token punctuation">.</span>ENCRYPTION_PADDING_NONE<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setUserAuthenticationRequired</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        keyGenerator<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span>
        <span class="token keyword">return</span> keyGenerator<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">fun</span> <span class="token function">getKey</span><span class="token punctuation">(</span>alias<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> SecretKey<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> keyStore<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>alias<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">as</span><span class="token operator">?</span> SecretKey
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<div class="admonition warning"><p class="admonition-title"><span class="mdi mdi-alert-outline admonition-icon"></span>⚠️ 儲存反模式</p><div class="admonition-content"><p><strong>永遠不要這樣做</strong></p>
<ul>
<li>在 UserDefaults/SharedPreferences 中儲存密碼</li>
<li>在代碼中硬編碼加密金鑰</li>
<li>使用弱演算法（DES、MD5、SHA1）</li>
<li>將敏感資料記錄到主控台</li>
<li>在版本控制中儲存 API 金鑰</li>
</ul>
</div></div>
<h2 id="網路安全實作">網路安全實作</h2>
<p>僅使用 HTTPS 是不夠的。適當的 TLS 配置、憑證驗證和請求簽章提供了縱深防禦。</p>
<h3 id="iOS-TLS-配置與憑證驗證">iOS TLS 配置與憑證驗證</h3>
<pre class="language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">class</span> <span class="token class-name">SecureNetworking</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">lazy</span> <span class="token keyword">var</span> session<span class="token punctuation">:</span> <span class="token class-name">URLSession</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token class-name">URLSessionConfiguration</span><span class="token punctuation">.</span><span class="token keyword">default</span>
        config<span class="token punctuation">.</span>tlsMinimumSupportedProtocolVersion <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token class-name">TLSv12</span>
        <span class="token keyword">return</span> <span class="token class-name">URLSession</span><span class="token punctuation">(</span>configuration<span class="token punctuation">:</span> config<span class="token punctuation">,</span> delegate<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span> delegateQueue<span class="token punctuation">:</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">makeRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token constant">URL</span><span class="token punctuation">,</span> completion<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token class-name">Data</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> task <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">dataTask</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> response<span class="token punctuation">,</span> error <span class="token keyword">in</span>
            <span class="token function">completion</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        task<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">extension</span> <span class="token class-name">SecureNetworking</span><span class="token punctuation">:</span> <span class="token class-name">URLSessionDelegate</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">urlSession</span><span class="token punctuation">(</span>
        <span class="token omit keyword">_</span> session<span class="token punctuation">:</span> <span class="token class-name">URLSession</span><span class="token punctuation">,</span>
        didReceive challenge<span class="token punctuation">:</span> <span class="token class-name">URLAuthenticationChallenge</span><span class="token punctuation">,</span>
        completionHandler<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token class-name">URLSession</span><span class="token punctuation">.</span><span class="token class-name">AuthChallengeDisposition</span><span class="token punctuation">,</span> <span class="token class-name">URLCredential</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">guard</span> challenge<span class="token punctuation">.</span>protectionSpace<span class="token punctuation">.</span>authenticationMethod <span class="token operator">==</span> <span class="token class-name">NSURLAuthenticationMethodServerTrust</span><span class="token punctuation">,</span>
              <span class="token keyword">let</span> serverTrust <span class="token operator">=</span> challenge<span class="token punctuation">.</span>protectionSpace<span class="token punctuation">.</span>serverTrust <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">completionHandler</span><span class="token punctuation">(</span><span class="token punctuation">.</span>cancelAuthenticationChallenge<span class="token punctuation">,</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">var</span> secResult <span class="token operator">=</span> <span class="token class-name">SecTrustResultType</span><span class="token punctuation">.</span>invalid
        <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token class-name">SecTrustEvaluate</span><span class="token punctuation">(</span>serverTrust<span class="token punctuation">,</span> <span class="token operator">&amp;</span>secResult<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> status <span class="token operator">==</span> errSecSuccess <span class="token operator">&amp;&amp;</span>
           <span class="token punctuation">(</span>secResult <span class="token operator">==</span> <span class="token punctuation">.</span>unspecified <span class="token operator">||</span> secResult <span class="token operator">==</span> <span class="token punctuation">.</span>proceed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> credential <span class="token operator">=</span> <span class="token class-name">URLCredential</span><span class="token punctuation">(</span>trust<span class="token punctuation">:</span> serverTrust<span class="token punctuation">)</span>
            <span class="token function">completionHandler</span><span class="token punctuation">(</span><span class="token punctuation">.</span>useCredential<span class="token punctuation">,</span> credential<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">completionHandler</span><span class="token punctuation">(</span><span class="token punctuation">.</span>cancelAuthenticationChallenge<span class="token punctuation">,</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="Android-網路安全配置">Android 網路安全配置</h3>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token comment"><!-- res/xml/network_security_config.xml --></span>
<span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network-security-config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base-config</span> <span class="token attr-name">cleartextTrafficPermitted</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trust-anchors</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>certificates</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>system<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trust-anchors</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>base-config</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>debug-overrides</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trust-anchors</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>certificates</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trust-anchors</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>debug-overrides</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network-security-config</span><span class="token punctuation">&gt;</span></span></code></pre>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token comment"><!-- AndroidManifest.xml --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span>
    <span class="token attr-name"><span class="token namespace">android:</span>networkSecurityConfig</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@xml/network_security_config<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">&gt;</span></span></code></pre>
<h3 id="請求簽章實作">請求簽章實作</h3>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">import</span> javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>Mac
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>SecretKeySpec
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Base64

<span class="token keyword">class</span> <span class="token function">RequestSigner</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> secretKey<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">fun</span> <span class="token function">signRequest</span><span class="token punctuation">(</span>method<span class="token operator">:</span> String<span class="token punctuation">,</span> path<span class="token operator">:</span> String<span class="token punctuation">,</span> body<span class="token operator">:</span> String<span class="token punctuation">,</span> timestamp<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
        <span class="token keyword">val</span> payload <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">method</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">path</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">body</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">timestamp</span></span><span class="token string">"</span></span>
        
        <span class="token keyword">val</span> mac <span class="token operator">=</span> Mac<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"HmacSHA256"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> keySpec <span class="token operator">=</span> <span class="token function">SecretKeySpec</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"HmacSHA256"</span></span><span class="token punctuation">)</span>
        mac<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span>
        
        <span class="token keyword">val</span> signature <span class="token operator">=</span> mac<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> Base64<span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">fun</span> <span class="token function">createHeaders</span><span class="token punctuation">(</span>method<span class="token operator">:</span> String<span class="token punctuation">,</span> path<span class="token operator">:</span> String<span class="token punctuation">,</span> body<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> timestamp <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> signature <span class="token operator">=</span> <span class="token function">signRequest</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> body<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> <span class="token function">mapOf</span><span class="token punctuation">(</span>
            <span class="token string-literal singleline"><span class="token string">"X-Timestamp"</span></span> <span class="token keyword">to</span> timestamp<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"X-Signature"</span></span> <span class="token keyword">to</span> signature
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>伺服器端驗證：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> hmac
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> time
<span class="token keyword">import</span> base64

<span class="token keyword">def</span> <span class="token function">verify_signature</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> body<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> secret_key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    current_time <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>current_time <span class="token operator">-</span> <span class="token builtin">int</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">300000</span><span class="token punctuation">:</span>  <span class="token comment"># 5 分鐘</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    
    payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>method<span class="token punctuation">}</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token punctuation">{</span>body<span class="token punctuation">}</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token punctuation">{</span>timestamp<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    expected_signature <span class="token operator">=</span> hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>
        secret_key<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        payload<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        hashlib<span class="token punctuation">.</span>sha256
    <span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> hmac<span class="token punctuation">.</span>compare_digest<span class="token punctuation">(</span>
        expected_signature<span class="token punctuation">,</span>
        base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>signature<span class="token punctuation">)</span>
    <span class="token punctuation">)</span></code></pre>
<div class="admonition error"><p class="admonition-title"><span class="mdi mdi-alert-circle-outline admonition-icon"></span>🚫 網路安全錯誤</p><div class="admonition-content"><p><strong>永遠不要停用憑證驗證</strong></p>
<ul>
<li>不要在生產環境中信任所有憑證</li>
<li>不要忽略 SSL 錯誤</li>
<li>不要允許明文 HTTP 流量</li>
</ul>
<p><strong>強制使用強 TLS</strong></p>
<ul>
<li>最低 TLS 1.2</li>
<li>避免弱密碼套件</li>
<li>使用平台安全配置</li>
</ul>
</div></div>
<h2 id="代碼混淆實作">代碼混淆實作</h2>
<p>混淆提高了逆向工程的門檻，但並非萬無一失。與伺服器端驗證結合使用。</p>
<h3 id="Android-ProGuard-配置">Android ProGuard 配置</h3>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy"><span class="token comment">// app/build.gradle</span>
android <span class="token punctuation">{</span>
    buildTypes <span class="token punctuation">{</span>
        release <span class="token punctuation">{</span>
            minifyEnabled <span class="token boolean">true</span>
            shrinkResources <span class="token boolean">true</span>
            proguardFiles <span class="token function">getDefaultProguardFile</span><span class="token punctuation">(</span><span class="token string">'proguard-android-optimize.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         <span class="token string">'proguard-rules.pro'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-proguard" data-language="proguard"><code class="language-proguard"># proguard-rules.pro

-keep class com.example.app.Application { *; }

-repackageclasses ''
-allowaccessmodification

# 刪除日誌記錄
-assumenosideeffects class android.util.Log {
    public static *** d(...);
    public static *** v(...);
    public static *** i(...);
}

-keepclasseswithmembernames class * {
    native &lt;methods&gt;;
}

-keepattributes SourceFile,LineNumberTable
-renamesourcefileattribute SourceFile</code></pre>
<h3 id="字串混淆">字串混淆</h3>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">object</span> StringObfuscator <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> KEY <span class="token operator">=</span> <span class="token number">0x5A</span>
    
    <span class="token keyword">fun</span> <span class="token function">obfuscate</span><span class="token punctuation">(</span>input<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> ByteArray <span class="token punctuation">{</span>
        <span class="token keyword">return</span> input<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">xor</span> KEY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">fun</span> <span class="token function">deobfuscate</span><span class="token punctuation">(</span>input<span class="token operator">:</span> ByteArray<span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
        <span class="token keyword">return</span> input<span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">xor</span> KEY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>Charsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> ApiConfig <span class="token punctuation">{</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> API_KEY_OBFUSCATED <span class="token operator">=</span> <span class="token function">byteArrayOf</span><span class="token punctuation">(</span>
            <span class="token number">0x3e</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0x3a</span><span class="token punctuation">,</span> <span class="token number">0x2b</span><span class="token punctuation">,</span> <span class="token number">0x3c</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span> <span class="token number">0x3e</span><span class="token punctuation">,</span> <span class="token number">0x2f</span>
        <span class="token punctuation">)</span>
        
        <span class="token keyword">fun</span> <span class="token function">getApiKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
            <span class="token keyword">return</span> StringObfuscator<span class="token punctuation">.</span><span class="token function">deobfuscate</span><span class="token punctuation">(</span>API_KEY_OBFUSCATED<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<div class="admonition tip"><p class="admonition-title"><span class="mdi mdi-lightbulb-on-outline admonition-icon"></span>🛡️ 混淆最佳實踐</p><div class="admonition-content"><p><strong>要混淆的內容</strong></p>
<ul>
<li>業務邏輯和演算法</li>
<li>API 端點和參數</li>
<li>內部類別和方法名稱</li>
</ul>
<p><strong>要保留的內容</strong></p>
<ul>
<li>公共 API 介面</li>
<li>基於反射的類別</li>
<li>原生方法宣告</li>
<li>序列化類別</li>
</ul>
<p><strong>測試</strong></p>
<ul>
<li>徹底測試發布建置</li>
<li>驗證當機報告可讀</li>
<li>使用映射檔案進行反混淆</li>
</ul>
</div></div>
<h2 id="UI-安全實作">UI 安全實作</h2>
<p>通過截圖和應用程式切換器預覽保護敏感資料免受視覺捕獲。</p>
<h3 id="Android-螢幕捕獲防護">Android 螢幕捕獲防護</h3>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>WindowManager
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatActivity

<span class="token keyword">class</span> SecureActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        
        <span class="token comment">// 防止截圖和螢幕錄製</span>
        window<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>
            WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FLAG_SECURE<span class="token punctuation">,</span>
            WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FLAG_SECURE
        <span class="token punctuation">)</span>
        
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_secure<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="iOS-截圖檢測">iOS 截圖檢測</h3>
<pre class="language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">UIKit</span>

<span class="token keyword">class</span> <span class="token class-name">SecureViewController</span><span class="token punctuation">:</span> <span class="token class-name">UIViewController</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment">// 檢測何時截圖</span>
        <span class="token class-name">NotificationCenter</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span>
            <span class="token keyword">self</span><span class="token punctuation">,</span>
            selector<span class="token punctuation">:</span> <span class="token other-directive property">#selector</span><span class="token punctuation">(</span>screenshotTaken<span class="token punctuation">)</span><span class="token punctuation">,</span>
            name<span class="token punctuation">:</span> <span class="token class-name">UIApplication</span><span class="token punctuation">.</span>userDidTakeScreenshotNotification<span class="token punctuation">,</span>
            object<span class="token punctuation">:</span> <span class="token nil constant">nil</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token attribute atrule">@objc</span> <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">screenshotTaken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 記錄事件或警告使用者</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"檢測到截圖"</span></span><span class="token punctuation">)</span>
        <span class="token comment">// 也可以暫時模糊敏感內容</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span>
        <span class="token class-name">NotificationCenter</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span><span class="token function">removeObserver</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="應用程式切換器保護-iOS">應用程式切換器保護 - iOS</h3>
<pre class="language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">import</span> <span class="token class-name">UIKit</span>

<span class="token keyword">class</span> <span class="token class-name">AppDelegate</span><span class="token punctuation">:</span> <span class="token class-name">UIResponder</span><span class="token punctuation">,</span> <span class="token class-name">UIApplicationDelegate</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">var</span> window<span class="token punctuation">:</span> <span class="token class-name">UIWindow</span><span class="token operator">?</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> blurView<span class="token punctuation">:</span> <span class="token class-name">UIVisualEffectView</span><span class="token operator">?</span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">applicationWillResignActive</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> application<span class="token punctuation">:</span> <span class="token class-name">UIApplication</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在快照前隱藏敏感內容</span>
        <span class="token function">addBlurEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">applicationDidBecomeActive</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> application<span class="token punctuation">:</span> <span class="token class-name">UIApplication</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 應用程式返回時恢復內容</span>
        <span class="token function">removeBlurEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">addBlurEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> window <span class="token operator">=</span> window<span class="token punctuation">,</span> blurView <span class="token operator">==</span> <span class="token nil constant">nil</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
        
        <span class="token keyword">let</span> blurEffect <span class="token operator">=</span> <span class="token class-name">UIBlurEffect</span><span class="token punctuation">(</span>style<span class="token punctuation">:</span> <span class="token punctuation">.</span>light<span class="token punctuation">)</span>
        <span class="token keyword">let</span> blurView <span class="token operator">=</span> <span class="token class-name">UIVisualEffectView</span><span class="token punctuation">(</span>effect<span class="token punctuation">:</span> blurEffect<span class="token punctuation">)</span>
        blurView<span class="token punctuation">.</span>frame <span class="token operator">=</span> window<span class="token punctuation">.</span>bounds
        blurView<span class="token punctuation">.</span>autoresizingMask <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>flexibleWidth<span class="token punctuation">,</span> <span class="token punctuation">.</span>flexibleHeight<span class="token punctuation">]</span>
        
        window<span class="token punctuation">.</span><span class="token function">addSubview</span><span class="token punctuation">(</span>blurView<span class="token punctuation">)</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>blurView <span class="token operator">=</span> blurView
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">removeBlurEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        blurView<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">removeFromSuperview</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        blurView <span class="token operator">=</span> <span class="token nil constant">nil</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>使用佔位符視圖的替代方法：</p>
<pre class="language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">class</span> <span class="token class-name">AppDelegate</span><span class="token punctuation">:</span> <span class="token class-name">UIResponder</span><span class="token punctuation">,</span> <span class="token class-name">UIApplicationDelegate</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">var</span> window<span class="token punctuation">:</span> <span class="token class-name">UIWindow</span><span class="token operator">?</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> coverView<span class="token punctuation">:</span> <span class="token class-name">UIView</span><span class="token operator">?</span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">applicationWillResignActive</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> application<span class="token punctuation">:</span> <span class="token class-name">UIApplication</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addCoverView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">applicationDidBecomeActive</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> application<span class="token punctuation">:</span> <span class="token class-name">UIApplication</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeCoverView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">addCoverView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> window <span class="token operator">=</span> window<span class="token punctuation">,</span> coverView <span class="token operator">==</span> <span class="token nil constant">nil</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
        
        <span class="token keyword">let</span> cover <span class="token operator">=</span> <span class="token class-name">UIView</span><span class="token punctuation">(</span>frame<span class="token punctuation">:</span> window<span class="token punctuation">.</span>bounds<span class="token punctuation">)</span>
        cover<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">.</span>white
        
        <span class="token comment">// 可選：新增應用程式 logo</span>
        <span class="token keyword">let</span> imageView <span class="token operator">=</span> <span class="token class-name">UIImageView</span><span class="token punctuation">(</span>image<span class="token punctuation">:</span> <span class="token class-name">UIImage</span><span class="token punctuation">(</span>named<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"logo"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        imageView<span class="token punctuation">.</span>contentMode <span class="token operator">=</span> <span class="token punctuation">.</span>scaleAspectFit
        imageView<span class="token punctuation">.</span>frame <span class="token operator">=</span> <span class="token class-name">CGRect</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">)</span>
        imageView<span class="token punctuation">.</span>center <span class="token operator">=</span> cover<span class="token punctuation">.</span>center
        cover<span class="token punctuation">.</span><span class="token function">addSubview</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span>
        
        window<span class="token punctuation">.</span><span class="token function">addSubview</span><span class="token punctuation">(</span>cover<span class="token punctuation">)</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>coverView <span class="token operator">=</span> cover
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">removeCoverView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        coverView<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">removeFromSuperview</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        coverView <span class="token operator">=</span> <span class="token nil constant">nil</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="應用程式切換器保護-Android">應用程式切換器保護 - Android</h3>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Activity
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle
<span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View
<span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>ImageView

<span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">var</span> coverView<span class="token operator">:</span> View<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 在應用程式切換器快照前隱藏內容</span>
        <span class="token function">showCoverView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 應用程式返回時恢復內容</span>
        <span class="token function">hideCoverView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">showCoverView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>coverView <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            coverView <span class="token operator">=</span> layoutInflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>cover_screen<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token function">addContentView</span><span class="token punctuation">(</span>
                coverView<span class="token punctuation">,</span>
                ViewGroup<span class="token punctuation">.</span><span class="token function">LayoutParams</span><span class="token punctuation">(</span>
                    ViewGroup<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>MATCH_PARENT<span class="token punctuation">,</span>
                    ViewGroup<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>MATCH_PARENT
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        coverView<span class="token operator">?</span><span class="token punctuation">.</span>visibility <span class="token operator">=</span> View<span class="token punctuation">.</span>VISIBLE
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">hideCoverView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        coverView<span class="token operator">?</span><span class="token punctuation">.</span>visibility <span class="token operator">=</span> View<span class="token punctuation">.</span>GONE
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token comment"><!-- res/layout/cover_screen.xml --></span>
<span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RelativeLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@color/white<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ImageView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_centerInParent</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@drawable/logo<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>contentDescription</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@string/app_logo<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RelativeLayout</span><span class="token punctuation">&gt;</span></span></code></pre>
<div class="admonition tip"><p class="admonition-title"><span class="mdi mdi-lightbulb-on-outline admonition-icon"></span>🛡️ UI 安全最佳實踐</p><div class="admonition-content"><p><strong>螢幕捕獲防護</strong></p>
<ul>
<li>僅對敏感活動套用 FLAG_SECURE</li>
<li>不要在所有螢幕上防止捕獲</li>
<li>考慮使用者對合法截圖的需求</li>
<li>使用螢幕錄製應用程式進行測試</li>
</ul>
<p><strong>應用程式切換器保護</strong></p>
<ul>
<li>在 onPause/willResignActive 中立即套用遮罩</li>
<li>在 onResume/didBecomeActive 中移除遮罩</li>
<li>使用簡單、快速載入的遮罩視圖</li>
<li>測試快速應用程式切換場景</li>
</ul>
<p><strong>效能考量</strong></p>
<ul>
<li>保持遮罩視圖輕量級</li>
<li>避免複雜的版面配置或動畫</li>
<li>快取遮罩視圖以供重複使用</li>
<li>在低階裝置上測試</li>
</ul>
</div></div>
<h2 id="執行時保護實作">執行時保護實作</h2>
<p>檢測受損環境並做出適當回應。</p>
<h3 id="iOS-越獄檢測">iOS 越獄檢測</h3>
<pre class="language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">class</span> <span class="token class-name">JailbreakDetector</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">isJailbroken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> jailbreakPaths <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string-literal"><span class="token string">"/Applications/Cydia.app"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal"><span class="token string">"/Library/MobileSubstrate/MobileSubstrate.dylib"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal"><span class="token string">"/bin/bash"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal"><span class="token string">"/usr/sbin/sshd"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal"><span class="token string">"/etc/apt"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal"><span class="token string">"/private/var/lib/apt/"</span></span>
        <span class="token punctuation">]</span>
        
        <span class="token keyword">for</span> path <span class="token keyword">in</span> jailbreakPaths <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token class-name">FileManager</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span><span class="token function">fileExists</span><span class="token punctuation">(</span>atPath<span class="token punctuation">:</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">let</span> testPath <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"/private/jailbreak_test.txt"</span></span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token string-literal"><span class="token string">"test"</span></span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>toFile<span class="token punctuation">:</span> testPath<span class="token punctuation">,</span> atomically<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> encoding<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span>
            <span class="token keyword">try</span> <span class="token class-name">FileManager</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span>atPath<span class="token punctuation">:</span> testPath<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
            <span class="token comment">// 無法在沙箱外寫入</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"cydia://package/com.example.package"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token class-name">UIApplication</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">canOpenURL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="Android-Root-檢測">Android Root 檢測</h3>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">RootDetector</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> context<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">fun</span> <span class="token function">isRooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">checkBuildTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
               <span class="token function">checkSuperuserApk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
               <span class="token function">checkSuBinary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
               <span class="token function">checkRootManagementApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">checkBuildTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
        <span class="token keyword">val</span> buildTags <span class="token operator">=</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">.</span>TAGS
        <span class="token keyword">return</span> buildTags <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> buildTags<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"test-keys"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">checkSuperuserApk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">try</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span>packageManager<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.noshufou.android.su"</span></span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token boolean">true</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">checkSuBinary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
        <span class="token keyword">val</span> paths <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>
            <span class="token string-literal singleline"><span class="token string">"/system/app/Superuser.apk"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"/sbin/su"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"/system/bin/su"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"/system/xbin/su"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"/data/local/xbin/su"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"/data/local/bin/su"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"/system/sd/xbin/su"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"/system/bin/failsafe/su"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"/data/local/su"</span></span>
        <span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> paths<span class="token punctuation">.</span><span class="token function">any</span> <span class="token punctuation">{</span> <span class="token function">File</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">checkRootManagementApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
        <span class="token keyword">val</span> packages <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>
            <span class="token string-literal singleline"><span class="token string">"com.topjohnwu.magisk"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"eu.chainfire.supersu"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"com.koushikdutta.superuser"</span></span>
        <span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> packages<span class="token punctuation">.</span><span class="token function">any</span> <span class="token punctuation">{</span> packageName <span class="token operator">-&gt;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                context<span class="token punctuation">.</span>packageManager<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token boolean">true</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="偵錯器檢測">偵錯器檢測</h3>
<pre class="language-swift" data-language="swift"><code class="language-swift"><span class="token comment">// iOS</span>
<span class="token keyword">func</span> <span class="token function-definition function">isDebuggerAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> info <span class="token operator">=</span> <span class="token function">kinfo_proc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> mib<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Int32</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant">CTL_KERN</span><span class="token punctuation">,</span> <span class="token constant">KERN_PROC</span><span class="token punctuation">,</span> <span class="token constant">KERN_PROC_PID</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token class-name">MemoryLayout</span><span class="token operator">&lt;</span>kinfo_proc<span class="token operator">&gt;</span><span class="token punctuation">.</span>stride
    
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">sysctl</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mib<span class="token punctuation">,</span> <span class="token class-name">UInt32</span><span class="token punctuation">(</span>mib<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">,</span> <span class="token nil constant">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>kp_proc<span class="token punctuation">.</span>p_flag <span class="token operator">&amp;</span> <span class="token constant">P_TRACED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">// Android</span>
<span class="token keyword">fun</span> <span class="token function">isDebuggerConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Debug<span class="token punctuation">.</span><span class="token function">isDebuggerConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> Debug<span class="token punctuation">.</span><span class="token function">waitingForDebugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">isDebuggable</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">and</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_DEBUGGABLE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
<span class="token punctuation">}</span></code></pre>
<div class="admonition anote"><p class="admonition-title"><span class="mdi mdi-note-outline admonition-icon"></span>🔍 回應策略</p><div class="admonition-content"><p><strong>優雅降級</strong></p>
<ul>
<li>停用敏感功能</li>
<li>向使用者顯示警告</li>
<li>限制功能</li>
</ul>
<p><strong>靜默監控</strong></p>
<ul>
<li>記錄到分析</li>
<li>伺服器端風險評分</li>
<li>模式檢測</li>
</ul>
<p><strong>硬阻止</strong></p>
<ul>
<li>拒絕執行</li>
<li>僅限高安全性應用程式</li>
<li>向使用者清楚解釋</li>
</ul>
</div></div>
<h2 id="生物識別身份驗證實作">生物識別身份驗證實作</h2>
<pre class="language-swift" data-language="swift"><code class="language-swift"><span class="token comment">// iOS Face ID / Touch ID</span>
<span class="token keyword">import</span> <span class="token class-name">LocalAuthentication</span>

<span class="token keyword">class</span> <span class="token class-name">BiometricAuth</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">authenticate</span><span class="token punctuation">(</span>completion<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token class-name">Bool</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token class-name">LAContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> error<span class="token punctuation">:</span> <span class="token class-name">NSError</span><span class="token operator">?</span>
        
        <span class="token keyword">guard</span> context<span class="token punctuation">.</span><span class="token function">canEvaluatePolicy</span><span class="token punctuation">(</span><span class="token punctuation">.</span>deviceOwnerAuthenticationWithBiometrics<span class="token punctuation">,</span> error<span class="token punctuation">:</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">completion</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        
        context<span class="token punctuation">.</span><span class="token function">evaluatePolicy</span><span class="token punctuation">(</span>
            <span class="token punctuation">.</span>deviceOwnerAuthenticationWithBiometrics<span class="token punctuation">,</span>
            localizedReason<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"驗證以存取您的帳戶"</span></span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span> success<span class="token punctuation">,</span> error <span class="token keyword">in</span>
            <span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
                <span class="token function">completion</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> error<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">// Android 生物識別</span>
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>biometric<span class="token punctuation">.</span>BiometricPrompt
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>content<span class="token punctuation">.</span>ContextCompat
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span>FragmentActivity

<span class="token keyword">class</span> <span class="token function">BiometricAuth</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> activity<span class="token operator">:</span> FragmentActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">fun</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>
        onSuccess<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">,</span>
        onError<span class="token operator">:</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> executor <span class="token operator">=</span> ContextCompat<span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span>
        
        <span class="token keyword">val</span> biometricPrompt <span class="token operator">=</span> <span class="token function">BiometricPrompt</span><span class="token punctuation">(</span>
            activity<span class="token punctuation">,</span>
            executor<span class="token punctuation">,</span>
            <span class="token keyword">object</span> <span class="token operator">:</span> BiometricPrompt<span class="token punctuation">.</span><span class="token function">AuthenticationCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onAuthenticationSucceeded</span><span class="token punctuation">(</span>
                    result<span class="token operator">:</span> BiometricPrompt<span class="token punctuation">.</span>AuthenticationResult
                <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                
                <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onAuthenticationError</span><span class="token punctuation">(</span>errorCode<span class="token operator">:</span> Int<span class="token punctuation">,</span> errString<span class="token operator">:</span> CharSequence<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">onError</span><span class="token punctuation">(</span>errString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                
                <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onAuthenticationFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">onError</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"身份驗證失敗"</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
        
        <span class="token keyword">val</span> promptInfo <span class="token operator">=</span> BiometricPrompt<span class="token punctuation">.</span>PromptInfo<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"生物識別身份驗證"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSubtitle</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"驗證以存取您的帳戶"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setNegativeButtonText</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"取消"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        biometricPrompt<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>promptInfo<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="一個真實的實作故事：測試拯救生產環境">一個真實的實作故事：測試拯救生產環境</h2>
<p>在憑證輪換期間，我們的測試團隊報告了失敗，但將其視為「憑證固定太難測試」而忽略了。他們在 UAT 中停用了固定，因為這使他們的工作流程變得複雜。在生產發布前兩小時，我親自進行了調查。</p>
<p>新憑證使用萬用字元通用名稱（<code>*.example.com</code>）而不是特定網域（<code>api.example.com</code>）。我們的固定邏輯將確切的 CN 對應到公鑰——萬用字元不符合。如果部署，每個行動使用者都會失去連線。</p>
<div class="admonition error"><p class="admonition-title"><span class="mdi mdi-alert-circle-outline admonition-icon"></span>🚫 UAT 固定差距</p><div class="admonition-content"><p><strong>他們為什麼停用固定</strong></p>
<ul>
<li>「太難測試」</li>
<li>UAT 中頻繁的憑證變更</li>
<li>自簽憑證</li>
<li>「我們會在生產監控中發現問題」</li>
</ul>
<p><strong>危險的後果</strong></p>
<ul>
<li>UAT 沒有驗證任何關於固定的內容</li>
<li>所有固定問題都會出現在生產環境中</li>
<li>「成功」測試帶來的虛假信心</li>
<li>使用者會遇到測試從未發現的失敗</li>
</ul>
</div></div>
<p>我在剩餘一小時時叫停了發布。我們獲得了具有正確 CN 格式的憑證，進行了徹底測試，並在幾天後成功部署。</p>
<div class="admonition success"><p class="admonition-title"><span class="mdi mdi-check-circle-outline admonition-icon"></span>✅ 經驗教訓</p><div class="admonition-content"><p><strong>永遠不要在 UAT 中停用固定</strong></p>
<ul>
<li>如果生產環境有固定，UAT 也必須有</li>
<li>「太難測試」意味著在生產環境中發現</li>
<li>UAT 必須鏡像生產行為</li>
<li>接受營運負擔是必要的</li>
</ul>
<p><strong>永遠不要忽視測試失敗</strong></p>
<ul>
<li>調查每個失敗的根本原因</li>
<li>不要假設「在生產環境中會正常運作」</li>
<li>憑證固定失敗是訊號</li>
</ul>
<p><strong>為彈性而設計</strong></p>
<ul>
<li>CN 到固定的對應允許金鑰輪換</li>
<li>可以在不更新應用程式的情況下更新金鑰</li>
<li>平衡安全性與營運現實</li>
</ul>
</div></div>
<p>啟用固定測試的困難不是錯誤——它是你的早期警告系統。接受營運負擔作為適當安全驗證的代價。</p>
<h2 id="實作檢查清單">實作檢查清單</h2>
<p>在將安全代碼部署到生產環境之前：</p>
<div class="admonition tip"><p class="admonition-title"><span class="mdi mdi-lightbulb-on-outline admonition-icon"></span>✅ 部署前驗證</p><div class="admonition-content"><p><strong>安全儲存</strong></p>
<ul>
<li>使用平台 API（Keychain/Keystore）</li>
<li>正確的可存取性設定</li>
<li>日誌中沒有敏感資料</li>
<li>配置了備份排除</li>
</ul>
<p><strong>網路安全</strong></p>
<ul>
<li>強制使用 TLS 1.2+</li>
<li>啟用憑證驗證</li>
<li>不允許明文流量</li>
<li>實作請求簽章</li>
</ul>
<p><strong>代碼保護</strong></p>
<ul>
<li>為發布版本啟用 ProGuard/R8</li>
<li>混淆敏感字串</li>
<li>從發布建置中刪除日誌記錄</li>
<li>歸檔映射檔案</li>
</ul>
<p><strong>執行時保護</strong></p>
<ul>
<li>實作 Root/越獄檢測</li>
<li>適當的回應策略</li>
<li>偵錯器檢測就位</li>
<li>測試優雅降級</li>
</ul>
<p><strong>測試</strong></p>
<ul>
<li>在真實裝置上測試</li>
<li>驗證多個作業系統版本</li>
<li>測試失敗場景</li>
<li>在所有環境中啟用安全功能</li>
</ul>
</div></div>
<h2 id="結論">結論</h2>
<p>安全實作是理論與現實相遇的地方。iOS Keychain 和 Android Keystore 等平台提供的 API 提供了優於任何自訂實作的硬體支援加密。網路安全需要適當的 TLS 配置、憑證驗證和請求簽章——僅使用 HTTPS 是不夠的。代碼混淆提高了逆向工程的門檻，但必須與伺服器端驗證結合使用。執行時保護檢測受損環境，允許適當的回應。</p>
<p>安全設計與安全代碼之間的差距是發生資料外洩的地方。配置錯誤的 Keychain 可存取性會暴露資料。在生產環境中停用憑證驗證允許中間人攻擊。弱混淆提供虛假信心。簡單的 root 檢測很容易被繞過。每個實作細節都很重要。</p>
<p>測試安全實作是不可協商的。在多個作業系統版本的真實裝置上測試。測試失敗場景——當 Keychain 存取失敗、憑證無效、裝置被 root 時會發生什麼？在理想條件下運作但在邊緣情況下失敗的安全性提供了虛假信心。永遠不要因為「太難」而在測試環境中停用安全功能——這種困難是你的早期警告系統。</p>
<p>憑證輪換事件證明了適當測試的重要性。因為使測試複雜化而在 UAT 中停用固定意味著第一次真正的測試將在生產環境中進行。只有維護一個啟用固定的單獨暫存環境才能發現問題。啟用安全功能進行測試的營運負擔遠小於生產中斷的成本。</p>
<p>平台安全 API 不斷演進，發現漏洞，攻擊技術不斷進步。隨時了解安全更新，監控你使用的函式庫的公告，並定期審查實作。昨天的最佳實踐可能是今天的漏洞。行動安全是一個持續的過程，而不是一次性的實作。</p>
<p>在部署安全代碼之前，了解你要防禦的威脅以及實作是否真正提供保護。並非每個應用程式都需要 root 檢測或代碼混淆。將安全投資與你的風險狀況相符合。在新增進階保護之前，專注於基礎——安全儲存、適當的 TLS、強身份驗證。</p>
<p>裝置可能在使用者的口袋裡，但安全責任仍然是你的。仔細實作，徹底測試，永遠不要為了方便而走捷徑損害安全性。</p>
<!-- commentbox plugin begins -->
    <div class="commentbox"></div>
    <script src="https://unpkg.com/commentbox.io/dist/commentBox.min.js"></script>
    <script>commentBox('5765834504929280-proj')</script>
    <!-- commentbox plugin ends -->
    
        </div>
        
        <footer class="article-footer">
            
    <a data-url="https://neo01.com/zh-TW/2021/06/Mobile-App-Code-Security-Implementation/" data-id="66e5d88c" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url').replace("http://","https://"),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    <!--script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
            "@type": "Person",
            "name": "Neo Alienson"
        },
        "headline": "行動應用程式代碼安全：真正有效的實作模式",
        "image": "https://neo01.com",
        "keywords": "Android Security iOS",
        "genre": "Cybersecurity",
        "datePublished": "2021-06-03",
        "dateCreated": "2021-06-03",
        "dateModified": "2025-10-30",
        "url": "https://neo01.com//zh-TW/2021/06/Mobile-App-Code-Security-Implementation/",
        "description": "實作行動安全需要的不僅僅是理論。學習可以立即部署的安全儲存、混淆、執行時保護和身份驗證的實用代碼模式。",
        "wordCount": 10313
    }
</script-->

</article>

                        </div>
                    </section>
                    
<aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>追蹤 :</p>
        <ul class="social-links">
                <li>
                    <a class="social-tooltip" title="stack-exchange" href="https://stackexchange.com/users/2122053/neo?tab=accounts" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-stack-exchange"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="stack-overflow" href="https://stackoverflow.com/users/1885105/neo" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-stack-overflow"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/neoalienson" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-github"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="linkedin" href="https://linkedin.com/in/neo01" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-linkedin"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="rss" href="/atom.xml" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
        </ul>
    </div>
    <div class="widgets-container">

        
            
                
                <div class="widget-wrap widget-list">
    <h3 class="widget-title">連結</h3>
    <div class="widget">
        <ul><li><a href="/zh-TW/ai">AI 遊樂場</a></li><li><a href="/zh-TW/tools">工具</a></li><li><a href="/zh-TW/games">遊戲</a></li><li><a href="/zh-TW/pages/useful-information">實用資訊</a></li><li><a href="/zh-TW/pages/Hexo-Blogging-Cheatsheet">Hexo 部落格速查表</a></li></ul>
    </div>
</div>

                
            
                
                
                
            
                
                    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/10/Enabling-i18n-in-Hexo/" class="thumbnail">
        <span style="background-image:url(/assets/hexo/thumbnail.png)" alt="在 Hexo 中啟用 i18n：多語言部落格完整指南" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" style="cursor: default; pointer-events: none;">開發</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/10/Enabling-i18n-in-Hexo/" class="title">在 Hexo 中啟用 i18n：多語言部落格完整指南</a></p>
                            <p class="item-date"><time datetime="2025-10-29T16:00:00.000Z" itemprop="datePublished">2025-10-30</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/10/How-I-Use-AI-to-Learn/" class="thumbnail">
        <span style="background-image:url(/assets/learning/thumbnail_80.png)" alt="我如何使用 AI 學習：透過迭代知識建構的個人旅程" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" style="cursor: default; pointer-events: none;">人工智慧</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/10/How-I-Use-AI-to-Learn/" class="title">我如何使用 AI 學習：透過迭代知識建構的個人旅程</a></p>
                            <p class="item-date"><time datetime="2025-10-18T16:00:00.000Z" itemprop="datePublished">2025-10-19</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/10/Tools-Games-And-Browser-Built-In-AI/" class="thumbnail">
        <span style="background-image:url(/2025/10/Tools-Games-And-Browser-Built-In-AI/thumbnail.jpeg)" alt="工具、遊戲與瀏覽器內建 AI 遊樂場" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" style="cursor: default; pointer-events: none;">人工智慧</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/10/Tools-Games-And-Browser-Built-In-AI/" class="title">工具、遊戲與瀏覽器內建 AI 遊樂場</a></p>
                            <p class="item-date"><time datetime="2025-10-01T16:00:00.000Z" itemprop="datePublished">2025-10-02</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/09/The_Rise_of_Agentic_Coding_AI_Powered_Software_Engineering/" class="thumbnail">
        <span style="background-image:url(/2025/09/The_Rise_of_Agentic_Coding_AI_Powered_Software_Engineering/thumbnail.jpeg)" alt="代理式編碼的崛起：AI 驅動的軟體工程" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" style="cursor: default; pointer-events: none;">人工智慧</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/09/The_Rise_of_Agentic_Coding_AI_Powered_Software_Engineering/" class="title">代理式編碼的崛起：AI 驅動的軟體工程</a></p>
                            <p class="item-date"><time datetime="2025-09-19T16:00:00.000Z" itemprop="datePublished">2025-09-20</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/08/Understanding_Ephemeral_Ports_Part2/" class="thumbnail">
        <span style="background-image:url(/assets/ports/thumbnail.png)" alt="理解臨時埠 Part 2：為什麼伺服器應用程式應避免使用動態埠" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" style="cursor: default; pointer-events: none;">開發</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/08/Understanding_Ephemeral_Ports_Part2/" class="title">理解臨時埠 Part 2：為什麼伺服器應用程式應避免使用動態埠</a></p>
                            <p class="item-date"><time datetime="2025-08-30T16:00:00.000Z" itemprop="datePublished">2025-08-31</time></p>
                        </div>
                    </li>
            </ul>
        </div>
    </div>

                
            
                
                
    
    
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">所有文章</h3>
        <div class="widget">
            <ul class="archive-list">
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2025/">2025</a>
                    <span class="archive-list-count">73</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2024/">2024</a>
                    <span class="archive-list-count">25</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2023/">2023</a>
                    <span class="archive-list-count">16</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2022/">2022</a>
                    <span class="archive-list-count">18</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2021/">2021</a>
                    <span class="archive-list-count">14</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2020/">2020</a>
                    <span class="archive-list-count">13</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2019/">2019</a>
                    <span class="archive-list-count">12</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2018/">2018</a>
                    <span class="archive-list-count">2</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2017/">2017</a>
                    <span class="archive-list-count">5</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2016/">2016</a>
                    <span class="archive-list-count">4</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2015/">2015</a>
                    <span class="archive-list-count">6</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2014/">2014</a>
                    <span class="archive-list-count">7</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2013/">2013</a>
                    <span class="archive-list-count">2</span>
                </li>
            
            </ul>
        </div>
    </div>


                
            
        

    </div>
</aside>


                </div>
            </div>
        </div>
        
<footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>

            <div class="qrcode-share-wrapper">
                <div class="qrcode-text">https://neo01.com/l#b0de4d1f</div>
                <img src="/qr/qr-13c78826394f915da1d63f1033e76cab.svg" width="200" height="200" alt="QR Code for https://neo01.com/l#b0de4d1f">
            </div>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" title="Homepage" class="logo"></a>
                </h1>
                
                <p>© 2025 Neo Alienson. 版權所有.
                  <a href="/zh-TW/terms-and-conditions">使用條款</a></p>
                
            </div>
            <div class="footer-plugins">
              


            </div>
        </div>
    </div>
</footer>

        
        
    
        


        


        


        


        


        


        


        


        


    



<!-- Custom Scripts -->




        
    </div>
<!-- hexo injector body_end start --><script type="text/javascript" src="/js/bundle_last.js"></script><!-- hexo injector body_end end -->

<script>CookieConsent.run({"palette":{"popup":{"background":"#000"},"button":{"background":"#f1d600"}},"guiOptions":{"consentModal":{"layout":"box","position":"bottom right","equalWeightButtons":true,"flipButtons":false},"preferencesModal":{"layout":"box","position":"right","equalWeightButtons":false,"flipButtons":false}},"categories":{"necessary":{"readOnly":true},"functionality":{},"analytics":{}},"language":{"default":"en","autoDetect":"browser","translations":{"en":{"consentModal":{"title":"Hello traveler, it's cookie time!","description":"🍪 This site uses cookies to serve you the best experience—no crumbs left behind! Want to know what cookies really are? Check out this easy-to-understand cookie explanation. And for the legal nitty-gritty, here’s our website cookie policy to keep you in the loop! 🚀\n","acceptAllBtn":"Accept all","acceptNecessaryBtn":"Reject all","showPreferencesBtn":"Manage preferences","footer":"<a href=\"#link\">Privacy Policy</a>\n<a href=\"/terms-and-conditions/\">Terms and conditions</a>\n"},"preferencesModal":{"title":"Consent Preferences Center","acceptAllBtn":"Accept all","acceptNecessaryBtn":"Reject all","savePreferencesBtn":"Save preferences","closeIconLabel":"Close modal","serviceCounterLabel":"Service|Services","sections":[{"title":"Cookie Usage","description":"We use cookies to make your visit smoother, faster, and tailored just for you. Cookies help us remember your preferences, improve site performance, and deliver personalized content while keeping things secure and user-friendly.\n"},{"title":"Strictly Necessary Cookies <span class=\"pm__badge\">Always Enabled</span>","description":"These cookies are essential for the website to function properly. They enable core features like security, page navigation, and access to secure areas. Without these, the site cannot operate correctly.\n","linkedCategory":"necessary"},{"title":"Functionality Cookies","description":"Functionality cookies remember your choices to provide a more personalized experience. For example, they save your language preference or login details so you don’t have to keep entering them each time.\n","linkedCategory":"functionality"},{"title":"Analytics Cookies","description":"Analytics cookies help us understand how visitors interact with our site by collecting information anonymously. This insight allows us to improve functionality, fix issues, and make the website better for you.\n","linkedCategory":"analytics"},{"title":"More information","description":"Please refer to our <a href='/pages/cookie-policy'>cookie policy</a> for full details on how we use cookies and your options to manage them.\n"}]}}}}})</script></body></html>