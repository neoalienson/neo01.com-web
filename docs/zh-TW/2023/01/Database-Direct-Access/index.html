<!DOCTYPE html><html lang="zh-TW"><head><!-- hexo injector head_begin start --><!-- Google tag (gtag.js) begins-->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3DZR3TQYCY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-3DZR3TQYCY');
    </script>
    <!-- Google tag (gtag.js) ends-->
    <!-- hexo injector head_begin end -->
    <meta charset="utf-8">
    <!-- security headers starts -->
    <!-- meta http-equiv="content-security-policy" content="script-src 'sha256-B5nfCL2Dym3Ba4YJFI7wB3f4vtClbrYJZ32A5erBEdg=' 'sha256-lJjk3/dvd+wXqRFjV7T5L/nXJXr5NjUjmsKSPEe+ass=';" -->
    <!-- security headers ends -->
    <!-- favicon starts -->    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <!-- favicon ends -->
    

    
    <title>企業中資料庫是否應允許應用程式直接連接？ | Decoding Digital Anomalies</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="keywords" content="Enterprise,Architecture,Security,Database">
    
    
    <meta name="description" content="多個應用程式直接連接到你的資料庫——方便還是災難？探索為什麼企業架構師會爭論這個基本設計決策。">
<meta property="og:type" content="article">
<meta property="og:title" content="企業中資料庫是否應允許應用程式直接連接？">
<meta property="og:url" content="https://neo01.com/zh-TW/2023/01/Database-Direct-Access/index.html">
<meta property="og:site_name" content="Decoding Digital Anomalies">
<meta property="og:description" content="多個應用程式直接連接到你的資料庫——方便還是災難？探索為什麼企業架構師會爭論這個基本設計決策。">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://neo01.com/zh-TW/2023/01/Database-Direct-Access/thumbnail.png">
<meta property="article:published_time" content="2023-01-19T16:00:00.000Z">
<meta property="article:modified_time" content="2025-10-12T11:07:44.937Z">
<meta property="article:author" content="Neo Alienson">
<meta property="article:tag" content="Enterprise">
<meta property="article:tag" content="Architecture">
<meta property="article:tag" content="Security">
<meta property="article:tag" content="Database">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://neo01.com/zh-TW/2023/01/Database-Direct-Access/thumbnail.png">
    
    

    
        <link rel="alternate" href="/atom.xml" title="Decoding Digital Anomalies" type="application/atom+xml">
    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/titillium-web/styles.css">


    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/prism-line-numbers.css">

    
<link rel="stylesheet" href="/css/prism.min.css">


    


    


    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    


<!-- hexo injector head_end start --><script type="text/javascript" src="/js/bundle_first.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="stylesheet" type="text/css" href="/cache/cookieconsent.css"><style id="admonition-styles">.admonition {
  margin: 1em 0;
  padding: 0rem;
  border-left: 0.3rem solid;
  border-radius: 0.4rem;
  background-color: #f9f9f9;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  overflow: hidden;
  page-break-inside: avoid;
}

.admonition-title {
  display: flex;
  align-items: center;
  font-weight: 600;
  padding: 0rem 1rem 0.1rem 0.75rem;
  font-size: 1.05em;
  background-color: rgba(0, 0, 0, 0.03);
  border-top-left-radius: 0.4rem;
  border-top-right-radius: 0.4rem;
  margin: 0 !important;
}

.admonition-icon {
  font-size: 1.2em;
  margin-right: 0.6rem;
  opacity: 0.85;
  margin-top: 0.1rem;
}

/* 内容区域 margin */
.admonition > *:not(.admonition-title) {
  margin: 0.6rem 1rem 0.6rem 1rem;
}

/* NOTE 类型 */
.admonition.anote {
  border-color: #448aff;
}
.admonition.anote > .admonition-title {
  background-color: #448aff1a;
  color: #2962ff;
}

/* INFO / TODO 类型 */
.admonition.info,
.admonition.todo {
  border-color: #00b8d4;
}
.admonition.info > .admonition-title,
.admonition.todo > .admonition-title {
  background-color: rgba(0, 184, 212, 0.1);
  color: #007c91;
}

/* 警告类 */
.admonition.warning,
.admonition.attention,
.admonition.caution {
  border-color: #ff9100;
}
.admonition.warning > .admonition-title,
.admonition.attention > .admonition-title,
.admonition.caution > .admonition-title {
  background-color: rgba(255, 145, 0, 0.1);
  color: #c66900;
}

/* 错误类 */
.admonition.failure,
.admonition.missing,
.admonition.fail,
.admonition.error,
.admonition.danger,
.admonition.bug {
  border-color: #ff5252;
}
.admonition.failure > .admonition-title,
.admonition.missing > .admonition-title,
.admonition.fail > .admonition-title,
.admonition.error > .admonition-title,
.admonition.danger > .admonition-title,
.admonition.bug > .admonition-title {
  background-color: rgba(255, 82, 82, 0.1);
  color: #b71c1c;
}

/* TIP 类型 */
.admonition.tip {
  border-color: #00bfa5;
}
.admonition.tip > .admonition-title {
  background-color: #00bfa51a;
  color: #00796b;
}

/* SUCCESS 类型 */
.admonition.success {
  border-color: #00c853;
}
.admonition.success > .admonition-title {
  background-color: #00c8531a;
  color: #2e7d32;
}

/* QUESTION 类型 */
.admonition.question {
  border-color: #64dd17;
}
.admonition.question > .admonition-title {
  background-color: #64dd171a;
  color: #558b2f;
}

/* EXAMPLE 类型 */
.admonition.example {
  border-color: #7c4dff;
}
.admonition.example > .admonition-title {
  background-color: #7c4dff1a;
  color: #512da8;
}

/* QUOTE 类型 */
.admonition.quote {
  border-color: #9e9e9e;
}
.admonition.quote > .admonition-title {
  background-color: #9e9e9e1a;
  color: #424242;
}

/*黑暗模式*/
/* 夜间模式基础样式 */
[data-theme="dark"] .admonition {
  background-color: #1e1e1e;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
}

[data-theme="dark"] .admonition-title {
  background-color: rgba(255, 255, 255, 0.05);
}

/* anote */
[data-theme="dark"] .admonition.anote {
  border-color: #82b1ff;
}
[data-theme="dark"] .admonition.anote > .admonition-title {
  background-color: #82b1ff1a;
  color: #bbdefb;
}

/* tip */
[data-theme="dark"] .admonition.tip {
  border-color: #64ffda;
}
[data-theme="dark"] .admonition.tip > .admonition-title {
  background-color: #64ffda1a;
  color: #1de9b6;
}

/* success */
[data-theme="dark"] .admonition.success {
  border-color: #69f0ae;
}
[data-theme="dark"] .admonition.success > .admonition-title {
  background-color: #69f0ae1a;
  color: #00e676;
}

/* question */
[data-theme="dark"] .admonition.question {
  border-color: #b2ff59;
}
[data-theme="dark"] .admonition.question > .admonition-title {
  background-color: #b2ff591a;
  color: #aeea00;
}

/* example */
[data-theme="dark"] .admonition.example {
  border-color: #b388ff;
}
[data-theme="dark"] .admonition.example > .admonition-title {
  background-color: #b388ff1a;
  color: #b39ddb;
}

/* quote */
[data-theme="dark"] .admonition.quote {
  border-color: #bdbdbd;
}
[data-theme="dark"] .admonition.quote > .admonition-title {
  background-color: #bdbdbd1a;
  color: #eeeeee;
}

/* warning / attention / caution */
[data-theme="dark"] .admonition.warning,
[data-theme="dark"] .admonition.attention,
[data-theme="dark"] .admonition.caution {
  border-color: #ffb300;
}
[data-theme="dark"] .admonition.warning > .admonition-title,
[data-theme="dark"] .admonition.attention > .admonition-title,
[data-theme="dark"] .admonition.caution > .admonition-title {
  background-color: #ffb3001a;
  color: #ffe082;
}

/* error / fail / failure / bug / danger / missing */
[data-theme="dark"] .admonition.error,
[data-theme="dark"] .admonition.fail,
[data-theme="dark"] .admonition.failure,
[data-theme="dark"] .admonition.bug,
[data-theme="dark"] .admonition.missing,
[data-theme="dark"] .admonition.danger {
  border-color: #ef5350;
}
[data-theme="dark"] .admonition.error > .admonition-title,
[data-theme="dark"] .admonition.fail > .admonition-title,
[data-theme="dark"] .admonition.failure > .admonition-title,
[data-theme="dark"] .admonition.bug > .admonition-title,
[data-theme="dark"] .admonition.missing > .admonition-title,
[data-theme="dark"] .admonition.danger > .admonition-title {
  background-color: #ef53501a;
  color: #ff8a80;
}</style><script id="mermaid-scripts" src="/cache/mermaid.min.local.js"></script>
<script>mermaid.initialize({theme: 'default'});</script></head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" title="Homepage" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                          
                            <p class="title">解碼數位異象</p>
                          
                          <p class="subtitle">有時功能就是數位兔子洞中的錯誤，反之亦然</p>
                        </h2>
                    
                    <div id="lang-selector">
                        <span class="lang-icon">🌐</span>
                        
                        
                            
                            
                            <a href="/2023/01/Database-Direct-Access/" class="lang-link">English</a>
                        
                            
                            <span class="lang-sep">|</span>
                            <a href="/zh-CN/2023/01/Database-Direct-Access/" class="lang-link">简体中文</a>
                        
                    </div>
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/zh-TW/">首頁</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/AI/">人工智慧</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/AI/Art-Gallery/">藝術畫廊</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Architecture/">架構</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Cybersecurity/">資訊安全</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Development/">開發</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-TW/categories/Misc/">雜項</a></li></ul>
                                    
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/zh-TW/about-me">關於</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" id="search-form-input" placeholder="搜尋">
        <button type="submit" title="搜尋" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" id="ins-search-input" placeholder="輸入關鍵字...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script integrity="sha256-B5nfCL2Dym3Ba4YJFI7wB3f4vtClbrYJZ32A5erBEdg=">
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '頁面',
            CATEGORIES: '分類',
            TAGS: '標籤',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
        LANG: 'zh-TW',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>




</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Architecture/">Architecture</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-2023/01/Database-Direct-Access-zh-TW" class="article article-single article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner responsive-content">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        企業中資料庫是否應允許應用程式直接連接？
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
      <i class="fa fa-calendar"></i>
        
          Created <time datetime="2023-01-19T16:00:00.000Z" itemprop="datePublished">2023-01-20</time>
          &nbsp;<i class="fa fa-calendar"></i>
          Updated <time datetime="2025-10-12T11:07:44.937Z" itemprop="datePublished">2025-10-12</time>
        
    </div>


                

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/zh-TW/tags/Enterprise/">Enterprise</a> <a class="tag-link" href="/zh-TW/tags/Architecture/">Architecture</a> <a class="tag-link" href="/zh-TW/tags/Security/">Security</a> <a class="tag-link" href="/zh-TW/tags/Database/">Database</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%8F%E9%A1%8C"><span class="toc-text">問題</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E7%9B%B4%E6%8E%A5%E8%B3%87%E6%96%99%E5%BA%AB%E5%AD%98%E5%8F%96%E7%9A%84%E7%90%86%E7%94%B1"><span class="toc-text">支持直接資料庫存取的理由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%B0%8D%E7%9B%B4%E6%8E%A5%E8%B3%87%E6%96%99%E5%BA%AB%E5%AD%98%E5%8F%96%E7%9A%84%E7%90%86%E7%94%B1"><span class="toc-text">反對直接資料庫存取的理由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%81%E6%A5%AD%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%A1%88%EF%BC%9AAPI-%E5%B1%A4"><span class="toc-text">企業解決方案：API 層</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B7%E5%90%88%E6%96%B9%E6%B3%95%EF%BC%9A%E4%BD%95%E6%99%82%E6%B7%B7%E5%90%88%E4%BD%BF%E7%94%A8"><span class="toc-text">混合方法：何時混合使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%BA%E7%AD%96%E6%A1%86%E6%9E%B6"><span class="toc-text">決策框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AF%A6%E8%B8%90"><span class="toc-text">最佳實踐</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B5%90%E8%AB%96"><span class="toc-text">結論</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B3%87%E6%BA%90"><span class="toc-text">資源</span></a></li></ol>
            <p><img src="/2023/01/Database-Direct-Access/banner.png" alt=""></p>
<p>你的 CRM 需要客戶資料。你的分析儀表板需要相同的資料。你的行動應用程式也需要它。資料庫擁有一切。為什麼不讓它們全部直接連接？</p>
<p>這似乎合乎邏輯。但在企業架構中，這個簡單的決定可能會成就或破壞你系統的可擴展性、安全性和可維護性。</p>
<h2 id="問題">問題</h2>
<p><strong>在企業環境中，多個應用程式是否應該直接連接到資料庫？</strong></p>
<p>簡短回答：<strong>視情況而定——但通常不應該。</strong></p>
<p>詳細回答：讓我們探討兩方面。</p>
<h2 id="支持直接資料庫存取的理由">支持直接資料庫存取的理由</h2>
<h3 id="優勢">優勢</h3>
<p><strong>1. 簡單性</strong></p>
<div class="mermaid">flowchart LR
    App1["📱 行動應用程式"] --&gt; DB[("🗄️ 資料庫")]
    App2["💻 Web 應用程式"] --&gt; DB
    App3["📊 分析"] --&gt; DB
    
    style DB fill:#e3f2fd</div>
<ul>
<li>更少的移動部件</li>
<li>無需維護中介軟體</li>
<li>直接的開發</li>
<li>快速原型製作</li>
</ul>
<p><strong>2. 效能</strong></p>
<p>直接連接消除了中間層：</p>
<pre class="language-none"><code class="language-none">直接：應用程式 → 資料庫（1 跳）
API 層：應用程式 → API → 資料庫（2 跳）</code></pre>
<ul>
<li>更低的延遲</li>
<li>更少的網路呼叫</li>
<li>無序列化開銷</li>
</ul>
<p><strong>3. 即時資料</strong></p>
<p>應用程式總是看到最新的資料：</p>
<ul>
<li>無快取失效問題</li>
<li>無同步延遲</li>
<li>立即一致性</li>
</ul>
<p><strong>4. 開發速度</strong></p>
<p>開發人員可以：</p>
<ul>
<li>查詢他們需要的確切內容</li>
<li>快速迭代</li>
<li>直接使用資料庫功能（預存程序、觸發器）</li>
</ul>
<h3 id="何時有意義">何時有意義</h3>
<p><strong>小型組織：</strong></p>
<ul>
<li>2-3 個應用程式</li>
<li>單一開發團隊</li>
<li>低流量</li>
<li>預算緊張</li>
</ul>
<p><strong>內部工具：</strong></p>
<ul>
<li>管理儀表板</li>
<li>報表工具</li>
<li>資料分析腳本</li>
<li>一次性工具</li>
</ul>
<p><strong>原型：</strong></p>
<ul>
<li>MVP 開發</li>
<li>概念驗證</li>
<li>快速實驗</li>
</ul>
<h2 id="反對直接資料庫存取的理由">反對直接資料庫存取的理由</h2>
<h3 id="問題-2">問題</h3>
<h4 id="1-安全噩夢">1. 安全噩夢</h4>
<p>**問題：**每個應用程式都需要資料庫憑證。</p>
<div class="mermaid">flowchart TD
    subgraph "安全風險"
        App1["📱 行動應用程式<br>(程式碼中的資料庫憑證)"]
        App2["💻 Web 應用程式<br>(配置中的資料庫憑證)"]
        App3["📊 分析<br>(暴露的資料庫憑證)"]
        App4["🔧 管理工具<br>(完整資料庫存取)"]
    end
    
    App1 --&gt; DB[("🗄️ 資料庫<br>⚠️ 單點妥協")]
    App2 --&gt; DB
    App3 --&gt; DB
    App4 --&gt; DB
    
    style DB fill:#ffebee</div>
<p><strong>風險：</strong></p>
<ul>
<li>**憑證擴散：**多個程式碼庫中的密碼</li>
<li>**行動應用程式：**可以從 APK/IPA 提取憑證</li>
<li>**第三方存取：**難以撤銷特定應用程式存取</li>
<li>**稽核噩夢：**無法追蹤哪個應用程式進行了哪個查詢</li>
</ul>
<p><strong>真實世界範例：</strong></p>
<pre class="language-none"><code class="language-none">行動應用程式反編譯 → 提取資料庫密碼
→ 攻擊者擁有完整資料庫存取權限
→ 所有客戶資料被洩露</code></pre>
<h4 id="2-緊密耦合">2. 緊密耦合</h4>
<p>**問題：**應用程式直接依賴資料庫架構。</p>
<p><strong>架構變更影響：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 重新命名欄位</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> users <span class="token keyword">RENAME</span> <span class="token keyword">COLUMN</span> email <span class="token keyword">TO</span> email_address<span class="token punctuation">;</span></code></pre>
<p><strong>結果：</strong></p>
<ul>
<li>❌ 行動應用程式中斷</li>
<li>❌ Web 應用程式中斷</li>
<li>❌ 分析中斷</li>
<li>❌ 管理工具中斷</li>
<li>❌ 所有都需要同時更新</li>
</ul>
<p><strong>部署噩夢：</strong></p>
<pre class="language-none"><code class="language-none">資料庫遷移 → 必須同時部署所有應用程式
→ 需要協調停機時間
→ 失敗風險高</code></pre>
<h4 id="3-無業務邏輯層">3. 無業務邏輯層</h4>
<p>**問題：**業務規則分散在各個應用程式中。</p>
<p><strong>範例：折扣計算</strong></p>
<pre class="language-none"><code class="language-none">行動應用程式：10% 折扣邏輯
Web 應用程式：15% 折扣邏輯（過時）
分析：無折扣邏輯（錯誤報表）</code></pre>
<p><strong>後果：</strong></p>
<ul>
<li>不一致的行為</li>
<li>重複的程式碼</li>
<li>難以維護</li>
<li>難以稽核</li>
</ul>
<p><strong>預存程序如何？</strong></p>
<p>有些人認為：「將業務邏輯放在預存程序中——問題解決！」</p>
<p><strong>預存程序方法：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 資料庫中的集中式折扣邏輯</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> calculate_order_total<span class="token punctuation">(</span>
  <span class="token operator">IN</span> user_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token operator">IN</span> order_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token keyword">OUT</span> final_total <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">DECLARE</span> base_total <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">DECLARE</span> discount <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">DECLARE</span> is_premium <span class="token keyword">BOOLEAN</span><span class="token punctuation">;</span>
  
  <span class="token keyword">SELECT</span> total <span class="token keyword">INTO</span> base_total <span class="token keyword">FROM</span> orders <span class="token keyword">WHERE</span> id <span class="token operator">=</span> order_id<span class="token punctuation">;</span>
  <span class="token keyword">SELECT</span> premium <span class="token keyword">INTO</span> is_premium <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> id <span class="token operator">=</span> user_id<span class="token punctuation">;</span>
  
  <span class="token keyword">IF</span> is_premium <span class="token keyword">THEN</span>
    <span class="token keyword">SET</span> discount <span class="token operator">=</span> base_total <span class="token operator">*</span> <span class="token number">0.15</span><span class="token punctuation">;</span>
  <span class="token keyword">ELSEIF</span> base_total <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token keyword">THEN</span>
    <span class="token keyword">SET</span> discount <span class="token operator">=</span> base_total <span class="token operator">*</span> <span class="token number">0.10</span><span class="token punctuation">;</span>
  <span class="token keyword">ELSE</span>
    <span class="token keyword">SET</span> discount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
  
  <span class="token keyword">SET</span> final_total <span class="token operator">=</span> base_total <span class="token operator">-</span> discount<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span></code></pre>
<p><strong>優勢：</strong></p>
<ul>
<li>✅ 邏輯集中在一個地方</li>
<li>✅ 所有應用程式使用相同的計算</li>
<li>✅ 保證一致的行為</li>
<li>✅ 效能（在資料附近執行）</li>
</ul>
<p><strong>但嚴重的缺點：</strong></p>
<p><strong>1. 有限的語言功能：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- SQL/PL-SQL 不是為複雜邏輯設計的</span>
<span class="token comment">-- 沒有現代語言功能：</span>
<span class="token comment">-- - 無依賴注入</span>
<span class="token comment">-- - 有限的錯誤處理</span>
<span class="token comment">-- - 無單元測試框架</span>
<span class="token comment">-- - 無 IDE 支援（與 Java/Python/Node.js 相比）</span></code></pre>
<p><strong>2. 難以測試：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 應用程式程式碼 - 易於測試</span>
<span class="token keyword">function</span> <span class="token function">calculateDiscount</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>isPremium<span class="token punctuation">)</span> <span class="token keyword">return</span> order<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token number">0.15</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> order<span class="token punctuation">.</span>total <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token operator">?</span> order<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token number">0.10</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 單元測試</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'premium user gets 15% discount'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">isPremium</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> order <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">calculateDiscount</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 預存程序 - 難以測試</span>
<span class="token comment">-- 需要資料庫連接</span>
<span class="token comment">-- 需要測試資料設置</span>
<span class="token comment">-- 測試執行緩慢</span>
<span class="token comment">-- 無模擬/存根</span></code></pre>
<p><strong>3. 供應商鎖定：</strong></p>
<pre class="language-none"><code class="language-none">Oracle PL/SQL ≠ SQL Server T-SQL ≠ PostgreSQL PL/pgSQL

-- 遷移資料庫意味著重寫所有程序
-- 不同的語法、功能、限制</code></pre>
<p><strong>4. 部署複雜性：</strong></p>
<pre class="language-none"><code class="language-none">應用程式部署：
- Git 提交 → CI/CD → 部署 → 回滾容易

預存程序部署：
- 手動 SQL 腳本
- 版本控制困難
- 回滾有風險
- 無法與應用程式程式碼原子部署</code></pre>
<p><strong>5. 有限的可觀察性：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 應用程式程式碼 - 完整的可觀察性</span>
<span class="token keyword">function</span> <span class="token function">processOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'Processing order'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">orderId</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> discount <span class="token operator">=</span> <span class="token function">calculateDiscount</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Discount calculated'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> discount <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  metrics<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">'orders.processed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">applyDiscount</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> discount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 預存程序 - 有限的可觀察性</span>
<span class="token comment">-- 難以添加日誌</span>
<span class="token comment">-- 難以添加指標</span>
<span class="token comment">-- 難以追蹤執行</span>
<span class="token comment">-- 難以在生產環境中除錯</span></code></pre>
<p><strong>6. 團隊技能：</strong></p>
<pre class="language-none"><code class="language-none">大多數開發人員知道：JavaScript、Python、Java、Go
較少開發人員知道：PL/SQL、T-SQL、PL/pgSQL

→ 更難招聘
→ 更難維護
→ 知識孤島</code></pre>
<p><strong>何時預存程序有意義：</strong></p>
<p>✅ <strong>資料密集型操作：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 批量資料處理</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> archive_old_orders<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> orders_archive 
  <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> orders <span class="token keyword">WHERE</span> created_at <span class="token operator">&lt;</span> DATE_SUB<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token number">1</span> <span class="token keyword">YEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> orders <span class="token keyword">WHERE</span> created_at <span class="token operator">&lt;</span> DATE_SUB<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token number">1</span> <span class="token keyword">YEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span></code></pre>
<p>✅ <strong>效能關鍵查詢：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 複雜聚合在資料庫中更好</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_sales_report<span class="token punctuation">(</span><span class="token operator">IN</span> start_date <span class="token keyword">DATE</span><span class="token punctuation">,</span> <span class="token operator">IN</span> end_date <span class="token keyword">DATE</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">SELECT</span> 
    <span class="token keyword">DATE</span><span class="token punctuation">(</span>created_at<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">date</span><span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> order_count<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span> <span class="token keyword">as</span> revenue<span class="token punctuation">,</span>
    <span class="token function">AVG</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span> <span class="token keyword">as</span> avg_order_value
  <span class="token keyword">FROM</span> orders
  <span class="token keyword">WHERE</span> created_at <span class="token operator">BETWEEN</span> start_date <span class="token operator">AND</span> end_date
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">DATE</span><span class="token punctuation">(</span>created_at<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span></code></pre>
<p>✅ <strong>遺留系統：</strong></p>
<ul>
<li>已經大量投資於預存程序</li>
<li>遷移成本太高</li>
<li>團隊在資料庫程式設計方面的專業知識</li>
</ul>
<p><strong>現代替代方案：精簡預存程序</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 預存程序僅用於資料存取</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_user_orders<span class="token punctuation">(</span><span class="token operator">IN</span> user_id <span class="token keyword">INT</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> orders <span class="token keyword">WHERE</span> user_id <span class="token operator">=</span> user_id<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span></code></pre>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 應用程式中的業務邏輯</span>
<span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">calculateTotal</span><span class="token punctuation">(</span><span class="token parameter">userId<span class="token punctuation">,</span> orderId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> orders <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">db</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get_user_orders'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">db</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get_user'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 業務邏輯在這裡 - 可測試、可維護</span>
    <span class="token keyword">const</span> discount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateDiscount</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyDiscount</span><span class="token punctuation">(</span>orders<span class="token punctuation">,</span> discount<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>預存程序的結論：</strong></p>
<p>預存程序可以集中邏輯，但它們：</p>
<ul>
<li>❌ 不能解決直接存取問題</li>
<li>❌ 創造新的維護挑戰</li>
<li>❌ 限制技術選擇</li>
<li>⚠️ 應謹慎用於資料密集型操作</li>
<li>✅ 更好：將業務邏輯保留在應用程式層</li>
</ul>
<h4 id="4-效能瓶頸">4. 效能瓶頸</h4>
<p>**問題：**資料庫變得不堪重負。</p>
<p><strong>連接限制：</strong></p>
<pre class="language-none"><code class="language-none">PostgreSQL 預設：100 個連接
MySQL 預設：151 個連接

10 個應用程式 × 每個 20 個連接 = 200 個連接
→ 資料庫拒絕新連接
→ 應用程式崩潰</code></pre>
<p><strong>查詢混亂：</strong></p>
<pre class="language-none"><code class="language-none">應用程式 1：SELECT * FROM orders（全表掃描）
應用程式 2：跨 5 個表的複雜 JOIN
應用程式 3：未優化的查詢（缺少索引）
→ 資料庫 CPU 達到 100%
→ 所有應用程式變慢</code></pre>
<h4 id="5-無存取控制">5. 無存取控制</h4>
<p>**問題：**應用程式擁有太多存取權限。</p>
<p><strong>典型設置：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 所有應用程式使用相同的使用者</span>
<span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token keyword">database</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'app_user'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span></code></pre>
<p><strong>風險：</strong></p>
<ul>
<li>分析工具可以刪除資料</li>
<li>行動應用程式可以刪除表</li>
<li>無最小權限原則</li>
<li>意外資料遺失</li>
</ul>
<h4 id="6-難以監控">6. 難以監控</h4>
<p>**問題：**無法追蹤應用程式行為。</p>
<p><strong>你無法回答的問題：</strong></p>
<ul>
<li>哪個應用程式導致慢查詢？</li>
<li>哪個應用程式發出最多請求？</li>
<li>哪個應用程式存取了敏感資料？</li>
<li>哪個應用程式導致了中斷？</li>
</ul>
<h2 id="企業解決方案：API-層">企業解決方案：API 層</h2>
<h3 id="架構模式">架構模式</h3>
<p>在資料庫前放置 API 層有兩種主要模式：</p>
<h4 id="模式-1：單體-API-層">模式 1：單體 API 層</h4>
<div class="mermaid">flowchart TD
    subgraph Apps["應用程式"]
        App1["📱 行動應用程式"]
        App2["💻 Web 應用程式"]
        App3["📊 分析"]
    end
    
    subgraph API["API 層"]
        Auth["🔐 身份驗證"]
        BL["⚙️ 業務邏輯"]
        Cache["💾 快取"]
        RateLimit["🚦 速率限制"]
    end
    
    Apps --&gt; Auth
    Auth --&gt; BL
    BL --&gt; Cache
    Cache --&gt; DB[("🗄️ 資料庫")]
    
    style API fill:#e8f5e9
    style DB fill:#e3f2fd</div>
<p><strong>特徵：</strong></p>
<ul>
<li>單一 API 服務</li>
<li>一個資料庫（或共享資料庫）</li>
<li>集中式業務邏輯</li>
<li>簡單開始</li>
</ul>
<h4 id="模式-2：微服務（每服務一個資料庫）">模式 2：微服務（每服務一個資料庫）</h4>
<div class="mermaid">flowchart TD
    subgraph Apps["應用程式"]
        App1["📱 行動應用程式"]
        App2["💻 Web 應用程式"]
    end
    
    subgraph Gateway["API 閘道"]
        GW["🚪 閘道<br>(路由)"]
    end
    
    subgraph Services["微服務"]
        UserSvc["👤 使用者服務"]
        OrderSvc["📦 訂單服務"]
        ProductSvc["🏷️ 產品服務"]
    end
    
    subgraph Databases["資料庫"]
        UserDB[("👤 使用者資料庫")]
        OrderDB[("📦 訂單資料庫")]
        ProductDB[("🏷️ 產品資料庫")]
    end
    
    Apps --&gt; GW
    GW --&gt; UserSvc
    GW --&gt; OrderSvc
    GW --&gt; ProductSvc
    
    UserSvc --&gt; UserDB
    OrderSvc --&gt; OrderDB
    ProductSvc --&gt; ProductDB
    
    style Gateway fill:#fff3e0
    style Services fill:#e8f5e9
    style Databases fill:#e3f2fd</div>
<p><strong>特徵：</strong></p>
<ul>
<li>多個獨立服務</li>
<li>每個服務擁有自己的資料庫</li>
<li>分散式業務邏輯</li>
<li>複雜但可擴展</li>
</ul>
<h3 id="微服務模式：深入探討">微服務模式：深入探討</h3>
<p><strong>核心原則：每服務一個資料庫</strong></p>
<pre class="language-none"><code class="language-none">❌ 反模式：共享資料庫
使用者服務 ──┐
             ├──&gt; 共享資料庫
訂單服務 ───┘

問題：
- 透過架構緊密耦合
- 無法獨立部署
- 架構變更破壞多個服務

✅ 模式：每服務一個資料庫
使用者服務 ──&gt; 使用者資料庫
訂單服務 ──&gt; 訂單資料庫

優勢：
- 鬆散耦合
- 獨立部署
- 技術多樣性</code></pre>
<p>由於篇幅限制，我將繼續創建文件的其餘部分。</p>
<p><strong>範例實作：</strong></p>
<p><strong>使用者服務：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// user-service/api.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用者服務擁有使用者資料庫</span>
<span class="token keyword">const</span> userDB <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./db/user-db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/users/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userDB<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/users'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userDB<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>訂單服務：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// order-service/api.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 訂單服務擁有訂單資料庫</span>
<span class="token keyword">const</span> orderDB <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./db/order-db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/orders/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> order <span class="token operator">=</span> <span class="token keyword">await</span> orderDB<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 需要使用者資料？呼叫使用者服務 API</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://user-service:3001/api/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>order<span class="token punctuation">.</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>order<span class="token punctuation">,</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/orders'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> order <span class="token operator">=</span> <span class="token keyword">await</span> orderDB<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3002</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>API 閘道：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// api-gateway/gateway.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createProxyMiddleware <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http-proxy-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 路由到適當的服務</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/users'</span><span class="token punctuation">,</span> <span class="token function">createProxyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://user-service:3001'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/orders'</span><span class="token punctuation">,</span> <span class="token function">createProxyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://order-service:3002'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/products'</span><span class="token punctuation">,</span> <span class="token function">createProxyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://product-service:3003'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>微服務模式的優勢：</strong></p>
<p><strong>1. 獨立擴展：</strong></p>
<pre class="language-none"><code class="language-none">使用者服務：2 個實例（低流量）
訂單服務：10 個實例（高流量）
產品服務：3 個實例（中等流量）

每個根據自己的需求擴展</code></pre>
<p><strong>2. 技術多樣性：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 使用者服務 - Node.js + PostgreSQL</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Pool <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pool</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">'users'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 訂單服務 - Python + MongoDB</span>
<span class="token keyword">from</span> pymongo <span class="token keyword">import</span> MongoClient
client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/'</span><span class="token punctuation">)</span>
db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">'orders'</span><span class="token punctuation">]</span></code></pre>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// 產品服務 - Java + MySQL</span>
<span class="token class-name">DataSource</span> ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ds<span class="token punctuation">.</span><span class="token function">setURL</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/products"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>3. 獨立部署：</strong></p>
<pre class="language-none"><code class="language-none">部署使用者服務 v2.0
→ 只有使用者服務重啟
→ 訂單服務繼續運行
→ 產品服務繼續運行
→ 無需協調部署</code></pre>
<p><strong>4. 故障隔離：</strong></p>
<pre class="language-none"><code class="language-none">訂單服務崩潰
→ 使用者仍可登入（使用者服務）
→ 使用者可瀏覽產品（產品服務）
→ 只有訂購功能中斷
→ 部分系統可用性</code></pre>
<p><strong>微服務模式的挑戰：</strong></p>
<p><strong>1. 資料一致性：</strong></p>
<p>**問題：**無分散式交易</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ❌ 無法跨服務執行此操作</span>
<span class="token constant">BEGIN</span> <span class="token constant">TRANSACTION</span><span class="token punctuation">;</span>
  <span class="token constant">INSERT</span> <span class="token constant">INTO</span> <span class="token function">users</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Alice'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">INSERT</span> <span class="token constant">INTO</span> <span class="token function">orders</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> total<span class="token punctuation">)</span> <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">COMMIT</span><span class="token punctuation">;</span>

<span class="token comment">// 使用者服務和訂單服務有獨立的資料庫</span></code></pre>
<p><strong>解決方案：Saga 模式</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 基於編排的 saga</span>
<span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token parameter">userId<span class="token punctuation">,</span> items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 步驟 1：建立訂單</span>
    <span class="token keyword">const</span> order <span class="token operator">=</span> <span class="token keyword">await</span> orderDB<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> userId<span class="token punctuation">,</span> items<span class="token punctuation">,</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'pending'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 步驟 2：發布事件</span>
    <span class="token keyword">await</span> eventBus<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'OrderCreated'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">orderId</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> items <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 監聽來自其他服務的事件</span>
  <span class="token keyword">async</span> <span class="token function">onPaymentFailed</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 補償交易</span>
    <span class="token keyword">await</span> orderDB<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>orderId<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'cancelled'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">PaymentService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">onOrderCreated</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">chargeCustomer</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> event<span class="token punctuation">.</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> eventBus<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'PaymentSucceeded'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">orderId</span><span class="token operator">:</span> event<span class="token punctuation">.</span>orderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> eventBus<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'PaymentFailed'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">orderId</span><span class="token operator">:</span> event<span class="token punctuation">.</span>orderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>2. 資料重複：</strong></p>
<p>**問題：**服務需要來自其他服務的資料</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 訂單服務需要使用者電子郵件進行通知</span>
<span class="token comment">// 但使用者服務擁有使用者資料</span>

<span class="token comment">// ❌ 不好：每次訂單都查詢使用者服務</span>
<span class="token keyword">const</span> order <span class="token operator">=</span> <span class="token keyword">await</span> orderDB<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://user-service/api/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>order<span class="token punctuation">.</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> <span class="token function">sendEmail</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>email<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 慢，創造耦合</span>

<span class="token comment">// ✅ 好：在訂單服務中快取使用者資料</span>
<span class="token keyword">const</span> order <span class="token operator">=</span> <span class="token keyword">await</span> orderDB<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> userCache <span class="token operator">=</span> <span class="token keyword">await</span> orderDB<span class="token punctuation">.</span><span class="token function">getUserCache</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> <span class="token function">sendEmail</span><span class="token punctuation">(</span>userCache<span class="token punctuation">.</span>email<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 快，但資料可能過時</span></code></pre>
<p><strong>解決方案：事件驅動的資料複製</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 使用者服務發布事件</span>
<span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token parameter">userId<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> userDB<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 發布事件</span>
    <span class="token keyword">await</span> eventBus<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'UserUpdated'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      userId<span class="token punctuation">,</span>
      <span class="token literal-property property">email</span><span class="token operator">:</span> data<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> data<span class="token punctuation">.</span>name
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 訂單服務監聽並快取</span>
<span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">onUserUpdated</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新本地快取</span>
    <span class="token keyword">await</span> orderDB<span class="token punctuation">.</span><span class="token function">updateUserCache</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">email</span><span class="token operator">:</span> event<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> event<span class="token punctuation">.</span>name
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>3. 分散式查詢：</strong></p>
<p>**問題：**無法跨服務 JOIN</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- ❌ 無法使用微服務執行此操作</span>
<span class="token keyword">SELECT</span> 
  u<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
  o<span class="token punctuation">.</span>total<span class="token punctuation">,</span>
  p<span class="token punctuation">.</span>name <span class="token keyword">as</span> product_name
<span class="token keyword">FROM</span> users u
<span class="token keyword">JOIN</span> orders o <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> o<span class="token punctuation">.</span>user_id
<span class="token keyword">JOIN</span> products p <span class="token keyword">ON</span> o<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>id<span class="token punctuation">;</span></code></pre>
<p><strong>解決方案：API 組合或 CQRS</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// API 組合：在 API 閘道中聚合</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/order-details/:orderId'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 呼叫多個服務</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>order<span class="token punctuation">,</span> user<span class="token punctuation">,</span> product<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://order-service/api/orders/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>orderId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://user-service/api/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>order<span class="token punctuation">.</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://product-service/api/products/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>order<span class="token punctuation">.</span>productId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 組合結果</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token keyword">await</span> order<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">product</span><span class="token operator">:</span> <span class="token keyword">await</span> product<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// CQRS：獨立的讀取模型</span>
<span class="token keyword">class</span> <span class="token class-name">OrderReadModel</span> <span class="token punctuation">{</span>
  <span class="token comment">// 查詢的非正規化視圖</span>
  <span class="token keyword">async</span> <span class="token function">getOrderDetails</span><span class="token punctuation">(</span><span class="token parameter">orderId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 讀取資料庫中的預先連接資料</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> readDB<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      SELECT * FROM order_details_view
      WHERE order_id = ?
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span>orderId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 由所有服務的事件更新</span>
  <span class="token keyword">async</span> <span class="token function">onOrderCreated</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 更新視圖 */</span> <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">onUserUpdated</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 更新視圖 */</span> <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">onProductUpdated</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 更新視圖 */</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>何時使用微服務模式：</strong></p>
<p>✅ <strong>大型組織：</strong></p>
<ul>
<li>多個團隊（5+ 團隊）</li>
<li>每個團隊擁有一個服務</li>
<li>獨立發布週期</li>
</ul>
<p>✅ <strong>不同的擴展需求：</strong></p>
<ul>
<li>某些功能高流量</li>
<li>某些功能低流量</li>
<li>需要獨立擴展</li>
</ul>
<p>✅ <strong>技術多樣性：</strong></p>
<ul>
<li>不同的語言/框架</li>
<li>不同的資料庫類型</li>
<li>遺留系統整合</li>
</ul>
<p>✅ <strong>領域複雜性：</strong></p>
<ul>
<li>清晰的界限上下文</li>
<li>明確定義的服務邊界</li>
<li>成熟的領域理解</li>
</ul>
<p><strong>何時不使用微服務：</strong></p>
<p>❌ <strong>小團隊：</strong></p>
<ul>
<li>&lt; 5 個開發人員</li>
<li>開銷太高</li>
<li>單體更簡單</li>
</ul>
<p>❌ <strong>不清楚的邊界：</strong></p>
<ul>
<li>領域理解不足</li>
<li>服務經常變更</li>
<li>大量跨服務呼叫</li>
</ul>
<p>❌ <strong>簡單應用程式：</strong></p>
<ul>
<li>CRUD 操作</li>
<li>無複雜工作流程</li>
<li>單體就足夠</li>
</ul>
<p>❌ <strong>新創公司/MVP：</strong></p>
<ul>
<li>需要快速行動</li>
<li>需求經常變更</li>
<li>過早優化</li>
</ul>
<p><strong>遷移路徑：單體到微服務</strong></p>
<p><strong>階段 1：帶模組的單體</strong></p>
<pre class="language-none"><code class="language-none">單體 API
├── 使用者模組
├── 訂單模組
└── 產品模組
     ↓
  單一資料庫</code></pre>
<p><strong>階段 2：提取第一個服務</strong></p>
<pre class="language-none"><code class="language-none">單體 API ──&gt; 共享資料庫
     ↓
使用者服務 ──&gt; 使用者資料庫（新）</code></pre>
<p><strong>階段 3：提取更多服務</strong></p>
<pre class="language-none"><code class="language-none">產品服務 ──&gt; 產品資料庫
訂單服務 ──&gt; 訂單資料庫
使用者服務 ──&gt; 使用者資料庫</code></pre>
<p><strong>階段 4：淘汰單體</strong></p>
<pre class="language-none"><code class="language-none">API 閘道
├── 產品服務 ──&gt; 產品資料庫
├── 訂單服務 ──&gt; 訂單資料庫
└── 使用者服務 ──&gt; 使用者資料庫</code></pre>
<p><strong>最佳實踐：</strong></p>
<ol>
<li><strong>從單體開始</strong></li>
<li><strong>當痛點出現時提取服務</strong></li>
<li><strong>使用 API 閘道進行路由</strong></li>
<li><strong>實作服務發現</strong></li>
<li><strong>使用事件驅動通訊</strong></li>
<li><strong>監控一切</strong></li>
<li><strong>自動化部署</strong></li>
<li><strong>為故障設計</strong></li>
</ol>
<h3 id="單體-API-層的優勢">單體 API 層的優勢</h3>
<h4 id="1-安全性">1. 安全性</h4>
<p><strong>集中式身份驗證：</strong></p>
<pre class="language-none"><code class="language-none">行動應用程式 → API（JWT 令牌）
Web 應用程式 → API（OAuth）
分析 → API（API 金鑰）

API → 資料庫（單一安全連接）</code></pre>
<p><strong>優勢：</strong></p>
<ul>
<li>應用程式中無資料庫憑證</li>
<li>撤銷每個應用程式的存取</li>
<li>稽核所有資料存取</li>
<li>實作速率限制</li>
</ul>
<p><strong>範例：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 行動應用程式 - 無資料庫憑證</span>
<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.example.com/users'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'Authorization'</span><span class="token operator">:</span> <span class="token string">'Bearer '</span> <span class="token operator">+</span> token <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="2-鬆散耦合">2. 鬆散耦合</h4>
<p><strong>架構獨立性：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 資料庫變更</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> users <span class="token keyword">RENAME</span> <span class="token keyword">COLUMN</span> email <span class="token keyword">TO</span> email_address<span class="token punctuation">;</span></code></pre>
<p><strong>API 保持不變：</strong></p>
<pre class="language-json" data-language="json"><code class="language-json">GET /api/users/<span class="token number">123</span>
<span class="token punctuation">{</span>
  <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"user@example.com"</span>  <span class="token comment">// API 契約不變</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>結果：</strong></p>
<ul>
<li>✅ 行動應用程式運作</li>
<li>✅ Web 應用程式運作</li>
<li>✅ 分析運作</li>
<li>✅ 只有 API 程式碼更新</li>
</ul>
<h4 id="3-業務邏輯集中化">3. 業務邏輯集中化</h4>
<p><strong>單一真相來源：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// API 層 - 折扣邏輯在一個地方</span>
<span class="token keyword">function</span> <span class="token function">calculateDiscount</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>isPremium<span class="token punctuation">)</span> <span class="token keyword">return</span> order<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token number">0.15</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>total <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">return</span> order<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token number">0.10</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>優勢：</strong></p>
<ul>
<li>所有應用程式的一致行為</li>
<li>易於更新規則</li>
<li>單一測試位置</li>
<li>稽核軌跡</li>
</ul>
<h4 id="4-效能優化">4. 效能優化</h4>
<p><strong>連接池：</strong></p>
<pre class="language-none"><code class="language-none">10 個應用程式 → API（10 個連接）
API → 資料庫（5 個池化連接）

而不是：10 個應用程式 × 20 = 200 個連接</code></pre>
<p><strong>快取：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 快取頻繁查詢</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/products'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cached <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'products'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cached<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>cached<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> products <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM products'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'products'</span><span class="token punctuation">,</span> products<span class="token punctuation">,</span> <span class="token string">'EX'</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>products<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>優勢：</strong></p>
<ul>
<li>減少資料庫負載</li>
<li>更快的回應時間</li>
<li>更好的資源利用</li>
</ul>
<h4 id="5-細粒度存取控制">5. 細粒度存取控制</h4>
<p><strong>每個應用程式的權限：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 行動應用程式 - 唯讀</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">===</span> <span class="token string">'mobile'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  allowedOperations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'READ'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 管理工具 - 完整存取</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">===</span> <span class="token string">'admin'</span> <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span>isAdmin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  allowedOperations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'READ'</span><span class="token punctuation">,</span> <span class="token string">'WRITE'</span><span class="token punctuation">,</span> <span class="token string">'DELETE'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 分析 - 僅特定表</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">===</span> <span class="token string">'analytics'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  allowedTables <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'orders'</span><span class="token punctuation">,</span> <span class="token string">'products'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="6-全面監控">6. 全面監控</h4>
<p><strong>追蹤一切：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 記錄所有 API 請求</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">app</span><span class="token operator">:</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'x-app-name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    <span class="token literal-property property">endpoint</span><span class="token operator">:</span> req<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> req<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
    <span class="token literal-property property">duration</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> req<span class="token punctuation">.</span>startTime
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>洞察：</strong></p>
<ul>
<li>哪個應用程式最慢？</li>
<li>哪些端點最常使用？</li>
<li>哪個應用程式導致錯誤？</li>
<li>每個應用程式的使用模式</li>
</ul>
<h2 id="混合方法：何時混合使用">混合方法：何時混合使用</h2>
<h3 id="唯讀直接存取">唯讀直接存取</h3>
<p>**情境：**分析和報表工具需要複雜查詢。</p>
<div class="mermaid">flowchart LR
    subgraph Write["寫入操作"]
        App1["📱 行動應用程式"]
        App2["💻 Web 應用程式"]
    end
    
    subgraph Read["唯讀"]
        Analytics["📊 分析"]
        Reports["📈 報表"]
    end
    
    Write --&gt; API["🔐 API 層"]
    API --&gt; DB[("🗄️ 主資料庫")]
    
    DB -.-&gt;|複製| ReadDB[("📖 讀取副本")]
    Read --&gt; ReadDB
    
    style API fill:#e8f5e9
    style DB fill:#e3f2fd
    style ReadDB fill:#fff3e0</div>
<p><strong>設置：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 分析的唯讀使用者</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'analytics'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'secure_password'</span><span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> <span class="token keyword">database</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'analytics'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>

<span class="token comment">-- 連接到讀取副本</span>
<span class="token comment">-- 對生產資料庫無影響</span></code></pre>
<p><strong>優勢：</strong></p>
<ul>
<li>分析不會拖慢生產環境</li>
<li>允許複雜查詢</li>
<li>無寫入存取風險</li>
<li>獨立監控</li>
</ul>
<h4 id="讀取副本-vs-ETL：如何選擇？">讀取副本 vs ETL：如何選擇？</h4>
<p>對於分析工作負載，你有兩個主要選項：</p>
<p><strong>選項 1：讀取副本（即時）</strong></p>
<div class="mermaid">flowchart LR
    Prod[("🗄️ 生產資料庫")] -.-&gt;|"持續<br>複製"| Replica[("📖 讀取副本")]
    Analytics["📊 分析工具"] --&gt; Replica
    
    style Prod fill:#e3f2fd
    style Replica fill:#fff3e0</div>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 分析查詢在副本上執行</span>
<span class="token keyword">SELECT</span> 
  <span class="token keyword">DATE</span><span class="token punctuation">(</span>created_at<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">date</span><span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> orders<span class="token punctuation">,</span>
  <span class="token function">SUM</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span> <span class="token keyword">as</span> revenue
<span class="token keyword">FROM</span> orders
<span class="token keyword">WHERE</span> created_at <span class="token operator">&gt;=</span> DATE_SUB<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token number">30</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">DATE</span><span class="token punctuation">(</span>created_at<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>特徵：</strong></p>
<ul>
<li>⚡ 即時或近即時資料（秒級延遲）</li>
<li>🔄 持續複製</li>
<li>📊 與生產環境相同的架構</li>
<li>🎯 直接 SQL 查詢</li>
</ul>
<div class="admonition warning"><p class="admonition-title"><span class="mdi mdi-alert-outline admonition-icon"></span>⚠️「近即時」現實檢查</p><div class="admonition-content"><p>**讀取副本並非真正即時。**總是存在複製延遲。</p>
<p><strong>典型複製延遲：</strong></p>
<ul>
<li>**最佳情況：**100ms - 1 秒</li>
<li>**正常：**1-5 秒</li>
<li>**負載下：**10-60 秒</li>
<li>**網路問題：**數分鐘或更長</li>
</ul>
<p><strong>這意味著什麼：</strong>
</p><pre class="language-none"><code class="language-none">12:00:00.000 - 客戶在生產環境下訂單<p></p>
</code></pre></div></div><code class="language-none">

12:00:00.500 - 複製延遲（500ms）
12:00:00.500 - 訂單出現在讀取副本
12:00:00.600 - 分析儀表板查詢副本

結果：儀表板在訂單發生後 600ms 顯示</code>
<pre><code>**真實世界情境：**
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 生產環境：剛建立訂單</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> orders <span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">,</span> <span class="token string">'pending'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 讀取副本：2 秒後</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> orders <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">12345</span><span class="token punctuation">;</span>
<span class="token comment">-- 返回：無結果（複製延遲）</span>

<span class="token comment">-- 副本上 2 秒後</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> orders <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">12345</span><span class="token punctuation">;</span>
<span class="token comment">-- 返回：找到訂單</span></code></pre>

**複製延遲何時造成問題：**

1. **客戶看到過時資料：**
<pre class="language-none"><code class="language-none">使用者：「我剛下了訂單！」
儀表板：「找不到訂單」
使用者：「你的系統壞了！」</code></pre>

2. **不一致的視圖：**
<pre class="language-none"><code class="language-none">行動應用程式（生產）：100 個訂單
儀表板（副本）：98 個訂單（落後 2 秒）</code></pre>

3. **基於舊資料的業務決策：**
<pre class="language-none"><code class="language-none">經理：「我們只有 5 件庫存」
現實：0 件（最後 3 秒賣出 5 件）
經理：「來做促銷！」
結果：超賣</code></pre>

**監控複製延遲：**

<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- PostgreSQL</span>
<span class="token keyword">SELECT</span> 
  client_addr<span class="token punctuation">,</span>
  state<span class="token punctuation">,</span>
  sync_state<span class="token punctuation">,</span>
  replay_lag<span class="token punctuation">,</span>
  write_lag<span class="token punctuation">,</span>
  flush_lag
<span class="token keyword">FROM</span> pg_stat_replication<span class="token punctuation">;</span>

<span class="token comment">-- MySQL</span>
<span class="token keyword">SHOW</span> SLAVE <span class="token keyword">STATUS</span>\G
<span class="token comment">-- 查看：Seconds_Behind_Master</span></code></pre>

**高延遲警報：**
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Prometheus 警報</span>
<span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> HighReplicationLag
  <span class="token key atrule">expr</span><span class="token punctuation">:</span> mysql_slave_lag_seconds <span class="token punctuation">&gt;</span> 10
  <span class="token key atrule">for</span><span class="token punctuation">:</span> 2m
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"複製延遲為 {{ $value }} 秒"</span></code></pre>

**儘管有延遲仍可接受的使用案例：**
- ✅ 歷史報表（昨天的銷售）
- ✅ 趨勢分析（最近 30 天）
- ✅ 帶有「資料截至 X 秒前」免責聲明的儀表板
- ✅ 非關鍵指標

**不可接受的使用案例：**
- ❌ 即時庫存檢查
- ❌ 詐欺檢測
- ❌ 面向客戶的「你的訂單」頁面
- ❌ 關鍵業務決策

**如果你需要真正的即時：**
- 直接查詢生產資料庫（謹慎）
- 使用變更資料捕獲（CDC）與串流
- 實作事件驅動架構
- 接受延遲並圍繞它設計
</code></pre>
<p><strong>選項 2：ETL 到資料倉儲（批次）</strong></p>
<div class="mermaid">flowchart LR
    Prod[("🗄️ 生產資料庫")] --&gt;|"夜間<br>提取"| ETL["⚙️ ETL 流程"]
    ETL --&gt;|"轉換<br>&amp; 載入"| DW[("📊 資料倉儲")]
    Analytics["📊 分析工具"] --&gt; DW
    
    style Prod fill:#e3f2fd
    style ETL fill:#fff3e0
    style DW fill:#e8f5e9</div>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># ETL 作業每晚執行</span>
<span class="token keyword">def</span> <span class="token function">etl_orders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 從生產環境提取</span>
    orders <span class="token operator">=</span> prod_db<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
        SELECT * FROM orders 
        WHERE updated_at &gt;= CURRENT_DATE - INTERVAL '1 day'
    """</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 轉換</span>
    <span class="token keyword">for</span> order <span class="token keyword">in</span> orders<span class="token punctuation">:</span>
        order<span class="token punctuation">[</span><span class="token string">'revenue'</span><span class="token punctuation">]</span> <span class="token operator">=</span> order<span class="token punctuation">[</span><span class="token string">'total'</span><span class="token punctuation">]</span> <span class="token operator">-</span> order<span class="token punctuation">[</span><span class="token string">'discount'</span><span class="token punctuation">]</span>
        order<span class="token punctuation">[</span><span class="token string">'profit_margin'</span><span class="token punctuation">]</span> <span class="token operator">=</span> calculate_margin<span class="token punctuation">(</span>order<span class="token punctuation">)</span>
    
    <span class="token comment"># 載入到倉儲</span>
    warehouse<span class="token punctuation">.</span>bulk_insert<span class="token punctuation">(</span><span class="token string">'fact_orders'</span><span class="token punctuation">,</span> orders<span class="token punctuation">)</span></code></pre>
<p><strong>特徵：</strong></p>
<ul>
<li>🕐 排程更新（每小時/每天）</li>
<li>🔄 批次處理</li>
<li>🏗️ 轉換的架構（為分析優化）</li>
<li>📈 預先聚合的資料</li>
</ul>
<div class="admonition anote"><p class="admonition-title"><span class="mdi mdi-note-outline admonition-icon"></span>📅 批次處理：可預測的過時性</p><div class="admonition-content"><p><strong>ETL 資料是故意過時的——這沒關係。</strong></p>
<p><strong>典型 ETL 排程：</strong></p>
<ul>
<li>**每小時：**資料是 0-60 分鐘舊</li>
<li>**每天：**資料是 0-24 小時舊</li>
<li>**每週：**資料是 0-7 天舊</li>
</ul>
<p><strong>範例時間軸：</strong>
</p><pre class="language-none"><code class="language-none">週一 9:00 AM - 客戶下訂單<p></p>
</code></pre></div></div><code class="language-none">

週一 11:59 PM - ETL 作業開始
週二 12:30 AM - ETL 作業完成
週二 8:00 AM - 分析師查看報表

資料年齡：約 23 小時舊</code>
<pre><code>**為什麼批次對分析更好：**

1. **一致的快照：**
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># ETL 捕獲時間點快照</span>
<span class="token comment"># 所有資料來自同一時刻</span>
snapshot_time <span class="token operator">=</span> <span class="token string">'2024-01-15 23:59:59'</span>

orders <span class="token operator">=</span> extract_orders<span class="token punctuation">(</span>snapshot_time<span class="token punctuation">)</span>
customers <span class="token operator">=</span> extract_customers<span class="token punctuation">(</span>snapshot_time<span class="token punctuation">)</span>
products <span class="token operator">=</span> extract_products<span class="token punctuation">(</span>snapshot_time<span class="token punctuation">)</span>

<span class="token comment"># 所有資料都是一致的</span>
<span class="token comment"># 無查詢中途變更</span></code></pre>

2. **無查詢中途更新：**
<pre class="language-none"><code class="language-none">讀取副本（即時）：
開始查詢：100 個訂單
查詢中途：5 個新訂單到達
結束查詢：不一致的結果

資料倉儲（批次）：
開始查詢：100 個訂單
查詢中途：無變更（靜態快照）
結束查詢：一致的結果</code></pre>

3. **為聚合優化：**
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 倉儲中預先聚合</span>
<span class="token keyword">SELECT</span> <span class="token keyword">date</span><span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>revenue<span class="token punctuation">)</span> 
<span class="token keyword">FROM</span> daily_sales_summary  <span class="token comment">-- 已經求和</span>
<span class="token keyword">WHERE</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2024-01-01'</span><span class="token punctuation">;</span>
<span class="token comment">-- 10ms 返回</span>

<span class="token comment">-- vs 讀取副本</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DATE</span><span class="token punctuation">(</span>created_at<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> orders  <span class="token comment">-- 必須掃描數百萬行</span>
<span class="token keyword">WHERE</span> created_at <span class="token operator">&gt;=</span> <span class="token string">'2024-01-01'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">DATE</span><span class="token punctuation">(</span>created_at<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 30 秒返回</span></code></pre>

**過時性可接受的情況：**
- ✅ 月度/季度報表
- ✅ 年度比較
- ✅ 趨勢分析
- ✅ 高階主管儀表板
- ✅ 合規報表

**過時性不可接受的情況：**
- ❌ 即時操作儀表板
- ❌ 即時警報
- ❌ 面向客戶的資料
- ❌ 詐欺檢測

**混合解決方案：Lambda 架構**
<pre class="language-none"><code class="language-none">即時層（讀取副本）：
- 最近 24 小時的資料
- 對最近資料的快速查詢
- 可接受延遲：秒

批次層（資料倉儲）：
- 歷史資料（&gt;24 小時）
- 複雜分析
- 可接受延遲：小時/天

服務層：
- 合併兩個視圖
- 最近 + 歷史</code></pre>

**範例實作：**
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_sales_report</span><span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">)</span><span class="token punctuation">:</span>
    today <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>date<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 從倉儲獲取歷史資料</span>
    <span class="token keyword">if</span> end_date <span class="token operator">&lt;</span> today<span class="token punctuation">:</span>
        <span class="token keyword">return</span> warehouse<span class="token punctuation">.</span>query<span class="token punctuation">(</span>
            <span class="token string">"SELECT * FROM sales_summary WHERE date BETWEEN ? AND ?"</span><span class="token punctuation">,</span>
            start_date<span class="token punctuation">,</span> end_date
        <span class="token punctuation">)</span>
    
    <span class="token comment"># 從副本獲取最近資料</span>
    historical <span class="token operator">=</span> warehouse<span class="token punctuation">.</span>query<span class="token punctuation">(</span>
        <span class="token string">"SELECT * FROM sales_summary WHERE date BETWEEN ? AND ?"</span><span class="token punctuation">,</span>
        start_date<span class="token punctuation">,</span> today <span class="token operator">-</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    recent <span class="token operator">=</span> replica<span class="token punctuation">.</span>query<span class="token punctuation">(</span>
        <span class="token string">"SELECT * FROM orders WHERE date &gt;= ?"</span><span class="token punctuation">,</span>
        today
    <span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> merge<span class="token punctuation">(</span>historical<span class="token punctuation">,</span> recent<span class="token punctuation">)</span></code></pre>
</code></pre>
<p><strong>比較：</strong></p>
<table>
<thead>
<tr>
<th>因素</th>
<th>讀取副本</th>
<th>ETL 到資料倉儲</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>資料新鮮度</strong></td>
<td>即時（秒）</td>
<td>批次（小時/天）</td>
</tr>
<tr>
<td><strong>查詢效能</strong></td>
<td>取決於生產架構</td>
<td>為分析優化</td>
</tr>
<tr>
<td><strong>架構</strong></td>
<td>與生產相同</td>
<td>轉換（星型/雪花型）</td>
</tr>
<tr>
<td><strong>對生產的影響</strong></td>
<td>最小（獨立伺服器）</td>
<td>最小（排程離峰）</td>
</tr>
<tr>
<td><strong>複雜度</strong></td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td><strong>成本</strong></td>
<td>較低</td>
<td>較高</td>
</tr>
<tr>
<td><strong>資料轉換</strong></td>
<td>無</td>
<td>廣泛</td>
</tr>
<tr>
<td><strong>歷史資料</strong></td>
<td>受保留限制</td>
<td>無限</td>
</tr>
<tr>
<td><strong>多個來源</strong></td>
<td>單一資料庫</td>
<td>多個資料庫/API</td>
</tr>
</tbody>
</table>
<p><strong>何時使用讀取副本：</strong></p>
<p>✅ <strong>即時儀表板：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 即時訂單監控</span>
<span class="token constant">SELECT</span> <span class="token constant">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> active_orders
<span class="token constant">FROM</span> orders
<span class="token constant">WHERE</span> status <span class="token operator">=</span> <span class="token string">'processing'</span>
<span class="token constant">AND</span> created_at <span class="token operator">&gt;=</span> <span class="token constant">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token constant">INTERVAL</span> <span class="token number">1</span> <span class="token constant">HOUR</span><span class="token punctuation">;</span></code></pre>
<p>✅ <strong>操作報表：</strong></p>
<ul>
<li>當前庫存水平</li>
<li>活躍使用者會話</li>
<li>今天的銷售數字</li>
<li>系統健康指標</li>
</ul>
<p>✅ <strong>簡單分析：</strong></p>
<ul>
<li>單一資料來源</li>
<li>無複雜轉換</li>
<li>生產架構運作良好</li>
</ul>
<p>✅ <strong>預算限制：</strong></p>
<ul>
<li>小團隊</li>
<li>有限資源</li>
<li>需要快速設置</li>
</ul>
<p><strong>何時使用 ETL/資料倉儲：</strong></p>
<p>✅ <strong>複雜分析：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 多維分析</span>
<span class="token keyword">SELECT</span> 
  d<span class="token punctuation">.</span><span class="token keyword">year</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>quarter<span class="token punctuation">,</span> d<span class="token punctuation">.</span><span class="token keyword">month</span><span class="token punctuation">,</span>
  p<span class="token punctuation">.</span>category<span class="token punctuation">,</span> p<span class="token punctuation">.</span>brand<span class="token punctuation">,</span>
  c<span class="token punctuation">.</span>country<span class="token punctuation">,</span> c<span class="token punctuation">.</span>region<span class="token punctuation">,</span>
  <span class="token function">SUM</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>revenue<span class="token punctuation">)</span> <span class="token keyword">as</span> total_revenue<span class="token punctuation">,</span>
  <span class="token function">SUM</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>profit<span class="token punctuation">)</span> <span class="token keyword">as</span> total_profit
<span class="token keyword">FROM</span> fact_sales f
<span class="token keyword">JOIN</span> dim_date d <span class="token keyword">ON</span> f<span class="token punctuation">.</span>date_key <span class="token operator">=</span> d<span class="token punctuation">.</span>date_key
<span class="token keyword">JOIN</span> dim_product p <span class="token keyword">ON</span> f<span class="token punctuation">.</span>product_key <span class="token operator">=</span> p<span class="token punctuation">.</span>product_key
<span class="token keyword">JOIN</span> dim_customer c <span class="token keyword">ON</span> f<span class="token punctuation">.</span>customer_key <span class="token operator">=</span> c<span class="token punctuation">.</span>customer_key
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> d<span class="token punctuation">.</span><span class="token keyword">year</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>quarter<span class="token punctuation">,</span> d<span class="token punctuation">.</span><span class="token keyword">month</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>category<span class="token punctuation">,</span> p<span class="token punctuation">.</span>brand<span class="token punctuation">,</span> c<span class="token punctuation">.</span>country<span class="token punctuation">,</span> c<span class="token punctuation">.</span>region<span class="token punctuation">;</span></code></pre>
<p>✅ <strong>多個資料來源：</strong></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 組合來自多個系統的資料</span>
<span class="token keyword">def</span> <span class="token function">build_customer_360</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 從生產資料庫</span>
    orders <span class="token operator">=</span> extract_from_postgres<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 從 CRM API</span>
    interactions <span class="token operator">=</span> extract_from_salesforce<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 從支援系統</span>
    tickets <span class="token operator">=</span> extract_from_zendesk<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 組合並載入</span>
    customer_360 <span class="token operator">=</span> merge_data<span class="token punctuation">(</span>orders<span class="token punctuation">,</span> interactions<span class="token punctuation">,</span> tickets<span class="token punctuation">)</span>
    warehouse<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'customer_360'</span><span class="token punctuation">,</span> customer_360<span class="token punctuation">)</span></code></pre>
<p>✅ <strong>歷史分析：</strong></p>
<ul>
<li>長期趨勢（數年資料）</li>
<li>年度比較</li>
<li>季節性模式</li>
<li>留存群組</li>
</ul>
<p>✅ <strong>資料轉換需求：</strong></p>
<ul>
<li>為效能進行非正規化</li>
<li>業務邏輯計算</li>
<li>資料品質修正</li>
<li>聚合和彙總</li>
</ul>
<p>✅ <strong>合規/稽核：</strong></p>
<ul>
<li>不可變的歷史記錄</li>
<li>時間點快照</li>
<li>稽核軌跡</li>
<li>監管報告</li>
</ul>
<p><strong>混合方法：</strong></p>
<p>許多企業同時使用兩者：</p>
<pre class="language-none"><code class="language-none">即時需求 → 讀取副本
  - 即時儀表板
  - 操作報表
  - 當前指標

分析需求 → 資料倉儲
  - 歷史分析
  - 複雜查詢
  - 多來源報表</code></pre>
<p><strong>範例架構：</strong></p>
<div class="mermaid">flowchart TD
    Prod[("🗄️ 生產資料庫")]
    
    Prod -.-&gt;|"即時<br>複製"| Replica[("📖 讀取副本")]
    Prod --&gt;|"夜間<br>ETL"| DW[("📊 資料倉儲")]
    
    Replica --&gt; LiveDash["⚡ 即時儀表板"]
    DW --&gt; Analytics["📈 分析平台"]
    DW --&gt; BI["📊 BI 工具"]
    
    style Prod fill:#e3f2fd
    style Replica fill:#fff3e0
    style DW fill:#e8f5e9</div>
<p><strong>遷移路徑：</strong></p>
<p><strong>階段 1：從讀取副本開始</strong></p>
<pre class="language-none"><code class="language-none">生產資料庫 → 讀取副本 → 分析

- 快速設置
- 立即價值
- 低複雜度</code></pre>
<p><strong>階段 2：隨著需求增長添加 ETL</strong></p>
<pre class="language-none"><code class="language-none">生產資料庫 → 讀取副本 → 即時儀表板
            ↓
           ETL → 資料倉儲 → 複雜分析

- 保留即時用於操作需求
- 添加倉儲用於分析需求
- 兩全其美</code></pre>
<p><strong>成本比較：</strong></p>
<p><strong>讀取副本：</strong></p>
<pre class="language-none"><code class="language-none">資料庫副本：$200/月
設置時間：1 天
維護：低

第一年總計：約 $2,400</code></pre>
<p><strong>資料倉儲 + ETL：</strong></p>
<pre class="language-none"><code class="language-none">倉儲：$500/月
ETL 工具：$300/月
設置時間：2-4 週
維護：中高

第一年總計：約 $9,600 + 設置成本</code></pre>
<p><strong>決策框架：</strong></p>
<pre class="language-none"><code class="language-none">從讀取副本開始，如果：
- 需要即時資料
- 單一資料來源
- 簡單查詢
- 小預算
- 需要快速成功

遷移到資料倉儲，當：
- 需要歷史分析（&gt;1 年）
- 多個資料來源
- 複雜轉換
- 副本上的慢查詢
- 合規要求</code></pre>
<h3 id="架構抽象的資料庫視圖">架構抽象的資料庫視圖</h3>
<p>**情境：**需要直接存取但想隱藏架構複雜性。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 建立簡化視圖</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> customer_summary <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> 
  c<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
  c<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
  c<span class="token punctuation">.</span>email_address <span class="token keyword">AS</span> email<span class="token punctuation">,</span>  <span class="token comment">-- 隱藏欄位重新命名</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">AS</span> order_count<span class="token punctuation">,</span>
  <span class="token function">SUM</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>total<span class="token punctuation">)</span> <span class="token keyword">AS</span> total_spent
<span class="token keyword">FROM</span> customers c
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> orders o <span class="token keyword">ON</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> o<span class="token punctuation">.</span>customer_id
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>id<span class="token punctuation">;</span>

<span class="token comment">-- 僅授予視圖存取權限</span>
<span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> customer_summary <span class="token keyword">TO</span> <span class="token string">'reporting_app'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span></code></pre>
<p><strong>優勢：</strong></p>
<ul>
<li>隱藏架構變更</li>
<li>簡化的資料模型</li>
<li>預先連接的資料</li>
<li>存取控制</li>
</ul>
<h2 id="決策框架">決策框架</h2>
<h3 id="選擇直接存取的情況：">選擇直接存取的情況：</h3>
<p>✅ <strong>小規模：</strong></p>
<ul>
<li>&lt; 5 個應用程式</li>
<li>&lt; 1000 個使用者</li>
<li>低流量</li>
</ul>
<p>✅ <strong>僅內部：</strong></p>
<ul>
<li>無外部存取</li>
<li>可信任環境</li>
<li>單一團隊</li>
</ul>
<p>✅ <strong>唯讀：</strong></p>
<ul>
<li>分析工具</li>
<li>報表儀表板</li>
<li>資料科學</li>
</ul>
<p>✅ <strong>原型製作：</strong></p>
<ul>
<li>MVP 階段</li>
<li>概念驗證</li>
<li>時間緊迫的展示</li>
</ul>
<h3 id="選擇-API-層的情況：">選擇 API 層的情況：</h3>
<p>✅ <strong>企業規模：</strong></p>
<ul>
<li>5+ 個應用程式</li>
<li>1000+ 個使用者</li>
<li>高流量</li>
</ul>
<p>✅ <strong>外部存取：</strong></p>
<ul>
<li>行動應用程式</li>
<li>第三方整合</li>
<li>公共 API</li>
</ul>
<p>✅ <strong>安全關鍵：</strong></p>
<ul>
<li>客戶資料</li>
<li>財務資訊</li>
<li>醫療記錄</li>
</ul>
<p>✅ <strong>長期產品：</strong></p>
<ul>
<li>生產系統</li>
<li>多個團隊</li>
<li>頻繁變更</li>
</ul>
<h2 id="最佳實踐">最佳實踐</h2>
<h3 id="如果你必須使用直接存取">如果你必須使用直接存取</h3>
<p><strong>1. 使用讀取副本：</strong></p>
<pre class="language-none"><code class="language-none">寫入應用程式 → API → 主資料庫
讀取應用程式 → 讀取副本</code></pre>
<p><strong>2. 為每個應用程式建立資料庫使用者：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'mobile_app'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'password1'</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'web_app'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'password2'</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'analytics'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'password3'</span><span class="token punctuation">;</span></code></pre>
<p><strong>3. 授予最小權限：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 行動應用程式 - 只需要使用者和訂單</span>
<span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> <span class="token keyword">database</span><span class="token punctuation">.</span>users <span class="token keyword">TO</span> <span class="token string">'mobile_app'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> <span class="token keyword">database</span><span class="token punctuation">.</span>orders <span class="token keyword">TO</span> <span class="token string">'mobile_app'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>

<span class="token comment">-- 分析 - 所有內容唯讀</span>
<span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> <span class="token keyword">database</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'analytics'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span></code></pre>
<p><strong>4. 使用連接池：</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 限制每個應用程式的連接</span>
<span class="token keyword">const</span> pool <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">'database.example.com'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">'mobile_app'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_PASSWORD</span><span class="token punctuation">,</span>
  <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">connectionLimit</span><span class="token operator">:</span> <span class="token number">5</span>  <span class="token comment">// 每個應用程式的限制</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>5. 監控一切：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 啟用查詢日誌</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> general_log <span class="token operator">=</span> <span class="token string">'ON'</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> log_output <span class="token operator">=</span> <span class="token string">'TABLE'</span><span class="token punctuation">;</span>

<span class="token comment">-- 檢視慢查詢</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> mysql<span class="token punctuation">.</span>slow_log 
<span class="token keyword">WHERE</span> user_host <span class="token operator">LIKE</span> <span class="token string">'%mobile_app%'</span><span class="token punctuation">;</span></code></pre>
<h2 id="結論">結論</h2>
<p>直接資料庫存取很誘人——它簡單且快速。但在企業環境中，風險通常超過好處。</p>
<p><strong>關鍵要點：</strong></p>
<ul>
<li><strong>直接存取適用於小型、內部、唯讀情境</strong></li>
<li><strong>API 層提供安全性、靈活性和控制</strong></li>
<li><strong>緊密耦合是最大的長期成本</strong></li>
<li><strong>為生產系統從 API 層開始</strong></li>
<li><strong>如果有遺留直接存取，逐步遷移</strong></li>
</ul>
<p><strong>真正的問題：</strong></p>
<p>不是「我們能直接連接嗎？」而是「我們應該嗎？」</p>
<p>對於大多數企業，答案是：**建立 API 層。**當你需要時，未來的你會感謝你：</p>
<ul>
<li>變更資料庫架構</li>
<li>添加新應用程式</li>
<li>撤銷被洩露應用程式的存取</li>
<li>擴展以處理更多流量</li>
<li>除錯生產問題</li>
</ul>
<p>在 API 層的前期投資在安全性、可維護性和可擴展性方面帶來回報。🏗️</p>
<h2 id="資源">資源</h2>
<ul>
<li>**<a target="_blank" rel="noopener" href="https://12factor.net/">The Twelve-Factor App</a>：**現代應用程式架構原則</li>
<li>**<a target="_blank" rel="noopener" href="https://owasp.org/www-project-api-security/">API Security Best Practices</a>：**OWASP API 安全</li>
<li>**<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Connection_pool">Database Connection Pooling</a>：**效能優化</li>
<li>**<a target="_blank" rel="noopener" href="https://microservices.io/patterns/data/database-per-service.html">Microservices Patterns</a>：**每服務一個資料庫模式</li>
</ul>

        </div>
        <footer class="article-footer">
            
    <a data-url="https://neo01.com/zh-TW/2023/01/Database-Direct-Access/" data-id="7830f57f" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url').replace("http://","https://"),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    <!--script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
            "@type": "Person",
            "name": "Neo Alienson"
        },
        "headline": "企業中資料庫是否應允許應用程式直接連接？",
        "image": "https://neo01.comthumbnail.png",
        "keywords": "Enterprise Architecture Security Database",
        "genre": "Architecture",
        "datePublished": "2023-01-20",
        "dateCreated": "2023-01-20",
        "dateModified": "2025-10-12",
        "url": "https://neo01.com//zh-TW/2023/01/Database-Direct-Access/",
        "description": "多個應用程式直接連接到你的資料庫——方便還是災難？探索為什麼企業架構師會爭論這個基本設計決策。",
        "wordCount": 7277
    }
</script-->

</article>

                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>追蹤 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="stack-exchange" href="https://stackexchange.com/users/2122053/neo?tab=accounts" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-stack-exchange"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="stack-overflow" href="https://stackoverflow.com/users/1885105/neo" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-stack-overflow"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/neoalienson" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="linkedin" href="https://linkedin.com/in/neo01" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-linkedin"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/atom.xml" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    <!-- 
        
<nav id="article-nav">
    
        <a href="/zh-CN/2023/01/Database-Direct-Access/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            企业中数据库是否应允许应用程序直接连接？
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2023/01/Database-Direct-Access/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">Should Databases Allow Direct Application Connections in Enterprise?</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

     -->
    <div class="widgets-container">
        
            
                <div class="widget-wrap widget-list">
    <h3 class="widget-title">連結</h3>
    <div class="widget">
        <ul><li><a href="/zh-TW/ai">AI 遊樂場</a></li><li><a href="/zh-TW/tools">工具</a></li><li><a href="/zh-TW/games">遊戲</a></li><li><a href="/zh-TW/pages/useful-information">實用資訊</a></li><li><a href="/zh-TW/pages/Hexo-Blogging-Cheatsheet">Hexo 部落格速查表</a></li></ul>
    </div>
</div>

            
                
    
    
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/10/Tools-Games-And-Browser-Built-In-AI/" class="thumbnail">
    
    
        
        <span style="background-image:url(/2025/10/Tools-Games-And-Browser-Built-In-AI/thumbnail.jpeg)" alt="工具、遊戲與瀏覽器內建 AI 遊樂場" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-TW/categories/AI/">人工智慧</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/10/Tools-Games-And-Browser-Built-In-AI/" class="title">工具、遊戲與瀏覽器內建 AI 遊樂場</a></p>
                            <p class="item-date"><time datetime="2025-10-01T16:00:00.000Z" itemprop="datePublished">2025-10-02</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/09/The_Rise_of_Agentic_Coding_AI_Powered_Software_Engineering/" class="thumbnail">
    
    
        
        <span style="background-image:url(/2025/09/The_Rise_of_Agentic_Coding_AI_Powered_Software_Engineering/thumbnail.jpeg)" alt="代理式編碼的崛起：AI 驅動的軟體工程" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-TW/categories/AI/">人工智慧</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/09/The_Rise_of_Agentic_Coding_AI_Powered_Software_Engineering/" class="title">代理式編碼的崛起：AI 驅動的軟體工程</a></p>
                            <p class="item-date"><time datetime="2025-09-19T16:00:00.000Z" itemprop="datePublished">2025-09-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/08/Understanding_Ephemeral_Ports/" class="thumbnail">
    
    
        
        <span style="background-image:url(/2025/08/Understanding_Ephemeral_Ports/thumbnail.png)" alt="理解臨時埠" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-TW/categories/Development/">開發</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/08/Understanding_Ephemeral_Ports/" class="title">理解臨時埠</a></p>
                            <p class="item-date"><time datetime="2025-08-29T16:00:00.000Z" itemprop="datePublished">2025-08-30</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/07/Architecture_As_Code_Part_2_Building_the_Foundation/" class="thumbnail">
    
    
        
        <span style="background-image:url(/2025/07/Architecture_As_Code_Part_2_Building_the_Foundation/thumbnail.jpg)" alt="架構即程式碼：第二部分 - 建立基礎" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-TW/categories/Architecture/">架構</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/07/Architecture_As_Code_Part_2_Building_the_Foundation/" class="title">架構即程式碼：第二部分 - 建立基礎</a></p>
                            <p class="item-date"><time datetime="2025-07-19T16:00:00.000Z" itemprop="datePublished">2025-07-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/zh-TW/2025/07/Architecture_As_Code_Part_1_The_Revolution_Begins/" class="thumbnail">
    
    
        
        <span style="background-image:url(/2025/07/Architecture_As_Code_Part_1_The_Revolution_Begins/thumbnail.jpg)" alt="架構即程式碼：第一部分 - 革命的開端" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-TW/categories/Architecture/">架構</a></p>
                            <p class="item-title"><a href="/zh-TW/2025/07/Architecture_As_Code_Part_1_The_Revolution_Begins/" class="title">架構即程式碼：第一部分 - 革命的開端</a></p>
                            <p class="item-date"><time datetime="2025-07-14T16:00:00.000Z" itemprop="datePublished">2025-07-15</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    
    
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">所有文章</h3>
        <div class="widget">
            <ul class="archive-list">
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2025/">2025</a>
                    <span class="archive-list-count">10</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2024/">2024</a>
                    <span class="archive-list-count">24</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2023/">2023</a>
                    <span class="archive-list-count">12</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2022/">2022</a>
                    <span class="archive-list-count">2</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2020/">2020</a>
                    <span class="archive-list-count">2</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2019/">2019</a>
                    <span class="archive-list-count">12</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2018/">2018</a>
                    <span class="archive-list-count">2</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2017/">2017</a>
                    <span class="archive-list-count">5</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2016/">2016</a>
                    <span class="archive-list-count">4</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2015/">2015</a>
                    <span class="archive-list-count">6</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2014/">2014</a>
                    <span class="archive-list-count">7</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-TW/archives/2013/">2013</a>
                    <span class="archive-list-count">2</span>
                </li>
            
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <!-- disable caching cause each page has different footer from qrcode -->
        <!-- common/footer, null, {cache: !config.relative_link})  -->
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="qrcode-share-wrapper">
                <div class="qrcode-text">https://neo01.com/l#cfc72992</div>
                <img src="/qr/qr-6c7f14606f48f2c66fca2022018ae512.svg" width="200" height="200" alt="QR Code for https://neo01.com/l#cfc72992">
            </div>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" title="Homepage" class="logo"></a>
                </h1>
                
                <p>© 2025 Neo Alienson. 版權所有.
                  <a href="/zh-TW/terms-and-conditions">使用條款</a></p>
                
            </div>
            <div class="footer-plugins">
              


            </div>
        </div>
    </div>
</footer>

        
    
        


        


        


        


        


        


        


        


        


    



<!-- Custom Scripts -->




    </div>
<!-- hexo injector body_end start --><script type="text/javascript" src="/js/bundle_last.js"></script><!-- hexo injector body_end end -->

<script>CookieConsent.run({"palette":{"popup":{"background":"#000"},"button":{"background":"#f1d600"}},"guiOptions":{"consentModal":{"layout":"box","position":"bottom right","equalWeightButtons":true,"flipButtons":false},"preferencesModal":{"layout":"box","position":"right","equalWeightButtons":false,"flipButtons":false}},"categories":{"necessary":{"readOnly":true},"functionality":{},"analytics":{}},"language":{"default":"en","autoDetect":"browser","translations":{"en":{"consentModal":{"title":"Hello traveler, it's cookie time!","description":"🍪 This site uses cookies to serve you the best experience—no crumbs left behind! Want to know what cookies really are? Check out this easy-to-understand cookie explanation. And for the legal nitty-gritty, here’s our website cookie policy to keep you in the loop! 🚀\n","acceptAllBtn":"Accept all","acceptNecessaryBtn":"Reject all","showPreferencesBtn":"Manage preferences","footer":"<a href=\"#link\">Privacy Policy</a>\n<a href=\"/terms-and-conditions/\">Terms and conditions</a>\n"},"preferencesModal":{"title":"Consent Preferences Center","acceptAllBtn":"Accept all","acceptNecessaryBtn":"Reject all","savePreferencesBtn":"Save preferences","closeIconLabel":"Close modal","serviceCounterLabel":"Service|Services","sections":[{"title":"Cookie Usage","description":"We use cookies to make your visit smoother, faster, and tailored just for you. Cookies help us remember your preferences, improve site performance, and deliver personalized content while keeping things secure and user-friendly.\n"},{"title":"Strictly Necessary Cookies <span class=\"pm__badge\">Always Enabled</span>","description":"These cookies are essential for the website to function properly. They enable core features like security, page navigation, and access to secure areas. Without these, the site cannot operate correctly.\n","linkedCategory":"necessary"},{"title":"Functionality Cookies","description":"Functionality cookies remember your choices to provide a more personalized experience. For example, they save your language preference or login details so you don’t have to keep entering them each time.\n","linkedCategory":"functionality"},{"title":"Analytics Cookies","description":"Analytics cookies help us understand how visitors interact with our site by collecting information anonymously. This insight allows us to improve functionality, fix issues, and make the website better for you.\n","linkedCategory":"analytics"},{"title":"More information","description":"Please refer to our <a href='/pages/cookie-policy'>cookie policy</a> for full details on how we use cookies and your options to manage them.\n"}]}}}}})</script></body></html>