<!DOCTYPE html><html lang="zh-CN"><head><!-- hexo injector head_begin start --><!-- Google tag (gtag.js) begins-->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3DZR3TQYCY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-3DZR3TQYCY');
    </script>
    <!-- Google tag (gtag.js) ends-->
    <!-- hexo injector head_begin end -->
    <meta charset="utf-8">
    <!-- security headers starts -->
    <!-- meta http-equiv="content-security-policy" content="script-src 'sha256-B5nfCL2Dym3Ba4YJFI7wB3f4vtClbrYJZ32A5erBEdg=' 'sha256-lJjk3/dvd+wXqRFjV7T5L/nXJXr5NjUjmsKSPEe+ass=';" -->
    <!-- security headers ends -->
    <!-- favicon starts -->    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <!-- favicon ends -->
    

    
    <title>OAuth 2.0 安全最佳实践 - 从设计到实现 | Decoding Digital Anomalies</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="keywords" content="Authentication,Best Practices,Security">
    
    
    <meta name="description" content="OAuth 2.0 不只是获取访问令牌。学习如何设计安全的授权流程，在攻击者利用漏洞之前，保护用户数据并防止常见漏洞。">
<meta property="og:type" content="article">
<meta property="og:title" content="OAuth 2.0 安全最佳实践 - 从设计到实现">
<meta property="og:url" content="https://neo01.com/zh-CN/2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation/index.html">
<meta property="og:site_name" content="Decoding Digital Anomalies">
<meta property="og:description" content="OAuth 2.0 不只是获取访问令牌。学习如何设计安全的授权流程，在攻击者利用漏洞之前，保护用户数据并防止常见漏洞。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-12-24T16:00:00.000Z">
<meta property="article:modified_time" content="2025-10-23T14:57:12.750Z">
<meta property="article:author" content="Neo Alienson">
<meta property="article:tag" content="Authentication">
<meta property="article:tag" content="Best Practices">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary">
    
            <link rel="alternate" href="/atom.xml" title="Decoding Digital Anomalies" type="application/atom+xml">
    

    

    

    

    

    

    

    
    
        


    
    
        


    

<!-- hexo injector head_end start --><link rel="stylesheet" type="text/css" href="/css/bundle.css"><script type="text/javascript" src="/js/bundle_first.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0">  <link rel="canonical" href="https://neo01.com/2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation">
  <link rel="alternate" hreflang="en" href="https://neo01.com/2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation">
  <link rel="alternate" hreflang="zh-TW" href="https://neo01.com/zh-TW/2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation">
  <link rel="alternate" hreflang="zh-CN" href="https://neo01.com/zh-CN/2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation">
  <link rel="alternate" hreflang="ja" href="https://neo01.com/ja/2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation">
<style id="admonition-styles">.admonition {
  margin: 1em 0;
  padding: 0rem;
  border-left: 0.3rem solid;
  border-radius: 0.4rem;
  background-color: #f9f9f9;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  overflow: hidden;
  page-break-inside: avoid;
}

.admonition-title {
  display: flex;
  align-items: center;
  font-weight: 600;
  padding: 0rem 1rem 0.1rem 0.75rem;
  font-size: 1.05em;
  background-color: rgba(0, 0, 0, 0.03);
  border-top-left-radius: 0.4rem;
  border-top-right-radius: 0.4rem;
  margin: 0 !important;
}

.admonition-icon {
  font-size: 1.2em;
  margin-right: 0.6rem;
  opacity: 0.85;
  margin-top: 0.1rem;
}

/* 内容区域 margin */
.admonition > *:not(.admonition-title) {
  margin: 0.6rem 1rem 0.6rem 1rem;
}

/* NOTE 类型 */
.admonition.anote {
  border-color: #448aff;
}
.admonition.anote > .admonition-title {
  background-color: #448aff1a;
  color: #2962ff;
}

/* INFO / TODO 类型 */
.admonition.info,
.admonition.todo {
  border-color: #00b8d4;
}
.admonition.info > .admonition-title,
.admonition.todo > .admonition-title {
  background-color: rgba(0, 184, 212, 0.1);
  color: #007c91;
}

/* 警告类 */
.admonition.warning,
.admonition.attention,
.admonition.caution {
  border-color: #ff9100;
}
.admonition.warning > .admonition-title,
.admonition.attention > .admonition-title,
.admonition.caution > .admonition-title {
  background-color: rgba(255, 145, 0, 0.1);
  color: #c66900;
}

/* 错误类 */
.admonition.failure,
.admonition.missing,
.admonition.fail,
.admonition.error,
.admonition.danger,
.admonition.bug {
  border-color: #ff5252;
}
.admonition.failure > .admonition-title,
.admonition.missing > .admonition-title,
.admonition.fail > .admonition-title,
.admonition.error > .admonition-title,
.admonition.danger > .admonition-title,
.admonition.bug > .admonition-title {
  background-color: rgba(255, 82, 82, 0.1);
  color: #b71c1c;
}

/* TIP 类型 */
.admonition.tip {
  border-color: #00bfa5;
}
.admonition.tip > .admonition-title {
  background-color: #00bfa51a;
  color: #00796b;
}

/* SUCCESS 类型 */
.admonition.success {
  border-color: #00c853;
}
.admonition.success > .admonition-title {
  background-color: #00c8531a;
  color: #2e7d32;
}

/* QUESTION 类型 */
.admonition.question {
  border-color: #64dd17;
}
.admonition.question > .admonition-title {
  background-color: #64dd171a;
  color: #558b2f;
}

/* EXAMPLE 类型 */
.admonition.example {
  border-color: #7c4dff;
}
.admonition.example > .admonition-title {
  background-color: #7c4dff1a;
  color: #512da8;
}

/* QUOTE 类型 */
.admonition.quote {
  border-color: #9e9e9e;
}
.admonition.quote > .admonition-title {
  background-color: #9e9e9e1a;
  color: #424242;
}

/*黑暗模式*/
/* 夜间模式基础样式 */
[data-theme="dark"] .admonition {
  background-color: #1e1e1e;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
}

[data-theme="dark"] .admonition-title {
  background-color: rgba(255, 255, 255, 0.05);
}

/* anote */
[data-theme="dark"] .admonition.anote {
  border-color: #82b1ff;
}
[data-theme="dark"] .admonition.anote > .admonition-title {
  background-color: #82b1ff1a;
  color: #bbdefb;
}

/* tip */
[data-theme="dark"] .admonition.tip {
  border-color: #64ffda;
}
[data-theme="dark"] .admonition.tip > .admonition-title {
  background-color: #64ffda1a;
  color: #1de9b6;
}

/* success */
[data-theme="dark"] .admonition.success {
  border-color: #69f0ae;
}
[data-theme="dark"] .admonition.success > .admonition-title {
  background-color: #69f0ae1a;
  color: #00e676;
}

/* question */
[data-theme="dark"] .admonition.question {
  border-color: #b2ff59;
}
[data-theme="dark"] .admonition.question > .admonition-title {
  background-color: #b2ff591a;
  color: #aeea00;
}

/* example */
[data-theme="dark"] .admonition.example {
  border-color: #b388ff;
}
[data-theme="dark"] .admonition.example > .admonition-title {
  background-color: #b388ff1a;
  color: #b39ddb;
}

/* quote */
[data-theme="dark"] .admonition.quote {
  border-color: #bdbdbd;
}
[data-theme="dark"] .admonition.quote > .admonition-title {
  background-color: #bdbdbd1a;
  color: #eeeeee;
}

/* warning / attention / caution */
[data-theme="dark"] .admonition.warning,
[data-theme="dark"] .admonition.attention,
[data-theme="dark"] .admonition.caution {
  border-color: #ffb300;
}
[data-theme="dark"] .admonition.warning > .admonition-title,
[data-theme="dark"] .admonition.attention > .admonition-title,
[data-theme="dark"] .admonition.caution > .admonition-title {
  background-color: #ffb3001a;
  color: #ffe082;
}

/* error / fail / failure / bug / danger / missing */
[data-theme="dark"] .admonition.error,
[data-theme="dark"] .admonition.fail,
[data-theme="dark"] .admonition.failure,
[data-theme="dark"] .admonition.bug,
[data-theme="dark"] .admonition.missing,
[data-theme="dark"] .admonition.danger {
  border-color: #ef5350;
}
[data-theme="dark"] .admonition.error > .admonition-title,
[data-theme="dark"] .admonition.fail > .admonition-title,
[data-theme="dark"] .admonition.failure > .admonition-title,
[data-theme="dark"] .admonition.bug > .admonition-title,
[data-theme="dark"] .admonition.missing > .admonition-title,
[data-theme="dark"] .admonition.danger > .admonition-title {
  background-color: #ef53501a;
  color: #ff8a80;
}</style></head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" title="Homepage" class="logo"></a>
                    </h1>
                        <h2 class="subtitle-wrap">
                            <p class="title">解码数字异常</p>
                          <p class="subtitle">有时功能就是数字兔子洞中的错误，反之亦然</p>
                        </h2>
                    <div id="lang-selector">
                        <span class="lang-icon">🌐</span>
                        
                                <a href="/2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation/" class="lang-link">English</a>
<span class="lang-sep">|</span>                                <a href="/zh-TW/2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation/" class="lang-link">繁體中文</a>
<span class="lang-sep">|</span>                                <a href="/ja/2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation/" class="lang-link">日本語</a>
                    </div>
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/zh-CN/">主页</a>
                                </li>
                                                                    <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-CN/categories/AI/">人工智能</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-CN/categories/AI/Art-Gallery/">艺术画廊</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-CN/categories/Architecture/">架构</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-CN/categories/Cybersecurity/">网络安全</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-CN/categories/Development/">开发</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/zh-CN/categories/Misc/">杂项</a></li></ul>
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/zh-CN/about-me">关于</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" id="search-form-input" placeholder="搜索">
        <button type="submit" title="搜索" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" id="ins-search-input" placeholder="想要查找什么...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script integrity="sha256-B5nfCL2Dym3Ba4YJFI7wB3f4vtClbrYJZ32A5erBEdg=">
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
        LANG: 'zh-CN',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>




</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Cybersecurity/">Cybersecurity</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation-zh-CN" class="article article-single article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner responsive-content">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        OAuth 2.0 安全最佳实践 - 从设计到实现
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
      <i class="fa fa-calendar"></i>
        
          Created <time datetime="2020-12-24T16:00:00.000Z" itemprop="datePublished">2020-12-25</time>
          &nbsp;<i class="fa fa-calendar"></i>
          Updated <time datetime="2025-10-23T14:57:12.750Z" itemprop="datePublished">2025-10-23</time>
        
    </div>


                

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/zh-CN/tags/Best-Practices/">Best Practices</a> <a class="tag-link" href="/zh-CN/tags/Security/">Security</a> <a class="tag-link" href="/zh-CN/tags/Authentication/">Authentication</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-OAuth-2-0-%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5%E5%BE%88%E9%87%8D%E8%A6%81"><span class="toc-text">为什么 OAuth 2.0 安全策略很重要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OAuth-2-0-%E5%9F%BA%E7%A1%80"><span class="toc-text">OAuth 2.0 基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E9%98%B6%E6%AE%B5%E7%9A%84-OAuth-%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5"><span class="toc-text">设计阶段的 OAuth 安全策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84-OAuth-2-0-%E6%BC%8F%E6%B4%9E"><span class="toc-text">常见的 OAuth 2.0 漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OAuth-2-0-%E5%AE%9E%E7%8E%B0%E6%A3%80%E6%9F%A5%E6%B8%85%E5%8D%95"><span class="toc-text">OAuth 2.0 实现检查清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OAuth-2-0-vs-OpenID-Connect"><span class="toc-text">OAuth 2.0 vs OpenID Connect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OAuth-2-0-%E5%AE%89%E5%85%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">OAuth 2.0 安全最佳实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%9A%E5%87%BA%E9%80%89%E6%8B%A9"><span class="toc-text">做出选择</span></a></li></ol>
            <p>你看过那些教程。复制这段代码，加入你的 client ID，然后砰——用户就能用 Google 登录了。在开发环境中运作得很完美。你满怀成就感地部署到生产环境。</p>
<p>然后你的安全团队某个人随口提到："嘿，为什么访问令牌会出现在我们的服务器日志里？"或者更糟的是，渗透测试人员指出你的刷新令牌存放在 localStorage 中，任何页面上的脚本都能访问。突然间，那些教程代码感觉不再那么可靠了。</p>
<p>安全的 OAuth 2.0 不是从集成库时开始。它从应用程序设计时就开始了。你在编写代码之前做的决定，决定了你的授权流程是保护用户还是让他们暴露在攻击之下。</p>
<p>这不是关于 OAuth 库或身份提供者——而是关于策略。这是关于设计能预防漏洞的授权流程，而不是事后修补。</p>
<h2 id="为什么-OAuth-2-0-安全策略很重要">为什么 OAuth 2.0 安全策略很重要</h2>
<p><strong>入侵测试</strong>：当攻击者锁定你的应用程序时，他们能窃取令牌、冒充用户或访问未授权的资源吗？还是你已经设计了让攻击变得不切实际的防御机制？</p>
<p><strong>不安全 OAuth 的代价</strong>：</p>
<ul>
<li><strong>账号接管</strong>：攻击者窃取令牌并访问用户账号</li>
<li><strong>数据泄露</strong>：泄漏的令牌暴露敏感用户数据</li>
<li><strong>合规违规</strong>：GDPR、HIPAA 因安全不足而罚款</li>
<li><strong>声誉损害</strong>：用户在安全事件后失去信任</li>
</ul>
<p><strong>安全 OAuth 的价值</strong>：</p>
<ul>
<li><strong>用户保护</strong>：令牌生命周期短、适当限定范围且安全</li>
<li><strong>攻击预防</strong>：PKCE、状态验证和安全存储防止常见攻击</li>
<li><strong>合规性</strong>：符合法规的安全要求</li>
<li><strong>信任</strong>：用户对数据受到保护感到有信心</li>
</ul>
<div class="admonition warning"><p class="admonition-title"><span class="mdi mdi-alert-outline admonition-icon"></span>⚠️ 部署后无法修复 OAuth 安全问题</p><div class="admonition-content"><p>当令牌被泄露时，你无法追溯性地保护它们。你必须撤销所有令牌、修复漏洞并强制用户重新验证。从一开始就设计好安全性。</p>
</div></div>
<h2 id="OAuth-2-0-基础">OAuth 2.0 基础</h2>
<p>OAuth 2.0 是授权框架，不是认证协议。它允许应用程序代表用户访问资源，而不暴露凭证。</p>
<h3 id="核心概念">核心概念</h3>
<p><strong>资源拥有者（Resource Owner）</strong>：拥有数据的用户。</p>
<p><strong>客户端（Client）</strong>：请求访问用户数据的应用程序。</p>
<p><strong>授权服务器（Authorization Server）</strong>：在验证用户后发放访问令牌（例如 Auth0、Okta、AWS Cognito）。</p>
<p><strong>资源服务器（Resource Server）</strong>：托管受保护资源的 API（例如你的后端 API）。</p>
<p><strong>访问令牌（Access Token）</strong>：授予资源访问权限的短期凭证。</p>
<p><strong>刷新令牌（Refresh Token）</strong>：用于获取新访问令牌的长期凭证。</p>
<p><strong>范围（Scope）</strong>：定义客户端可以访问哪些资源（例如 <code>read:profile</code>、<code>write:posts</code>）。</p>
<h3 id="OAuth-2-0-流程类型">OAuth 2.0 流程类型</h3>
<p><strong>授权码流程（Authorization Code Flow）</strong>：网页应用程序最安全的方式。用户验证、接收授权码、交换授权码以获取令牌。</p>
<p><strong>授权码流程搭配 PKCE（Authorization Code Flow with PKCE）</strong>：移动设备和单页应用程序的增强安全性。防止授权码拦截。</p>
<p><strong>隐式流程（Implicit Flow）</strong>：已弃用。令牌直接在 URL 片段中返回。容易发生令牌泄漏。</p>
<p><strong>客户端凭证流程（Client Credentials Flow）</strong>：用于机器对机器通信。不涉及用户。</p>
<p><strong>资源拥有者密码凭证流程（Resource Owner Password Credentials Flow）</strong>：已弃用。客户端直接收集用户名/密码。除非绝对必要，否则避免使用。</p>
<div class="admonition warning"><p class="admonition-title"><span class="mdi mdi-alert-outline admonition-icon"></span>⚠️ 绝不使用隐式流程</p><div class="admonition-content"><p>隐式流程在 URL 片段中返回令牌，可能被记录、缓存或通过 Referer 标头泄漏。永远使用授权码流程搭配 PKCE。</p>
</div></div>
<h2 id="设计阶段的-OAuth-安全策略">设计阶段的 OAuth 安全策略</h2>
<p>安全的 OAuth 需要在实现前进行规划、标准化和架构决策。</p>
<h3 id="选择正确的流程">选择正确的流程</h3>
<p><strong>网页应用程序（服务器端）</strong>：授权码流程</p>
<pre class="language-none"><code class="language-none">用户 → 登录 → 授权服务器 → 授权码 → 后端
后端 → 交换授权码获取令牌 → 授权服务器 → 访问令牌 + 刷新令牌
后端 → 安全存储令牌 → 数据库（加密）</code></pre>
<p><strong>单页应用程序（SPA）</strong>：授权码流程搭配 PKCE</p>
<pre class="language-none"><code class="language-none">用户 → 登录 → 授权服务器 → 授权码
SPA → 交换授权码 + 代码验证器 → 授权服务器 → 访问令牌
SPA → 将令牌存储在内存中（不是 localStorage）</code></pre>
<p><strong>移动应用程序</strong>：授权码流程搭配 PKCE</p>
<pre class="language-none"><code class="language-none">用户 → 登录 → 授权服务器 → 授权码
应用程序 → 交换授权码 + 代码验证器 → 授权服务器 → 访问令牌 + 刷新令牌
应用程序 → 将刷新令牌存储在安全存储中（Keychain/Keystore）</code></pre>
<p><strong>后端服务（无用户）</strong>：客户端凭证流程</p>
<pre class="language-none"><code class="language-none">服务 → 使用客户端 ID + 密钥请求令牌 → 授权服务器 → 访问令牌
服务 → 使用令牌进行 API 调用 → 资源服务器</code></pre>
<h3 id="实现-PKCE（代码交换证明密钥）">实现 PKCE（代码交换证明密钥）</h3>
<p>PKCE 防止授权码拦截攻击。移动设备和 SPA 应用程序必须使用。</p>
<p><strong>PKCE 运作方式</strong>：</p>
<ol>
<li>客户端生成随机 <code>code_verifier</code>（43-128 个字符）</li>
<li>客户端创建 <code>code_challenge</code> = BASE64URL(SHA256(code_verifier))</li>
<li>客户端在授权请求中发送 <code>code_challenge</code></li>
<li>授权服务器存储 <code>code_challenge</code></li>
<li>客户端交换授权码 + <code>code_verifier</code> 以获取令牌</li>
<li>授权服务器验证 SHA256(code_verifier) 符合存储的 <code>code_challenge</code></li>
</ol>
<p><strong>为什么 PKCE 重要</strong>：即使攻击者拦截授权码，没有 <code>code_verifier</code> 也无法交换令牌。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 生成 PKCE 参数</span>
<span class="token keyword">function</span> <span class="token function">generatePKCE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> codeVerifier <span class="token operator">=</span> <span class="token function">generateRandomString</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> codeChallenge <span class="token operator">=</span> <span class="token function">base64URLEncode</span><span class="token punctuation">(</span><span class="token function">sha256</span><span class="token punctuation">(</span>codeVerifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    codeVerifier<span class="token punctuation">,</span>
    codeChallenge<span class="token punctuation">,</span>
    <span class="token literal-property property">codeChallengeMethod</span><span class="token operator">:</span> <span class="token string">'S256'</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 授权请求</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> codeVerifier<span class="token punctuation">,</span> codeChallenge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generatePKCE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'code_verifier'</span><span class="token punctuation">,</span> codeVerifier<span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://auth.neo01.com/authorize?
  client_id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>clientId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;
  redirect_uri=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>redirectUri<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;
  response_type=code&amp;
  scope=openid profile email&amp;
  code_challenge=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>codeChallenge<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;
  code_challenge_method=S256&amp;
  state=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// 令牌交换</span>
<span class="token keyword">const</span> codeVerifier <span class="token operator">=</span> sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'code_verifier'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://auth.neo01.com/token'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">grant_type</span><span class="token operator">:</span> <span class="token string">'authorization_code'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">code</span><span class="token operator">:</span> authorizationCode<span class="token punctuation">,</span>
    <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> redirectUri<span class="token punctuation">,</span>
    <span class="token literal-property property">client_id</span><span class="token operator">:</span> clientId<span class="token punctuation">,</span>
    <span class="token literal-property property">code_verifier</span><span class="token operator">:</span> codeVerifier
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="验证状态参数">验证状态参数</h3>
<p><code>state</code> 参数防止 OAuth 流程中的 CSRF 攻击。</p>
<p><strong>状态验证运作方式</strong>：</p>
<ol>
<li>客户端在授权请求前生成随机 <code>state</code> 值</li>
<li>客户端将 <code>state</code> 存储在 session 中</li>
<li>客户端在授权请求中包含 <code>state</code></li>
<li>授权服务器与授权码一起返回 <code>state</code></li>
<li>客户端验证返回的 <code>state</code> 符合存储的值</li>
</ol>
<p><strong>为什么状态重要</strong>：防止攻击者诱骗用户授权恶意应用程序。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 生成并存储状态</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">generateRandomString</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'oauth_state'</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 授权请求包含状态</span>
window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://auth.neo01.com/authorize?
  client_id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>clientId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;
  redirect_uri=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>redirectUri<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;
  response_type=code&amp;
  scope=openid profile email&amp;
  state=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// 在回调中验证状态</span>
<span class="token keyword">const</span> returnedState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'state'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> storedState <span class="token operator">=</span> sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'oauth_state'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>returnedState <span class="token operator">!==</span> storedState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'State validation failed - possible CSRF attack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

sessionStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'oauth_state'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="定义范围策略">定义范围策略</h3>
<p>范围限制令牌可以访问的资源。遵循最小权限原则。</p>
<p><strong>范围命名惯例</strong>：</p>
<pre class="language-none"><code class="language-none">read:profile     - 读取用户个人资料
write:profile    - 更新用户个人资料
read:posts       - 读取用户帖子
write:posts      - 创建/更新帖子
delete:posts     - 删除帖子
admin:users      - 管理所有用户（仅限管理员）</code></pre>
<p><strong>范围设计原则</strong>：</p>
<ul>
<li><strong>细粒度</strong>：分离读取和写入权限</li>
<li><strong>基于资源</strong>：每种资源类型的范围（个人资料、帖子、评论）</li>
<li><strong>层次式</strong>：<code>admin:*</code> 意味着所有权限</li>
<li><strong>最小化</strong>：仅请求当前操作所需的范围</li>
</ul>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 不好：预先请求所有范围</span>
<span class="token keyword">const</span> scopes <span class="token operator">=</span> <span class="token string">'read:profile write:profile read:posts write:posts delete:posts admin:users'</span><span class="token punctuation">;</span>

<span class="token comment">// 好：请求最小范围，需要时再请求更多</span>
<span class="token keyword">const</span> scopes <span class="token operator">=</span> <span class="token string">'read:profile read:posts'</span><span class="token punctuation">;</span>

<span class="token comment">// 稍后，当用户想创建帖子时</span>
<span class="token keyword">const</span> additionalScopes <span class="token operator">=</span> <span class="token string">'write:posts'</span><span class="token punctuation">;</span></code></pre>
<h3 id="令牌存储策略">令牌存储策略</h3>
<p>你存储令牌的位置决定了安全性。</p>
<p><strong>网页应用程序（服务器端）</strong>：</p>
<ul>
<li><strong>访问令牌</strong>：服务器端 session 或加密数据库</li>
<li><strong>刷新令牌</strong>：加密数据库，绝不发送到浏览器</li>
<li><strong>绝不</strong>：localStorage、sessionStorage、JavaScript 可访问的 cookies</li>
</ul>
<p><strong>单页应用程序</strong>：</p>
<ul>
<li><strong>访问令牌</strong>：仅内存（JavaScript 变量）</li>
<li><strong>刷新令牌</strong>：不建议用于 SPA；使用短期访问令牌搭配静默刷新</li>
<li><strong>绝不</strong>：localStorage（容易受 XSS 攻击）、sessionStorage（容易受 XSS 攻击）</li>
</ul>
<p><strong>移动应用程序</strong>：</p>
<ul>
<li><strong>访问令牌</strong>：仅内存</li>
<li><strong>刷新令牌</strong>：安全存储（iOS Keychain、Android Keystore）</li>
<li><strong>绝不</strong>：共享偏好设置、UserDefaults、纯文本文件</li>
</ul>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 不好：将令牌存储在 localStorage（容易受 XSS 攻击）</span>
localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'access_token'</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 好：仅存储在内存中</span>
<span class="token keyword">let</span> accessToken <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">setAccessToken</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  accessToken <span class="token operator">=</span> token<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> accessToken<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 登出或页面卸载时清除</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeunload'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  accessToken <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="令牌生命周期策略">令牌生命周期策略</h3>
<p>平衡安全性和用户体验。</p>
<p><strong>访问令牌</strong>：</p>
<ul>
<li><strong>生命周期</strong>：15 分钟到 1 小时</li>
<li><strong>为什么短</strong>：限制令牌被泄露时的损害</li>
<li><strong>刷新</strong>：使用刷新令牌获取新的访问令牌</li>
</ul>
<p><strong>刷新令牌</strong>：</p>
<ul>
<li><strong>生命周期</strong>：7-90 天（或直到撤销）</li>
<li><strong>为什么长</strong>：避免频繁强制用户重新验证</li>
<li><strong>轮换</strong>：每次使用时发放新的刷新令牌，撤销旧的</li>
</ul>
<p><strong>ID 令牌</strong>（OpenID Connect）：</p>
<ul>
<li><strong>生命周期</strong>：5-15 分钟</li>
<li><strong>目的</strong>：用户认证，不是授权</li>
<li><strong>验证</strong>：验证签名、发行者、受众、过期时间</li>
</ul>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"access_token_lifetime"</span><span class="token operator">:</span> <span class="token number">900</span><span class="token punctuation">,</span>
  <span class="token property">"refresh_token_lifetime"</span><span class="token operator">:</span> <span class="token number">2592000</span><span class="token punctuation">,</span>
  <span class="token property">"id_token_lifetime"</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
  <span class="token property">"refresh_token_rotation"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"refresh_token_reuse_detection"</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="刷新令牌轮换">刷新令牌轮换</h3>
<p>刷新令牌轮换防止令牌重放攻击。</p>
<p><strong>轮换运作方式</strong>：</p>
<ol>
<li>客户端使用刷新令牌请求新的访问令牌</li>
<li>授权服务器发放新的访问令牌 + 新的刷新令牌</li>
<li>授权服务器撤销旧的刷新令牌</li>
<li>如果旧的刷新令牌再次被使用，撤销整个令牌家族（表示泄露）</li>
</ol>
<p><strong>为什么轮换重要</strong>：如果刷新令牌被窃取，只能使用一次。后续使用会触发所有令牌的撤销。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 带轮换的令牌刷新</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">refreshAccessToken</span><span class="token punctuation">(</span><span class="token parameter">refreshToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://auth.neo01.com/token'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">grant_type</span><span class="token operator">:</span> <span class="token string">'refresh_token'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">refresh_token</span><span class="token operator">:</span> refreshToken<span class="token punctuation">,</span>
      <span class="token literal-property property">client_id</span><span class="token operator">:</span> clientId
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 存储新令牌</span>
  <span class="token function">setAccessToken</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>access_token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> secureStorage<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'refresh_token'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>refresh_token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 旧的刷新令牌现在无效</span>
  <span class="token keyword">return</span> data<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="常见的-OAuth-2-0-漏洞">常见的 OAuth 2.0 漏洞</h2>
<h3 id="授权码拦截">授权码拦截</h3>
<p><strong>攻击</strong>：攻击者拦截授权码并交换令牌。</p>
<p><strong>预防</strong>：使用 PKCE。即使授权码被拦截，没有 code_verifier 攻击者也无法交换令牌。</p>
<h3 id="URL-中的令牌泄漏">URL 中的令牌泄漏</h3>
<p><strong>攻击</strong>：URL 参数中的令牌被记录、缓存或通过 Referer 标头泄漏。</p>
<p><strong>预防</strong>：绝不使用隐式流程。使用授权码流程，通过 POST 请求交换令牌。</p>
<h3 id="跨站脚本攻击（XSS）">跨站脚本攻击（XSS）</h3>
<p><strong>攻击</strong>：攻击者注入 JavaScript 从 localStorage 或 cookies 窃取令牌。</p>
<p><strong>预防</strong>：仅将令牌存储在内存中（SPA）或服务器端（网页应用程序）。使用内容安全策略（CSP）。</p>
<h3 id="跨站请求伪造（CSRF）">跨站请求伪造（CSRF）</h3>
<p><strong>攻击</strong>：攻击者诱骗用户授权恶意应用程序。</p>
<p><strong>预防</strong>：验证 <code>state</code> 参数。确保状态是随机的、不可预测的，并与用户 session 绑定。</p>
<h3 id="刷新令牌窃取">刷新令牌窃取</h3>
<p><strong>攻击</strong>：攻击者窃取刷新令牌并获取无限的访问令牌。</p>
<p><strong>预防</strong>：实现刷新令牌轮换。检测重复使用并撤销令牌家族。</p>
<h3 id="开放重定向">开放重定向</h3>
<p><strong>攻击</strong>：攻击者操纵 <code>redirect_uri</code> 以窃取授权码。</p>
<p><strong>预防</strong>：在授权服务器中将确切的重定向 URI 加入白名单。绝不允许通配符或部分匹配。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 不好：允许任何 redirect_uri</span>
<span class="token keyword">const</span> redirectUri <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>redirect_uri<span class="token punctuation">;</span> <span class="token comment">// 攻击者控制这个</span>

<span class="token comment">// 好：将确切的 URI 加入白名单</span>
<span class="token keyword">const</span> allowedRedirectUris <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'https://app.neo01.com/callback'</span><span class="token punctuation">,</span>
  <span class="token string">'https://app.neo01.com/auth/callback'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowedRedirectUris<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>redirectUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid redirect_uri'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="OAuth-2-0-实现检查清单">OAuth 2.0 实现检查清单</h2>
<p><strong>授权流程</strong>：</p>
<ul>
<li>✅ 使用授权码流程（不是隐式流程）</li>
<li>✅ 为移动设备和 SPA 应用程序实现 PKCE</li>
<li>✅ 验证 <code>state</code> 参数以防止 CSRF</li>
<li>✅ 将确切的重定向 URI 加入白名单（无通配符）</li>
</ul>
<p><strong>令牌管理</strong>：</p>
<ul>
<li>✅ 访问令牌在 15-60 分钟后过期</li>
<li>✅ 刷新令牌在 7-90 天后过期</li>
<li>✅ 实现刷新令牌轮换</li>
<li>✅ 检测并撤销重复使用的刷新令牌</li>
</ul>
<p><strong>令牌存储</strong>：</p>
<ul>
<li>✅ 将访问令牌存储在内存中（SPA）或服务器端（网页应用程序）</li>
<li>✅ 将刷新令牌存储在安全存储中（移动设备）或服务器端（网页应用程序）</li>
<li>✅ 绝不将令牌存储在 localStorage 或 sessionStorage</li>
</ul>
<p><strong>范围管理</strong>：</p>
<ul>
<li>✅ 请求所需的最小范围</li>
<li>✅ 在资源服务器上验证范围</li>
<li>✅ 使用细粒度、基于资源的范围</li>
</ul>
<p><strong>安全标头</strong>：</p>
<ul>
<li>✅ 实现内容安全策略（CSP）</li>
<li>✅ 所有 OAuth 端点使用 HTTPS</li>
<li>✅ 在 cookies 上设置 Secure 和 HttpOnly 标志</li>
</ul>
<p><strong>监控</strong>：</p>
<ul>
<li>✅ 记录认证事件（登录、登出、令牌刷新）</li>
<li>✅ 对可疑模式发出警报（多次登录失败、令牌重复使用）</li>
<li>✅ 监控令牌使用和过期</li>
</ul>
<h2 id="OAuth-2-0-vs-OpenID-Connect">OAuth 2.0 vs OpenID Connect</h2>
<p><strong>OAuth 2.0</strong>：授权框架。回答"这个应用程序可以访问什么？"</p>
<p><strong>OpenID Connect</strong>：OAuth 2.0 之上的认证层。回答"这个用户是谁？"</p>
<p><strong>何时使用 OAuth 2.0</strong>：授予资源访问权限（API、数据）。</p>
<p><strong>何时使用 OpenID Connect</strong>：用户认证和身份确认。</p>
<p><strong>关键差异</strong>：OpenID Connect 新增包含用户身份信息的 ID 令牌（JWT）。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// OAuth 2.0：仅访问令牌</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">"access_token"</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."</span><span class="token punctuation">,</span>
  <span class="token string-property property">"token_type"</span><span class="token operator">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"expires_in"</span><span class="token operator">:</span> <span class="token number">3600</span><span class="token punctuation">,</span>
  <span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token string">"read:profile read:posts"</span>
<span class="token punctuation">}</span>

<span class="token comment">// OpenID Connect：访问令牌 + ID 令牌</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">"access_token"</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."</span><span class="token punctuation">,</span>
  <span class="token string-property property">"id_token"</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."</span><span class="token punctuation">,</span>
  <span class="token string-property property">"token_type"</span><span class="token operator">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"expires_in"</span><span class="token operator">:</span> <span class="token number">3600</span><span class="token punctuation">,</span>
  <span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token string">"openid profile email"</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="OAuth-2-0-安全最佳实践">OAuth 2.0 安全最佳实践</h2>
<h3 id="全面使用-HTTPS">全面使用 HTTPS</h3>
<p>所有 OAuth 端点都必须使用 HTTPS。通过 HTTP 传输的令牌可能被拦截。</p>
<h3 id="验证-JWT-签名">验证 JWT 签名</h3>
<p>如果使用 JWT 作为访问令牌，务必验证签名、发行者、受众和过期时间。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">validateAccessToken</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> decoded <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> publicKey<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">issuer</span><span class="token operator">:</span> <span class="token string">'https://auth.neo01.com'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">audience</span><span class="token operator">:</span> <span class="token string">'https://api.neo01.com'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> decoded<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="实现速率限制">实现速率限制</h3>
<p>防止对令牌端点的暴力攻击。</p>
<pre class="language-none"><code class="language-none">POST /token: 每个 IP 每分钟 5 次请求
POST /authorize: 每个用户每分钟 10 次请求</code></pre>
<h3 id="登出时撤销令牌">登出时撤销令牌</h3>
<p>当用户登出时，撤销所有令牌（访问和刷新）。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token parameter">userId<span class="token punctuation">,</span> refreshToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 撤销刷新令牌</span>
  <span class="token keyword">await</span> <span class="token function">revokeRefreshToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 撤销用户的所有活动 session</span>
  <span class="token keyword">await</span> <span class="token function">revokeAllUserSessions</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 清除客户端令牌</span>
  <span class="token function">setAccessToken</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> secureStorage<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'refresh_token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="监控令牌使用">监控令牌使用</h3>
<p>记录并监控与令牌相关的事件以进行安全分析。</p>
<pre class="language-none"><code class="language-none">INFO [SECURITY.AUTH]: 用户登录成功 | user_id={id} ip={ip}
WARNING [SECURITY.AUTH]: 令牌刷新失败 | user_id={id} reason={expired}
ALERT [SECURITY.AUTH]: 检测到刷新令牌重复使用 | user_id={id} token_id={id}
CRITICAL [SECURITY.AUTH]: 触发令牌撤销 | user_id={id} reason={reuse_detected}</code></pre>
<h2 id="做出选择">做出选择</h2>
<p>OAuth 2.0 安全不是选项——它是必要的。问题在于你是从一开始就正确设计，还是在安全事件后才进行改造。</p>
<p>从正确的流程开始：现代应用程序使用授权码搭配 PKCE。实现状态验证、刷新令牌轮换和安全存储。定义最小范围和短令牌生命周期。</p>
<p>记住：OAuth 2.0 是你应用程序的授权框架。正确实现时，它保护用户并防止未授权访问。实现不当时，它成为你安全性中最薄弱的环节。</p>
<p>从一开始就正确设计 OAuth 安全。你的用户——以及你的安全团队——会感谢你。</p>

        </div>
        <footer class="article-footer">
            
    <a data-url="https://neo01.com/zh-CN/2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation/" data-id="6b322646" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url').replace("http://","https://"),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    <!--script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
            "@type": "Person",
            "name": "Neo Alienson"
        },
        "headline": "OAuth 2.0 安全最佳实践 - 从设计到实现",
        "image": "https://neo01.com",
        "keywords": "Authentication Best Practices Security",
        "genre": "Cybersecurity",
        "datePublished": "2020-12-25",
        "dateCreated": "2020-12-25",
        "dateModified": "2025-10-23",
        "url": "https://neo01.com//zh-CN/2020/12/OAuth-2.0-Security-Best-Practices-From-Design-to-Implementation/",
        "description": "OAuth 2.0 不只是获取访问令牌。学习如何设计安全的授权流程，在攻击者利用漏洞之前，保护用户数据并防止常见漏洞。",
        "wordCount": 1931
    }
</script-->

</article>

                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
                <li>
                    <a class="social-tooltip" title="stack-exchange" href="https://stackexchange.com/users/2122053/neo?tab=accounts" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-stack-exchange"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="stack-overflow" href="https://stackoverflow.com/users/1885105/neo" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-stack-overflow"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/neoalienson" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-github"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="linkedin" href="https://linkedin.com/in/neo01" target="_blank" rel="noopener">
                        <i class="icon fa-brands fa-linkedin"></i>
                    </a>
                </li>
                <li>
                    <a class="social-tooltip" title="rss" href="/atom.xml" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
        </ul>
    </div>
    <div class="widgets-container">
        
            
                <div class="widget-wrap widget-list">
    <h3 class="widget-title">链接</h3>
    <div class="widget">
        <ul><li><a href="/zh-CN/ai">AI 游乐场</a></li><li><a href="/zh-CN/tools">工具</a></li><li><a href="/zh-CN/games">游戏</a></li><li><a href="/zh-CN/pages/useful-information">实用信息</a></li><li><a href="/zh-CN/pages/Hexo-Blogging-Cheatsheet">Hexo 博客速查表</a></li></ul>
    </div>
</div>

            
                
            
                    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-CN/2025/10/CISP-Advanced-Security-Topics/" class="thumbnail">
        <span style="background-image:url(/assets/cisp/thumbnail_80.png)" alt="CISP学习指南：高级安全主题" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-CN/categories/Cybersecurity/">网络安全</a></p>
                            <p class="item-title"><a href="/zh-CN/2025/10/CISP-Advanced-Security-Topics/" class="title">CISP学习指南：高级安全主题</a></p>
                            <p class="item-date"><time datetime="2025-10-22T16:00:00.000Z" itemprop="datePublished">2025-10-23</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-CN/2025/10/CISP-Email-Security/" class="thumbnail">
        <span style="background-image:url(/assets/cisp/thumbnail_80.png)" alt="CISP学习指南：电子邮件安全与网络协议" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-CN/categories/Cybersecurity/">网络安全</a></p>
                            <p class="item-title"><a href="/zh-CN/2025/10/CISP-Email-Security/" class="title">CISP学习指南：电子邮件安全与网络协议</a></p>
                            <p class="item-date"><time datetime="2025-10-22T16:00:00.000Z" itemprop="datePublished">2025-10-23</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-CN/2025/10/CISP-Access-Control-Audit-WAPI/" class="thumbnail">
        <span style="background-image:url(/assets/cisp/thumbnail_80.png)" alt="CISP学习指南：访问控制机制、蜜网、审计系统与WAPI" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-CN/categories/Cybersecurity/">网络安全</a></p>
                            <p class="item-title"><a href="/zh-CN/2025/10/CISP-Access-Control-Audit-WAPI/" class="title">CISP学习指南：访问控制机制、蜜网、审计系统与WAPI</a></p>
                            <p class="item-date"><time datetime="2025-10-21T16:00:00.000Z" itemprop="datePublished">2025-10-22</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-CN/2025/10/CISP-China-Information-Security-Laws/" class="thumbnail">
        <span style="background-image:url(/assets/cisp/thumbnail_80.png)" alt="CISP学习指南：中国信息安全法律法规体系" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-CN/categories/Cybersecurity/">网络安全</a></p>
                            <p class="item-title"><a href="/zh-CN/2025/10/CISP-China-Information-Security-Laws/" class="title">CISP学习指南：中国信息安全法律法规体系</a></p>
                            <p class="item-date"><time datetime="2025-10-21T16:00:00.000Z" itemprop="datePublished">2025-10-22</time></p>
                        </div>
                    </li>
                    <li>
                        <div class="item-thumbnail">
                            <a href="/zh-CN/2025/10/CISP-Firewall-IDS-Technologies/" class="thumbnail">
        <span style="background-image:url(/assets/cisp/thumbnail_80.png)" alt="CISP学习指南：防火墙与入侵检测技术" class="thumbnail-image"></span>
</a>
                        </div>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/zh-CN/categories/Cybersecurity/">网络安全</a></p>
                            <p class="item-title"><a href="/zh-CN/2025/10/CISP-Firewall-IDS-Technologies/" class="title">CISP学习指南：防火墙与入侵检测技术</a></p>
                            <p class="item-date"><time datetime="2025-10-21T16:00:00.000Z" itemprop="datePublished">2025-10-22</time></p>
                        </div>
                    </li>
            </ul>
        </div>
    </div>

            
                
    
    
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list">
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2025/">2025</a>
                    <span class="archive-list-count">72</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2024/">2024</a>
                    <span class="archive-list-count">25</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2023/">2023</a>
                    <span class="archive-list-count">15</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2022/">2022</a>
                    <span class="archive-list-count">10</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2021/">2021</a>
                    <span class="archive-list-count">12</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2020/">2020</a>
                    <span class="archive-list-count">13</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2019/">2019</a>
                    <span class="archive-list-count">12</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2018/">2018</a>
                    <span class="archive-list-count">2</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2017/">2017</a>
                    <span class="archive-list-count">5</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2016/">2016</a>
                    <span class="archive-list-count">4</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2015/">2015</a>
                    <span class="archive-list-count">6</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2014/">2014</a>
                    <span class="archive-list-count">7</span>
                </li>
            
                <li class="archive-list-item">
                    <a class="archive-list-link" href="/zh-CN/archives/2013/">2013</a>
                    <span class="archive-list-count">2</span>
                </li>
            
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <!-- disable caching cause each page has different footer from qrcode -->
        <!-- common/footer, null, {cache: !config.relative_link})  -->
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="qrcode-share-wrapper">
                <div class="qrcode-text">https://neo01.com/l#7f59755b</div>
                <img src="/qr/qr-93d5659323c9fe685eddf13d5da54127.svg" width="200" height="200" alt="QR Code for https://neo01.com/l#7f59755b">
            </div>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" title="Homepage" class="logo"></a>
                </h1>
                
                <p>© 2025 Neo Alienson. 版权所有.
                  <a href="/zh-CN/terms-and-conditions">使用条款</a></p>
                
            </div>
            <div class="footer-plugins">
              


            </div>
        </div>
    </div>
</footer>

        
    
        


        


        


        


        


        


        


        


        


    



<!-- Custom Scripts -->




    </div>
<!-- hexo injector body_end start --><script type="text/javascript" src="/js/bundle_last.js"></script><!-- hexo injector body_end end -->

</body></html>